é¡¹ç›®è·¯å¾„: e:\Codes\Python\Python_Vscode\Company-Management-System
æ’é™¤çš„æ–‡ä»¶å¤¹: ['node_modules', '.git', '.vscode', 'dist', '__pycache__', 'venv', 'output', 'data', 'env', 'Lib']
----------------------------------------

Company-Management-System/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.py
â”‚   â”‚   â”‚   â”œâ”€â”€ dashboard.py
â”‚   â”‚   â”‚   â”œâ”€â”€ notifications.py
â”‚   â”‚   â”‚   â”œâ”€â”€ orders.py
â”‚   â”‚   â”‚   â”œâ”€â”€ reports.py
â”‚   â”‚   â”‚   â””â”€â”€ users.py
â”‚   â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”‚   â”œâ”€â”€ commission.py
â”‚   â”‚   â”‚   â”œâ”€â”€ notification.py
â”‚   â”‚   â”‚   â”œâ”€â”€ order.py
â”‚   â”‚   â”‚   â””â”€â”€ user.py
â”‚   â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”‚   â”œâ”€â”€ commission_schemas.py
â”‚   â”‚   â”‚   â”œâ”€â”€ notification_schemas.py
â”‚   â”‚   â”‚   â”œâ”€â”€ order_schemas.py
â”‚   â”‚   â”‚   â”œâ”€â”€ user_schemas.py
â”‚   â”‚   â”‚   â””â”€â”€ work_log_schemas.py
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”œâ”€â”€ commission_service.py
â”‚   â”‚   â”‚   â”œâ”€â”€ dashboard_service.py
â”‚   â”‚   â”‚   â”œâ”€â”€ notification_service.py
â”‚   â”‚   â”‚   â”œâ”€â”€ order_service.py
â”‚   â”‚   â”‚   â”œâ”€â”€ report_service.py
â”‚   â”‚   â”‚   â”œâ”€â”€ user_service.py
â”‚   â”‚   â”‚   â””â”€â”€ work_log_service.py
â”‚   â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”‚   â””â”€â”€ decorators.py
â”‚   â”‚   â””â”€â”€ __init__.py
â”‚   â”œâ”€â”€ migrations/
â”‚   â”‚   â”œâ”€â”€ versions/
â”‚   â”‚   â”‚   â”œâ”€â”€ 10e42f6ae8cc_align_models_with_spec_and_add_.py
â”‚   â”‚   â”‚   â”œâ”€â”€ 1855c37dd305_add_orders_and_work_logs_tables.py
â”‚   â”‚   â”‚   â””â”€â”€ ea16599a186c_initial_migration_with_user_table.py
â”‚   â”‚   â”œâ”€â”€ README
â”‚   â”‚   â”œâ”€â”€ alembic.ini
â”‚   â”‚   â”œâ”€â”€ env.py
â”‚   â”‚   â””â”€â”€ script.py.mako
â”‚   â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ Dockerfile.bak
â”‚   â”œâ”€â”€ config.py
â”‚   â”œâ”€â”€ manage.py
â”‚   â””â”€â”€ requirements.txt
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ public/
â”‚   â”‚   â””â”€â”€ favicon.ico
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ assets/
â”‚   â”‚   â”‚   â”œâ”€â”€ base.css
â”‚   â”‚   â”‚   â”œâ”€â”€ logo.svg
â”‚   â”‚   â”‚   â””â”€â”€ main.css
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ admin/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ UserForm.vue
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ UserTable.vue
â”‚   â”‚   â”‚   â”œâ”€â”€ orders/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AddWorkLogForm.vue
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CommissionInfoCard.vue
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ FinanceSummaryCard.vue
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ OrderActionPanel.vue
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ OrderInfoCard.vue
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ WorkLogTimeline.vue
â”‚   â”‚   â”‚   â””â”€â”€ NotificationCenter.vue
â”‚   â”‚   â”œâ”€â”€ composables/
â”‚   â”‚   â”‚   â””â”€â”€ useOrderActions.ts
â”‚   â”‚   â”œâ”€â”€ layouts/
â”‚   â”‚   â”‚   â””â”€â”€ MainLayout.vue
â”‚   â”‚   â”œâ”€â”€ router/
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”œâ”€â”€ api.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ dashboardService.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ notificationService.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ orderService.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ reportService.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ types.ts
â”‚   â”‚   â”‚   â””â”€â”€ userService.ts
â”‚   â”‚   â”œâ”€â”€ stores/
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ counter.ts
â”‚   â”‚   â”‚   â””â”€â”€ notifications.ts
â”‚   â”‚   â”œâ”€â”€ views/
â”‚   â”‚   â”‚   â”œâ”€â”€ admin/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ UserManagementView.vue
â”‚   â”‚   â”‚   â”œâ”€â”€ finance/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ FinanceReportView.vue
â”‚   â”‚   â”‚   â”œâ”€â”€ orders/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CreateOrderView.vue
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ OrderDetailView.vue
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ OrderListView.vue
â”‚   â”‚   â”‚   â”œâ”€â”€ HomeView.vue
â”‚   â”‚   â”‚   â””â”€â”€ LoginView.vue
â”‚   â”‚   â”œâ”€â”€ App.vue
â”‚   â”‚   â””â”€â”€ main.ts
â”‚   â”œâ”€â”€ .editorconfig
â”‚   â”œâ”€â”€ .gitattributes
â”‚   â”œâ”€â”€ .gitignore
â”‚   â”œâ”€â”€ .prettierrc.json
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ README.md
â”‚   â”œâ”€â”€ env.d.ts
â”‚   â”œâ”€â”€ eslint.config.ts
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ nginx.conf
â”‚   â”œâ”€â”€ package-lock.json
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ tsconfig.app.json
â”‚   â”œâ”€â”€ tsconfig.json
â”‚   â”œâ”€â”€ tsconfig.node.json
â”‚   â””â”€â”€ vite.config.ts
â”œâ”€â”€ .env
â”œâ”€â”€ Company-Management-System_structure_and_content.txt
â”œâ”€â”€ PrintPathTxt.py
â””â”€â”€ docker-compose.yml.bak


---
åˆ†æå®Œæ¯•ï¼Œå…±æ‰¾åˆ° 90 ä¸ªæ–‡ä»¶ã€‚
---

--- æ–‡ä»¶å†…å®¹è¯¦æƒ… ---


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: .env
========================================

# Flask App Configuration
SECRET_KEY=a_very_secret_random_string_for_your_app
JWT_SECRET_KEY=another_very_secret_random_string_for_jwt

# Database Configuration
MYSQL_DATABASE=internal_system_db
MYSQL_USER=admin
MYSQL_PASSWORD=admin123
MYSQL_ROOT_PASSWORD=123456
MYSQL_HOST=localhost # ä¿®æ”¹ä¸ºæœ¬åœ°æ•°æ®åº“åœ°å€

===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: Company-Management-System_structure_and_content.txt
========================================



===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\config.py
========================================

import os
from dotenv import load_dotenv
from datetime import timedelta # <-- 1. å¯¼å…¥ timedelta

# ç›´æ¥åŠ è½½ .env æ–‡ä»¶ï¼Œpython-dotenv ä¼šè‡ªåŠ¨åœ¨å·¥ä½œç›®å½•ä¸­å¯»æ‰¾
load_dotenv()

class Config:
    SECRET_KEY = os.environ.get('SECRET_KEY')
    JWT_SECRET_KEY = os.environ.get('JWT_SECRET_KEY')

# 2. æ–°å¢ä¸‹é¢è¿™è¡Œï¼Œå°† Access Token çš„æœ‰æ•ˆæœŸè®¾ç½®ä¸º 1 å°æ—¶
    JWT_ACCESS_TOKEN_EXPIRES = timedelta(hours=720)

    # SQLAlchemy é…ç½®
    MYSQL_HOST = os.environ.get('MYSQL_HOST')
    MYSQL_USER = os.environ.get('MYSQL_USER')
    MYSQL_PASSWORD = os.environ.get('MYSQL_PASSWORD')
    MYSQL_DB = os.environ.get('MYSQL_DATABASE')
    SQLALCHEMY_DATABASE_URI = f"mysql+pymysql://{MYSQL_USER}:{MYSQL_PASSWORD}@{MYSQL_HOST}/{MYSQL_DB}"
    SQLALCHEMY_TRACK_MODIFICATIONS = False

===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\manage.py
========================================

import click
import bcrypt  # <-- 1. å¯¼å…¥ bcrypt åº“
from flask.cli import with_appcontext
from app import create_app, db
from app.models.user import User, UserRole

# åˆ›å»º Flask app å®ä¾‹ä»¥è·å–åº”ç”¨ä¸Šä¸‹æ–‡
app = create_app()

@app.cli.command("create-admin")
@click.argument("username")
@click.argument("password")
def create_admin(username, password):
    """åˆ›å»ºä¸€ä¸ªæ–°çš„è¶…çº§ç®¡ç†å‘˜è´¦æˆ·"""
    with app.app_context():
        # æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
        if User.query.filter_by(username=username).first():
            print(f"Error: Username '{username}' already exists.")
            return

        # 2. åœ¨æ­¤æ˜¾å¼åœ°å“ˆå¸Œå¯†ç 
        hashed_password = bcrypt.hashpw(
            password.encode('utf-8'), bcrypt.gensalt()
        )

        # 3. åˆ›å»ºç”¨æˆ·å®ä¾‹æ—¶ç›´æ¥ä¼ å…¥å“ˆå¸Œåçš„å¯†ç 
        admin_user = User(
            username=username,
            full_name="Super Admin",
            password_hash=hashed_password.decode('utf-8'), # ä¼ å…¥å“ˆå¸Œå€¼
            role=UserRole.SUPER_ADMIN,
            is_active=True
        )
        
        # admin_user.set_password(password)  <-- 4. è¿™è¡Œæ—§ä»£ç å·²è¢«æ›¿æ¢

        # å­˜å…¥æ•°æ®åº“
        db.session.add(admin_user)
        db.session.commit()
        print(f"Successfully created SUPER_ADMIN user: '{username}'.")

===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\requirements.txt
========================================

Flask==2.3.2
python-dotenv==1.0.0
Flask-SQLAlchemy==3.0.5
Flask-Migrate==4.0.4
Flask-JWT-Extended==4.5.2
Flask-Cors==4.0.0
PyMySQL==1.1.0
bcrypt==4.0.1
gunicorn==20.1.0
pydantic>=2.0.0
pytest==7.4.0
cryptography
openpyxl==3.1.2

===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\app\__init__.py
========================================

from flask import Flask
from flask_sqlalchemy import SQLAlchemy
from flask_migrate import Migrate
from flask_jwt_extended import JWTManager
from flask_cors import CORS  # <-- ç¡®ä¿å¯¼å…¥äº†CORS
from config import Config

db = SQLAlchemy()
migrate = Migrate()
jwt = JWTManager()

def create_app(config_class=Config):
    app = Flask(__name__)
    app.config.from_object(config_class)

    # åˆå§‹åŒ–æ’ä»¶
    db.init_app(app)
    migrate.init_app(app, db)
    jwt.init_app(app)
    
    # --- é—®é¢˜æ‰€åœ¨ä¹‹å¤„ä¸ä¿®æ”¹ ---
    # æ—§çš„CORSé…ç½®:
    # CORS(app, resources={r"/api/*": {"origins": "*"}}) 

    # ä¿®æ”¹åçš„CORSé…ç½®ï¼š
    # æ·»åŠ  expose_headers å‚æ•°ï¼Œå…è®¸å‰ç«¯è®¿é—® Content-Disposition å¤´
    CORS(
        app, 
        resources={r"/api/*": {"origins": "*"}},
        expose_headers=['Content-Disposition']  # <-- æ–°å¢çš„é…ç½®é¡¹
    )

    # æ³¨å†Œè“å›¾ (è¿™éƒ¨åˆ†ä»£ç ä¸å˜)
    from .api.auth import auth_bp
    from .api.users import users_bp
    from .api.orders import orders_bp
    from .api.notifications import notifications_bp
    from .api.dashboard import dashboard_bp
    from .api.reports import reports_bp

    app.register_blueprint(auth_bp, url_prefix='/api/auth')
    app.register_blueprint(users_bp, url_prefix='/api/users')
    app.register_blueprint(orders_bp, url_prefix='/api/orders')
    app.register_blueprint(notifications_bp, url_prefix='/api/notifications')
    app.register_blueprint(dashboard_bp, url_prefix='/api/v1/dashboard')
    app.register_blueprint(reports_bp, url_prefix='/api/v1/reports')

    # å¼•å…¥æ¨¡å‹ (è¿™éƒ¨åˆ†ä»£ç ä¸å˜)
    from .models import user, order, commission, notification

    return app

===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\app\api\auth.py
========================================

from flask import Blueprint, request, jsonify
from ..models.user import User
from flask_jwt_extended import create_access_token
import bcrypt

auth_bp = Blueprint('auth', __name__)

@auth_bp.route('/login', methods=['POST'])
def login():
    data = request.get_json()
    username = data.get('username')
    password = data.get('password')

    if not username or not password:
        return jsonify({"msg": "Missing username or password"}), 400

    user = User.query.filter_by(username=username).first()

    # ç®€åŒ–: æ˜¾å¼åœ°æ£€æŸ¥ç”¨æˆ·å­˜åœ¨å¹¶ä¸”å¯†ç åŒ¹é…
    if user and bcrypt.checkpw(password.encode('utf-8'), user.password_hash.encode('utf-8')):
        if not user.is_active:
            return jsonify({"msg": "User account is disabled"}), 403

        # åˆ›å»ºTokenæ—¶å¯ä»¥é™„å¸¦ä¸€äº›éæ•æ„Ÿä¿¡æ¯
        additional_claims = {"role": user.role.value, "full_name": user.full_name}
        access_token = create_access_token(identity=str(user.id), additional_claims=additional_claims)
        
        return jsonify(access_token=access_token)

    return jsonify({"msg": "Bad username or password"}), 401

===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\app\api\dashboard.py
========================================

# backend/app/api/dashboard.py

from flask import Blueprint, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity, get_jwt
from ..services import dashboard_service
from ..models.user import UserRole
from ..utils.decorators import role_required

dashboard_bp = Blueprint('dashboard', __name__)

@dashboard_bp.route('/personal', methods=['GET'])
@jwt_required()
def get_personal_dashboard():
    """è·å–ä¸ªäººä¸šç»©ä»ªè¡¨ç›˜æ•°æ® (å®¢æœ/æŠ€æœ¯)"""
    current_user_id = int(get_jwt_identity())
    claims = get_jwt()
    user_role = claims.get("role")

    if user_role not in [UserRole.CUSTOMER_SERVICE.value, UserRole.DEVELOPER.value]:
        return jsonify({"msg": "This endpoint is for Customer Service or Developers only"}), 403

    stats = dashboard_service.get_personal_stats(current_user_id, user_role)
    return jsonify(stats), 200

@dashboard_bp.route('/global', methods=['GET'])
@jwt_required()
@role_required(UserRole.SUPER_ADMIN.value)
def get_global_dashboard():
    """è·å–å…¨å±€æ•°æ®çœ‹æ¿ (ä»…é™è¶…ç®¡)"""
    stats = dashboard_service.get_global_stats()
    return jsonify(stats), 200

@dashboard_bp.route('/team-performance', methods=['GET'])
@jwt_required()
@role_required(UserRole.SUPER_ADMIN.value)
def get_team_performance():
    """è·å–å›¢é˜Ÿç»©æ•ˆæ•°æ® (ä»…é™è¶…ç®¡)"""
    stats = dashboard_service.get_team_performance_stats()
    return jsonify(stats), 200


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\app\api\notifications.py
========================================

# backend/app/api/notifications.py (æ–°å»ºæ–‡ä»¶)

from flask import Blueprint, jsonify
from pydantic import ValidationError
from ..services import notification_service
from ..schemas import notification_schemas
from flask_jwt_extended import jwt_required, get_jwt_identity

notifications_bp = Blueprint('notifications', __name__)

@notifications_bp.route('/', methods=['GET'])
@jwt_required()
def get_user_notifications():
    """è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„é€šçŸ¥åˆ—è¡¨"""
    try:
        current_user_id = int(get_jwt_identity())
        notifications = notification_service.get_notifications_for_user(current_user_id)
        
        # ä½¿ç”¨ Pydantic Schema è¿›è¡Œåºåˆ—åŒ–
        notifications_out = [
            notification_schemas.NotificationOut.model_validate(n).model_dump(mode='json') 
            for n in notifications
        ]
        return jsonify(notifications_out), 200
        
    except Exception as e:
        return jsonify({"msg": "An unexpected error occurred", "details": str(e)}), 500


@notifications_bp.route('/<int:notification_id>/read', methods=['POST'])
@jwt_required()
def mark_notification_as_read(notification_id: int):
    """å°†å•æ¡é€šçŸ¥æ ‡è®°ä¸ºå·²è¯»"""
    try:
        current_user_id = int(get_jwt_identity())
        updated_notification = notification_service.mark_notification_as_read(
            notification_id,
            current_user_id
        )
        
        if not updated_notification:
            return jsonify({"msg": "Notification not found or access denied"}), 404
            
        return jsonify(
            notification_schemas.NotificationOut.model_validate(updated_notification).model_dump(mode='json')
        ), 200

    except PermissionError as e:
         return jsonify({"msg": str(e)}), 403
    except Exception as e:
        return jsonify({"msg": "An unexpected error occurred", "details": str(e)}), 500

===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\app\api\orders.py
========================================

# backend/app/api/orders.py

from flask import Blueprint, request, jsonify
from pydantic import ValidationError
from .. import db
from ..models.user import UserRole
# --- ä¿®æ”¹ schemas å¯¼å…¥ ---
from ..schemas import order_schemas, work_log_schemas
from ..utils.decorators import role_required
from flask_jwt_extended import jwt_required, get_jwt_identity, get_jwt

# --- ä¿®æ”¹ services å¯¼å…¥ ---
from ..services import order_service, work_log_service

orders_bp = Blueprint('orders', __name__)

@orders_bp.route('/', methods=['POST'])
@jwt_required()
@role_required(UserRole.CUSTOMER_SERVICE.value)
def create_order():
    """å®¢æœåˆ›å»ºæ–°è®¢å•"""
    try:
        order_data = order_schemas.OrderCreate.model_validate(request.get_json())
        current_user_id = int(get_jwt_identity())

        # --- CHANGED: è°ƒç”¨æœåŠ¡å±‚æ¥å¤„ç†ä¸šåŠ¡é€»è¾‘ ---
        new_order = order_service.create_order(order_data, current_user_id)
        
        db.session.refresh(new_order) # åˆ·æ–°ä»¥åŠ è½½å…³ç³»
        return jsonify(order_schemas.OrderOut.model_validate(new_order).model_dump(mode='json')), 201

    except ValidationError as e:
        return jsonify(e.errors()), 400
    except Exception as e:
        db.session.rollback()
        return jsonify({"msg": "An unexpected error occurred", "details": str(e)}), 500

@orders_bp.route('/', methods=['GET'])
@jwt_required()
def get_orders():
    """è·å–è®¢å•åˆ—è¡¨ï¼ˆæ ¹æ®è§’è‰²åŒºåˆ†ï¼‰"""
    claims = get_jwt()
    user_role = claims.get("role")
    user_id = int(get_jwt_identity())
    
    # --- CHANGED: è°ƒç”¨æœåŠ¡å±‚æ¥è·å–æ•°æ® ---
    orders = order_service.get_orders_for_user(user_id, user_role)

    orders_out = [order_schemas.OrderOut.model_validate(order).model_dump(mode='json') for order in orders]
    return jsonify(orders_out), 200

@orders_bp.route('/<int:order_id>', methods=['GET'])
@jwt_required()
def get_order_details(order_id: int):
    """è·å–å•ä¸ªè®¢å•çš„è¯¦ç»†ä¿¡æ¯"""
    order = order_service.get_order_by_id(order_id)
    if not order:
        return jsonify({"msg": "Order not found"}), 404
    
    # æ­¤å¤„å¯ä»¥åŠ å…¥æƒé™æ ¡éªŒï¼Œç¡®ä¿åªæœ‰ç›¸å…³äººå‘˜èƒ½æŸ¥çœ‹
    
    return jsonify(order_schemas.OrderOut.model_validate(order).model_dump(mode='json')), 200


@orders_bp.route('/<int:order_id>/status', methods=['POST'])
@jwt_required()
def update_order_status_route(order_id: int):
    """
    æ ¸å¿ƒæ¥å£ï¼šé©±åŠ¨è®¢å•ç”Ÿå‘½å‘¨æœŸæµè½¬
    """
    try:
        claims = get_jwt()
        user_role = claims.get("role")
        
        order = order_service.get_order_by_id(order_id)
        if not order:
            return jsonify({"msg": "Order not found"}), 404

        data = order_schemas.OrderStatusUpdate.model_validate(request.get_json())
        
        # è°ƒç”¨æœåŠ¡å±‚å¤„ç†çŠ¶æ€å˜æ›´
        order_service.update_order_status(order, data.status, user_role)

        return jsonify({"message": f"è®¢å•çŠ¶æ€å·²æˆåŠŸæ›´æ–°ä¸º [{data.status.value}]"}), 200

    except ValidationError as e:
        return jsonify(e.errors()), 400
    except (ValueError, PermissionError) as e:
        return jsonify({"msg": str(e)}), 400 # 400 Bad Request for invalid transition
    except Exception as e:
        db.session.rollback()
        return jsonify({"msg": "An unexpected error occurred", "details": str(e)}), 500


@orders_bp.route('/<int:order_id>', methods=['PATCH'])
@jwt_required()
@role_required(UserRole.CUSTOMER_SERVICE.value)
def update_order_details_route(order_id: int):
    """å®¢æœæ›´æ–°è®¢å•ä¿¡æ¯ï¼Œå¦‚ä»·æ ¼ã€åˆ†é…æŠ€æœ¯"""
    try:
        order = order_service.get_order_by_id(order_id)
        if not order:
            return jsonify({"msg": "Order not found"}), 404
        
        update_data = order_schemas.OrderUpdateByCs.model_validate(request.get_json())
        
        # è°ƒç”¨æœåŠ¡å±‚å¤„ç†æ›´æ–°
        updated_order = order_service.update_order_details_by_cs(order, update_data)
        
        return jsonify(order_schemas.OrderOut.model_validate(updated_order).model_dump(mode='json')), 200

    except ValidationError as e:
        return jsonify(e.errors()), 400
    except ValueError as e:
        return jsonify({"msg": str(e)}), 400
    except Exception as e:
        db.session.rollback()
        return jsonify({"msg": "An unexpected error occurred", "details": str(e)}), 500


@orders_bp.route('/<int:order_id>/commission-override', methods=['POST'])
@jwt_required()
@role_required(UserRole.SUPER_ADMIN.value)
def set_commission_override_route(order_id: int):
    """è¶…ç®¡ä¸ºç‰¹å®šè®¢å•è®¾ç½®ç‰¹æ®Šææˆæ¯”ä¾‹"""
    try:
        order = order_service.get_order_by_id(order_id)
        if not order:
            return jsonify({"msg": "Order not found"}), 404
            
        override_data = order_schemas.CommissionOverrideUpdate.model_validate(request.get_json())

        order_service.set_commission_override(order, override_data)
        
        return '', 204 # 204 No Contentè¡¨ç¤ºæˆåŠŸï¼Œæ— éœ€è¿”å›å†…å®¹
        
    except ValidationError as e:
        return jsonify(e.errors()), 400
    except ValueError as e:
        return jsonify({"msg": str(e)}), 400
    except Exception as e:
        db.session.rollback()
        return jsonify({"msg": "An unexpected error occurred", "details": str(e)}), 500
    
    # ---ã€ä»»åŠ¡ 4.1ã€‘æ–°å¢å·¥ä½œæ—¥å¿—æäº¤ API ---
@orders_bp.route('/<int:order_id>/work_logs', methods=['POST'])
@jwt_required()
@role_required(UserRole.DEVELOPER.value)
def add_work_log_route(order_id: int):
    """æŠ€æœ¯äººå‘˜ä¸ºæŒ‡å®šè®¢å•æäº¤å·¥ä½œæ—¥å¿—"""
    try:
        order = order_service.get_order_by_id(order_id)
        if not order:
            return jsonify({"msg": "Order not found"}), 404

        current_user_id = int(get_jwt_identity())
        claims = get_jwt()
        user_role = claims.get("role")

        log_data = work_log_schemas.WorkLogCreate.model_validate(request.get_json())
        
        # è°ƒç”¨æœåŠ¡å±‚å¤„ç†ä¸šåŠ¡é€»è¾‘
        new_log = work_log_service.add_work_log(order, current_user_id, user_role, log_data)
        
        # åˆ·æ–°ä»¥åŠ è½½å…³ç³»
        db.session.refresh(new_log)
        return jsonify(work_log_schemas.WorkLogOut.model_validate(new_log).model_dump(mode='json')), 201

    except ValidationError as e:
        return jsonify(e.errors()), 400
    except (ValueError, PermissionError) as e:
        return jsonify({"msg": str(e)}), 403 # 403 Forbidden for permission issues
    except Exception as e:
        db.session.rollback()
        return jsonify({"msg": "An unexpected error occurred", "details": str(e)}), 500

===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\app\api\reports.py
========================================

# backend/app/api/reports.py

from flask import Blueprint, request, jsonify, send_file
from flask_jwt_extended import jwt_required
from ..services import report_service
from ..models.user import UserRole
from ..utils.decorators import role_required

reports_bp = Blueprint('reports', __name__)

@reports_bp.route('/settled-orders', methods=['GET'])
@jwt_required()
@role_required([UserRole.FINANCE.value, UserRole.SUPER_ADMIN.value]) # å‡è®¾åªæœ‰è´¢åŠ¡å¯ä»¥å¯¼å‡º
def download_settled_orders_report():
    """
    ä¸‹è½½å·²ç»“ç®—è®¢å•çš„ExcelæŠ¥è¡¨.
    æ¥æ”¶æŸ¥è¯¢å‚æ•°: start_date (YYYY-MM-DD), end_date (YYYY-MM-DD)
    """
    start_date = request.args.get('start_date')
    end_date = request.args.get('end_date')

    if not start_date or not end_date:
        return jsonify({"msg": "start_date and end_date query parameters are required."}), 400

    try:
        excel_file = report_service.generate_settled_orders_report(start_date, end_date)
        
        filename = f"settled_orders_{start_date}_to_{end_date}.xlsx"
        
        return send_file(
            excel_file,
            as_attachment=True,
            download_name=filename,
            mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
        )

    except ValueError as e:
        return jsonify({"msg": str(e)}), 400
    except Exception as e:
        # åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œåº”è¯¥è®°å½•æ›´è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
        return jsonify({"msg": "An unexpected error occurred while generating the report."}), 500

===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\app\api\users.py
========================================

# backend/app/api/users.py

from flask import Blueprint, request, jsonify
from pydantic import ValidationError
from .. import db
from ..models.user import UserRole
from ..schemas import user_schemas
from ..utils.decorators import role_required
from flask_jwt_extended import jwt_required, get_jwt
from io import BytesIO # + æ–°å¢
# --- ADDED: å¯¼å…¥æ–°çš„æœåŠ¡å±‚ ---
from ..services import user_service

users_bp = Blueprint('users', __name__)

@users_bp.route('/', methods=['POST'])
@jwt_required()
@role_required(UserRole.SUPER_ADMIN.value)
def create_user_route():
    """åˆ›å»ºæ–°ç”¨æˆ·"""
    try:
        user_data = user_schemas.UserCreate.model_validate(request.get_json())
        
        # --- CHANGED: è°ƒç”¨æœåŠ¡å±‚ ---
        new_user = user_service.create_user(user_data)
        
        return jsonify(user_schemas.UserOut.model_validate(new_user).model_dump(mode='json')), 201
    
    except ValidationError as e:
        return jsonify(e.errors()), 400
    except ValueError as e:
        return jsonify({"msg": str(e)}), 409 # 409 Conflict for existing username
    except Exception as e:
        return jsonify({"msg": "An unexpected error occurred", "details": str(e)}), 500

@users_bp.route('/', methods=['GET'])
@jwt_required()
def get_users_route():
    """è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆæ ¹æ®è°ƒç”¨è€…è§’è‰²è¿”å›ä¸åŒæ•°æ®ï¼‰"""
    claims = get_jwt()
    current_user_role = claims.get("role")

    # --- CHANGED: ä¸šåŠ¡é€»è¾‘ç§»è‡³æœåŠ¡å±‚ ---
    if current_user_role == UserRole.SUPER_ADMIN.value:
        users = user_service.get_all_users()
    elif current_user_role == UserRole.CUSTOMER_SERVICE.value:
        users = user_service.get_active_developers()
    else:
        users = [] # å…¶ä»–è§’è‰²æ— æƒè·å–åˆ—è¡¨

    users_out = [user_schemas.UserOut.model_validate(user).model_dump(mode='json') for user in users]
    return jsonify(users_out), 200

@users_bp.route('/<int:user_id>', methods=['GET'])
@jwt_required()
@role_required(UserRole.SUPER_ADMIN.value)
def get_user_route(user_id: int):
    """è·å–å•ä¸ªç”¨æˆ·ä¿¡æ¯"""
    user = user_service.get_user_by_id(user_id)
    if not user:
        return jsonify({"msg": "User not found"}), 404
    
    return jsonify(user_schemas.UserOut.model_validate(user).model_dump(mode='json')), 200

@users_bp.route('/<int:user_id>', methods=['PUT'])
@jwt_required()
@role_required(UserRole.SUPER_ADMIN.value)
def update_user_route(user_id: int):
    """æ›´æ–°ç”¨æˆ·ä¿¡æ¯"""
    try:
        update_data = user_schemas.UserUpdate.model_validate(request.get_json())
        
        # --- CHANGED: è°ƒç”¨æœåŠ¡å±‚ ---
        updated_user = user_service.update_user(user_id, update_data)
        
        return jsonify(user_schemas.UserOut.model_validate(updated_user).model_dump(mode='json')), 200

    except ValidationError as e:
        return jsonify(e.errors()), 400
    except ValueError as e:
        # æ ¹æ®é”™è¯¯ä¿¡æ¯åˆ¤æ–­æ˜¯404è¿˜æ˜¯409
        if "not found" in str(e).lower():
            return jsonify({"msg": str(e)}), 404
        else:
            return jsonify({"msg": str(e)}), 409
    except Exception as e:
        return jsonify({"msg": "An unexpected error occurred", "details": str(e)}), 500


@users_bp.route('/<int:user_id>/toggle-status', methods=['PATCH'])
@jwt_required()
@role_required(UserRole.SUPER_ADMIN.value)
def toggle_user_status_route(user_id: int):
    """å¯ç”¨/ç¦ç”¨ç”¨æˆ·"""
    try:
        # --- CHANGED: è°ƒç”¨æœåŠ¡å±‚ ---
        updated_user = user_service.toggle_user_status(user_id)
        return jsonify(user_schemas.UserOut.model_validate(updated_user).model_dump(mode='json')), 200
    except ValueError as e:
        return jsonify({"msg": str(e)}), 404

@users_bp.route('/<int:user_id>', methods=['DELETE'])
@jwt_required()
@role_required(UserRole.SUPER_ADMIN.value)
def delete_user_route(user_id: int):
    """åˆ é™¤ç”¨æˆ·"""
    try:
        # --- CHANGED: è°ƒç”¨æœåŠ¡å±‚ ---
        user_service.delete_user(user_id)
        return '', 204
    except ValueError as e:
        return jsonify({"msg": str(e)}), 404
    
# +--- æ–°å¢çš„å®Œæ•´è·¯ç”±å¼€å§‹ ---+
@users_bp.route('/import', methods=['POST'])
@jwt_required()
@role_required(UserRole.SUPER_ADMIN.value)
def import_users_route():
    """è¶…ç®¡é€šè¿‡ä¸Šä¼ Excelæ–‡ä»¶æ‰¹é‡å¯¼å…¥ç”¨æˆ·"""
    if 'file' not in request.files:
        return jsonify({"msg": "è¯·æ±‚ä¸­æœªåŒ…å«æ–‡ä»¶éƒ¨åˆ†(file part)"}), 400
    
    file = request.files['file']
    if file.filename == '':
        return jsonify({"msg": "æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶"}), 400

    if file and file.filename.endswith('.xlsx'):
        try:
            # å°†æ–‡ä»¶å†…å®¹è¯»å…¥å†…å­˜ä¸­çš„å­—èŠ‚æµ
            file_stream = BytesIO(file.read())
            result = user_service.batch_import_users(file_stream)
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({"msg": str(e)}), 400
        except Exception as e:
            # ç¡®ä¿åœ¨æœªçŸ¥é”™è¯¯å‘ç”Ÿæ—¶å›æ»šä¼šè¯
            db.session.rollback()
            return jsonify({"msg": "å¤„ç†æ–‡ä»¶æ—¶å‘ç”Ÿæ„å¤–é”™è¯¯", "details": str(e)}), 500
    else:
        return jsonify({"msg": "æ–‡ä»¶ç±»å‹æ— æ•ˆï¼Œè¯·ä¸Šä¼  .xlsx æ–‡ä»¶"}), 400

===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\app\models\commission.py
========================================

# backend/app/models/commission.py

from .. import db
from datetime import datetime

class Commission(db.Model):
    __tablename__ = 'commissions'

    id = db.Column(db.Integer, primary_key=True, comment="ææˆè®°å½•ID(ä¸»é”®)")
    order_id = db.Column(db.Integer, db.ForeignKey('orders.id'), nullable=False, comment="å…³è”çš„è®¢å•ID")
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False, comment="ææˆå½’å±çš„ç”¨æˆ·ID")
    
    amount = db.Column(db.Numeric(10, 2), nullable=False, comment="ææˆé‡‘é¢") # [cite: 122]
    
    # è®°å½•è®¡ç®—æ—¶è¯¥ç”¨æˆ·åœ¨è®¢å•ä¸­çš„è§’è‰²ï¼Œé˜²æ­¢æœªæ¥ç”¨æˆ·è§’è‰²å˜åŠ¨å¯¼è‡´æ•°æ®ä¸æ¸…
    role_at_time = db.Column(db.String(50), nullable=False, comment="è®¡ç®—æ—¶è¯¥ç”¨æˆ·åœ¨è®¢å•ä¸­çš„è§’è‰²(å®¢æœ/æŠ€æœ¯)") # [cite: 122]
    
    created_at = db.Column(db.DateTime, default=datetime.utcnow, comment="ææˆè®¡ç®—æ—¶é—´")
    
    # å…³ç³»å®šä¹‰
    order = db.relationship('Order', back_populates='commissions')
    user = db.relationship('User', back_populates='commissions')

    def __repr__(self):
        return f'<Commission {self.id} for Order {self.order_id}>'

===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\app\models\notification.py
========================================

# backend/app/models/notification.py

from .. import db
from datetime import datetime

class Notification(db.Model):
    __tablename__ = 'notifications'

    id = db.Column(db.Integer, primary_key=True, comment="é€šçŸ¥ID(ä¸»é”®)")
    recipient_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False, comment="æ¥æ”¶é€šçŸ¥çš„ç”¨æˆ·ID")
    content = db.Column(db.String(255), nullable=False, comment="é€šçŸ¥å†…å®¹")
    is_read = db.Column(db.Boolean, default=False, nullable=False, comment="æ˜¯å¦å·²è¯»")
    
    # å¯é€‰ï¼Œç”¨äºç‚¹å‡»é€šçŸ¥åè·³è½¬åˆ°ç›¸å…³è®¢å•
    related_order_id = db.Column(db.Integer, db.ForeignKey('orders.id'), nullable=True, comment="(å¯é€‰)å…³è”çš„è®¢å•ID,ç”¨äºè·³è½¬") # [cite: 128]
    
    created_at = db.Column(db.DateTime, default=datetime.utcnow, comment="é€šçŸ¥åˆ›å»ºæ—¶é—´")

    # å…³ç³»å®šä¹‰
    recipient = db.relationship('User', back_populates='notifications')

    def __repr__(self):
        return f'<Notification {self.id} for User {self.recipient_id}>'

===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\app\models\order.py
========================================

# backend/app/models/order.py

from datetime import datetime
from enum import Enum
from .. import db
from sqlalchemy.dialects.mysql import JSON

# è®¢å•çŠ¶æ€çš„æšä¸¾ (ä¿æŒä¸å˜, ä¸æ–‡æ¡£æµç¨‹å»åˆ)
class OrderStatus(Enum):
    PENDING_ASSIGNMENT = 'å¾…åŒ¹é…'
    PENDING_PAYMENT = 'å¾…ä»˜æ¬¾'
    PAID = 'å·²ä»˜æ¬¾'  # + æ–°å¢çŠ¶æ€
    IN_DEVELOPMENT = 'å¼€å‘ä¸­'
    SHIPPED = 'å·²å‘è´§'
    RECEIVED = 'å·²æ”¶è´§'
    PENDING_SETTLEMENT = 'å¯ç»“ç®—'
    VERIFIED = 'å·²æ ¸éªŒ'
    SETTLED = 'å·²ç»“ç®—'
    CANCELLED = 'å·²å–æ¶ˆ'

# è®¢å•æ•°æ®æ¨¡å‹
class Order(db.Model):
    __tablename__ = 'orders'

    id = db.Column(db.Integer, primary_key=True)
    
    # --- ADDED: ä¸šåŠ¡IDï¼Œæ ¹æ®éœ€æ±‚æ–‡æ¡£æ·»åŠ  ---
    order_uid = db.Column(db.String(50), unique=True, nullable=False, comment="ä¸šåŠ¡ID, PREFIX-YYYYMMDD-XXXX") # 

    # --- CHANGED: ä¿®æ”¹ä¸ºJSONç±»å‹ä»¥å­˜å‚¨ç»“æ„åŒ–å®¢æˆ·ä¿¡æ¯ ---
    customer_info = db.Column(JSON, nullable=False, comment="å®¢æˆ·ä¿¡æ¯, å¦‚{\"name\": \"å¼ ä¸‰\", \"phone\": ...}") # 

    requirements_desc = db.Column(db.Text, nullable=False, comment="éœ€æ±‚æè¿°")
    
    # --- CHANGED: ä¿®æ”¹ä¸ºNumericä»¥ç¡®ä¿è´¢åŠ¡è®¡ç®—ç²¾åº¦ ---
    final_price = db.Column(db.Numeric(10, 2), nullable=True, comment="è®¢å•ä»·æ ¼") # 
    
    status = db.Column(db.Enum(OrderStatus), nullable=False, default=OrderStatus.PENDING_ASSIGNMENT)

    # å¤–é”®å…³è”
    creator_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False) # åˆ›å»ºäºº (å®¢æœ)
    developer_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=True) # è´Ÿè´£äºº (æŠ€æœ¯)

    # --- ADDED: ç”¨äºå­˜å‚¨ç‰¹æ®Šææˆæ¯”ä¾‹ ---
    commission_rate_override = db.Column(JSON, nullable=True, comment="ç‰¹æ®Šææˆæ¯”ä¾‹, å¦‚ {\"cs_rate\": 12.5, \"tech_rate\": 15.0}") # 

    # --- ADDED: è®¢å•é”å®šæ ‡è®° ---
    is_locked = db.Column(db.Boolean, default=False, nullable=False, comment="è®¢å•æ˜¯å¦é”å®š(å·²ç»“ç®—/å·²å–æ¶ˆ)") # 

    # æ—¶é—´æˆ³
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    shipped_at = db.Column(db.DateTime, nullable=True)

    # å…³ç³»å®šä¹‰
    creator = db.relationship('User', back_populates='orders_created', foreign_keys=[creator_id])
    developer = db.relationship('User', back_populates='orders_assigned', foreign_keys=[developer_id])
    logs = db.relationship('WorkLog', back_populates='order', cascade="all, delete-orphan")
    
    # --- ADDED: æ–°å¢ä¸ææˆè¡¨çš„å…³ç³» ---
    commissions = db.relationship('Commission', back_populates='order', cascade="all, delete-orphan")

    def __repr__(self):
        return f'<Order {self.id}>'

# å·¥ä½œæ—¥å¿—æ¨¡å‹ (ä¿æŒä¸å˜, ä½†ä¸ºæ¸…æ™°èµ·è§ï¼Œç§»é™¤budgetç­‰æ— å…³å­—æ®µï¼Œå¹¶è°ƒæ•´å¤–é”®å…³ç³»)
class WorkLog(db.Model):
    __tablename__ = 'work_logs'

    id = db.Column(db.Integer, primary_key=True)
    log_content = db.Column(db.Text, nullable=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow) # ä½¿ç”¨ created_at æ›´é€šç”¨

    # å¤–é”®å…³è”
    order_id = db.Column(db.Integer, db.ForeignKey('orders.id'), nullable=False)
    # --- CHANGED: å­—æ®µåä¸éœ€æ±‚æ–‡æ¡£å¯¹é½ ---
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False, comment="å¡«å†™æ—¥å¿—çš„æŠ€æœ¯äººå‘˜ID") # [cite: 125]

    # å…³ç³»å®šä¹‰
    order = db.relationship('Order', back_populates='logs')
    developer = db.relationship('User', back_populates='work_logs')

    def __repr__(self):
        return f'<WorkLog for Order {self.order_id}>'

===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\app\models\user.py
========================================

# backend/app/models/user.py

from .. import db
from enum import Enum
from sqlalchemy.dialects.mysql import JSON # å»ºè®®æ˜¾å¼å¯¼å…¥

# å®šä¹‰ç”¨æˆ·è§’è‰²çš„æšä¸¾ (ä¿æŒä¸å˜)
class UserRole(Enum):
    SUPER_ADMIN = 'SUPER_ADMIN'
    CUSTOMER_SERVICE = 'CUSTOMER_SERVICE'
    DEVELOPER = 'DEVELOPER'
    FINANCE = 'FINANCE'

# ç”¨æˆ·æ•°æ®æ¨¡å‹
class User(db.Model):
    __tablename__ = 'users'

    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(80), unique=True, nullable=False)
    password_hash = db.Column(db.String(128), nullable=False)
    full_name = db.Column(db.String(100), nullable=True)
    role = db.Column(db.Enum(UserRole), nullable=False, default=UserRole.DEVELOPER)
    gender = db.Column(db.String(10), nullable=True)
    
    # --- CHANGED: å­—æ®µé‡å‘½åå¹¶ä¿®æ”¹ç±»å‹ä»¥æ”¯æŒJSONæ ¼å¼çš„æŠ€èƒ½æ ‡ç­¾ ---
    skills = db.Column(JSON, nullable=True, comment="æ“…é•¿é¢†åŸŸ(ä¸ºæŠ€æœ¯è§’è‰²)") # 

    # --- CHANGED: ä¿®æ”¹ä¸ºNumericä»¥ç¡®ä¿è´¢åŠ¡è®¡ç®—ç²¾åº¦ ---
    default_commission_rate = db.Column(db.Numeric(5, 2), nullable=True, comment="é»˜è®¤ææˆæ¯”ä¾‹,å¦‚10.00(%)") # 

    financial_account = db.Column(db.String(255), nullable=True, comment="è´¢åŠ¡è´¦å·(é“¶è¡Œå¡/æ”¯ä»˜å®)") # 
    is_active = db.Column(db.Boolean, default=True)

    # --- å…³ç³»å®šä¹‰ (ä¿æŒä¸å˜) ---
    # ä¸€ä¸ªå®¢æœåˆ›å»ºå¤šä¸ªè®¢å•
    orders_created = db.relationship('Order', back_populates='creator', foreign_keys='Order.creator_id', lazy='dynamic')
    # ä¸€ä¸ªæŠ€æœ¯è´Ÿè´£å¤šä¸ªè®¢å•
    orders_assigned = db.relationship('Order', back_populates='developer', foreign_keys='Order.developer_id', lazy='dynamic')
    # ä¸€ä¸ªæŠ€æœ¯æœ‰å¤šä¸ªå·¥ä½œæ—¥å¿—
    work_logs = db.relationship('WorkLog', back_populates='developer', lazy='dynamic')

    # --- ADDED: æ–°å¢ä¸ææˆå’Œé€šçŸ¥è¡¨çš„å…³ç³» ---
    commissions = db.relationship('Commission', back_populates='user', lazy='dynamic')
    notifications = db.relationship('Notification', back_populates='recipient', lazy='dynamic')

    def __repr__(self):
        return f'<User {self.username}>'

===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\app\schemas\commission_schemas.py
========================================

# backend/app/schemas/commission_schemas.py

from pydantic import BaseModel, Field, ConfigDict
from datetime import datetime
from decimal import Decimal

class CommissionBase(BaseModel):
    user_id: int
    amount: Decimal
    role_at_time: str

class CommissionOut(CommissionBase):
    id: int
    created_at: datetime
    
    # --- ADDED: åµŒå¥—è¿”å›ç”¨æˆ·ä¿¡æ¯ï¼Œä¾¿äºå‰ç«¯å±•ç¤º ---
    full_name: str | None = Field(None, alias="user.full_name")

    model_config = ConfigDict(from_attributes=True)

===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\app\schemas\notification_schemas.py
========================================

# backend/app/schemas/notification_schemas.py

from pydantic import BaseModel, ConfigDict
from datetime import datetime
from typing import Optional

class NotificationBase(BaseModel):
    content: str
    is_read: bool
    related_order_id: Optional[int] = None
    created_at: datetime

class NotificationOut(NotificationBase):
    id: int
    
    model_config = ConfigDict(from_attributes=True)

===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\app\schemas\order_schemas.py
========================================

# backend/app/schemas/order_schemas.py

from pydantic import BaseModel, Field, ConfigDict
from typing import Optional, List, Dict, Any
from datetime import datetime
from decimal import Decimal
from ..models.order import OrderStatus
from .user_schemas import UserOut
# --- ADDED: å¯¼å…¥æ–°åˆ›å»ºçš„schemas ---
from .work_log_schemas import WorkLogOut
from .commission_schemas import CommissionOut

# ç”¨äºåœ¨è®¢å•ä¿¡æ¯ä¸­ç²¾ç®€æ˜¾ç¤ºçš„ç”¨æˆ·æ¨¡å‹
class UserInOrderOut(BaseModel):
    id: int
    full_name: Optional[str] = None
    financial_account: Optional[str] = None # + æ–°å¢æ­¤å­—æ®µ
    model_config = ConfigDict(from_attributes=True)

# --- CHANGED: åˆ›å»ºè®¢å•æ—¶ï¼Œåªæ¥æ”¶æœ€åŸºæœ¬ä¿¡æ¯ ---
class OrderCreate(BaseModel):
    customer_info: Dict[str, Any] = Field(..., description="å®¢æˆ·ä¿¡æ¯, e.g. {'name': 'å¼ ä¸‰', 'phone': '138...'}")
    requirements_desc: str = Field(..., min_length=1)

# --- ADDED: å±€éƒ¨æ›´æ–°è®¢å•æ—¶ï¼Œå®¢æœå¯æäº¤çš„æ•°æ® ---
class OrderUpdateByCs(BaseModel):
    final_price: Optional[Decimal] = Field(None, ge=0, description="è®¢å•ä»·æ ¼")
    developer_id: Optional[int] = Field(None, description="åˆ†é…çš„æŠ€æœ¯äººå‘˜ID")

# --- ADDED: å±€éƒ¨æ›´æ–°è®¢å•çŠ¶æ€çš„Schema ---
class OrderStatusUpdate(BaseModel):
    status: OrderStatus = Field(..., description="ç›®æ ‡çŠ¶æ€")

# --- ADDED: è¶…ç®¡è®¾ç½®ç‰¹æ®Šææˆçš„Schema ---
class CommissionOverrideUpdate(BaseModel):
    cs_rate: Optional[Decimal] = Field(None, ge=0, le=100)
    tech_rate: Optional[Decimal] = Field(None, ge=0, le=100)

# --- CHANGED: ä»APIè¿”å›è®¢å•ä¿¡æ¯çš„æ ‡å‡†æ ¼å¼ï¼ŒåŒ…å«æ‰€æœ‰å…³è”ä¿¡æ¯ ---
class OrderOut(BaseModel):
    id: int
    order_uid: str
    customer_info: Dict[str, Any]
    requirements_desc: str
    final_price: Optional[Decimal] = None
    status: OrderStatus
    
    creator: UserInOrderOut
    developer: Optional[UserInOrderOut] = None
    
    commission_rate_override: Optional[Dict[str, float]] = None
    is_locked: bool

    created_at: datetime
    updated_at: datetime
    shipped_at: Optional[datetime] = None
    
    # --- ADDED: åµŒå¥—è¿”å›å·¥ä½œæ—¥å¿—å’Œææˆä¿¡æ¯ ---
    logs: List[WorkLogOut] = []
    commissions: List[CommissionOut] = []

    model_config = ConfigDict(from_attributes=True)

===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\app\schemas\user_schemas.py
========================================

# backend/app/schemas/user_schemas.py

from pydantic import BaseModel, Field, ConfigDict
from typing import Optional, List
from decimal import Decimal
from ..models.user import UserRole

# åŸºç¡€æ¨¡å¼ï¼ŒåŒ…å«æ‰€æœ‰è§’è‰²å…±æœ‰çš„å­—æ®µ
class UserBase(BaseModel):
    username: str = Field(..., min_length=3, max_length=80)
    full_name: Optional[str] = Field(None, max_length=100)
    role: UserRole
    gender: Optional[str] = Field(None, max_length=10)
    
    # --- CHANGED: å­—æ®µåå’Œç±»å‹ä¸æ¨¡å‹å¯¹é½ ---
    skills: Optional[List[str]] = Field(None, description="æŠ€æœ¯äººå‘˜çš„æŠ€èƒ½æ ‡ç­¾, å¦‚ ['Java', 'UIè®¾è®¡']")
    
    # --- CHANGED: ç±»å‹ä¸æ¨¡å‹å¯¹é½ ---
    default_commission_rate: Optional[Decimal] = Field(None, ge=0, le=100, description="é»˜è®¤ææˆæ¯”ä¾‹, 10.50 è¡¨ç¤º 10.50%")
    
    financial_account: Optional[str] = Field(None, max_length=255)
    
    # Pydantic V2 é…ç½®
    model_config = ConfigDict(from_attributes=True)

# åˆ›å»ºç”¨æˆ·æ—¶ä½¿ç”¨çš„æ¨¡å¼ï¼Œéœ€è¦æä¾›å¯†ç 
class UserCreate(UserBase):
    password: str = Field(..., min_length=6)

# æ›´æ–°ç”¨æˆ·æ—¶ä½¿ç”¨çš„æ¨¡å¼ï¼Œæ‰€æœ‰å­—æ®µéƒ½æ˜¯å¯é€‰çš„
class UserUpdate(BaseModel):
    username: Optional[str] = Field(None, min_length=3, max_length=80)
    full_name: Optional[str] = Field(None, max_length=100)
    role: Optional[UserRole] = None
    gender: Optional[str] = Field(None, max_length=10)
    skills: Optional[List[str]] = Field(None)
    default_commission_rate: Optional[Decimal] = Field(None, ge=0, le=100)
    financial_account: Optional[str] = Field(None, max_length=255)
    password: Optional[str] = Field(None, min_length=6)
    is_active: Optional[bool] = None

# ä»APIè¿”å›ç”¨æˆ·ä¿¡æ¯æ—¶ä½¿ç”¨çš„æ¨¡å¼ï¼Œä¸åŒ…å«å¯†ç å“ˆå¸Œ
class UserOut(UserBase):
    id: int
    is_active: bool

===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\app\schemas\work_log_schemas.py
========================================

# backend/app/schemas/work_log_schemas.py

from pydantic import BaseModel, Field, ConfigDict
from datetime import datetime
from .user_schemas import UserOut # ç”¨äºåµŒå¥—æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯

# ç”¨äºåœ¨è®¢å•è¯¦æƒ…ä¸­æ˜¾ç¤ºçš„æŠ€æœ¯äººå‘˜ç®€è¦ä¿¡æ¯
class UserInLogOut(BaseModel):
    id: int
    full_name: str | None = None
    
    model_config = ConfigDict(from_attributes=True)

class WorkLogBase(BaseModel):
    log_content: str

# ---ã€ä»»åŠ¡4.1ã€‘æ–°å¢ç”¨äºåˆ›å»ºçš„ Schema ---
class WorkLogCreate(WorkLogBase):
    log_content: str = Field(..., min_length=1, description="æ—¥å¿—å†…å®¹ä¸èƒ½ä¸ºç©º")

class WorkLogOut(WorkLogBase):
    id: int
    created_at: datetime
    user_id: int
    developer: UserInLogOut

    model_config = ConfigDict(from_attributes=True)

===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\app\services\commission_service.py
========================================

# backend/app/services/commission_service.py (æ–°å¢æ–‡ä»¶)

from decimal import Decimal
from .. import db
from ..models.order import Order
from ..models.commission import Commission
from ..models.user import User, UserRole

def calculate_and_create_commissions(order: Order):
    """
    ä¸ºå·²æ ¸éªŒçš„è®¢å•è®¡ç®—å¹¶åˆ›å»ºææˆè®°å½•ã€‚
    è¿™æ˜¯ä¸€ä¸ªæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ã€‚
    """
    if not order.final_price or order.final_price <= 0:
        print(f"è®¢å• {order.id} ä»·æ ¼æ— æ•ˆï¼Œè·³è¿‡ææˆè®¡ç®—ã€‚")
        return

    # æ¸…é™¤æ—§çš„ææˆè®°å½•ï¼Œä»¥é˜²é‡å¤è®¡ç®—
    Commission.query.filter_by(order_id=order.id).delete()

    # å‡†å¤‡ææˆè®¡ç®—æ‰€éœ€çš„æ•°æ®
    final_price = order.final_price
    override_rates = order.commission_rate_override or {}

    # 1. è®¡ç®—å®¢æœçš„ææˆ
    if order.creator and order.creator.role == UserRole.CUSTOMER_SERVICE:
        cs_rate = override_rates.get('cs_rate')
        if cs_rate is None and order.creator.default_commission_rate is not None:
            cs_rate = order.creator.default_commission_rate
        
        if cs_rate is not None:
            amount = final_price * (Decimal(str(cs_rate)) / 100)
            commission_cs = Commission(
                order_id=order.id,
                user_id=order.creator_id,
                amount=amount,
                role_at_time=UserRole.CUSTOMER_SERVICE.value
            )
            db.session.add(commission_cs)
            print(f"ä¸ºå®¢æœ {order.creator.full_name} è®¡ç®—ææˆ: {amount}")

    # 2. è®¡ç®—æŠ€æœ¯äººå‘˜çš„ææˆ
    if order.developer and order.developer.role == UserRole.DEVELOPER:
        tech_rate = override_rates.get('tech_rate')
        if tech_rate is None and order.developer.default_commission_rate is not None:
            tech_rate = order.developer.default_commission_rate

        if tech_rate is not None:
            amount = final_price * (Decimal(str(tech_rate)) / 100)
            commission_tech = Commission(
                order_id=order.id,
                user_id=order.developer_id,
                amount=amount,
                role_at_time=UserRole.DEVELOPER.value
            )
            db.session.add(commission_tech)
            print(f"ä¸ºæŠ€æœ¯ {order.developer.full_name} è®¡ç®—ææˆ: {amount}")

    # æ³¨æ„ï¼šè¿™é‡Œçš„ commit å°†ç”±ä¸Šå±‚è°ƒç”¨è€… (update_order_status) ç»Ÿä¸€æ‰§è¡Œ

===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\app\services\dashboard_service.py
========================================

# backend/app/services/dashboard_service.py

from sqlalchemy import func, extract
from datetime import datetime
from .. import db
from ..models.user import User, UserRole
from ..models.order import Order, OrderStatus
from ..models.commission import Commission

def get_personal_stats(user_id: int, user_role: str):
    """ä¸ºå®¢æœ/æŠ€æœ¯æä¾›ä¸ªäººä¸šç»©ç»Ÿè®¡"""
    
    # è·å–æœ¬æœˆæ—¶é—´èŒƒå›´
    today = datetime.utcnow()
    start_of_month = today.replace(day=1, hour=0, minute=0, second=0, microsecond=0)
    
    stats = {}

    if user_role == UserRole.CUSTOMER_SERVICE.value:
        # æœ¬æœˆåˆ›å»ºè®¢å•æ•°
        monthly_orders = db.session.query(func.count(Order.id)).filter(
            Order.creator_id == user_id,
            Order.created_at >= start_of_month
        ).scalar()

        # ç´¯è®¡æ€»ææˆ
        total_commission = db.session.query(func.sum(Commission.amount)).filter(
            Commission.user_id == user_id,
            Commission.role_at_time == UserRole.CUSTOMER_SERVICE.value
        ).scalar()
        
        stats = {
            "monthly_orders_created": monthly_orders or 0,
            "total_commission_earned": float(total_commission or 0)
        }

    elif user_role == UserRole.DEVELOPER.value:
        # æœ¬æœˆå®Œæˆè®¢å•æ•° (çŠ¶æ€å˜ä¸º 'å¯ç»“ç®—' æˆ–æ›´é«˜)
        monthly_completed = db.session.query(func.count(Order.id)).filter(
            Order.developer_id == user_id,
            Order.status.in_([
                OrderStatus.PENDING_SETTLEMENT, 
                OrderStatus.VERIFIED, 
                OrderStatus.SETTLED
            ]),
            Order.updated_at >= start_of_month
        ).scalar()

        # ç´¯è®¡æ€»ææˆ
        total_commission = db.session.query(func.sum(Commission.amount)).filter(
            Commission.user_id == user_id,
            Commission.role_at_time == UserRole.DEVELOPER.value
        ).scalar()
        
        stats = {
            "monthly_orders_completed": monthly_completed or 0,
            "total_commission_earned": float(total_commission or 0)
        }
        
    return stats

def get_global_stats():
    """ä¸ºè¶…ç®¡æä¾›å…¨å±€æ•°æ®çœ‹æ¿"""
    
    total_users = db.session.query(func.count(User.id)).scalar()
    total_orders = db.session.query(func.count(Order.id)).scalar()
    
    # ç»Ÿè®¡æ‰€æœ‰å·²ç»“ç®—è®¢å•çš„æ€»é‡‘é¢
    total_settled_value = db.session.query(func.sum(Order.final_price)).filter(
        Order.status == OrderStatus.SETTLED
    ).scalar()

    # æŒ‰çŠ¶æ€ç»Ÿè®¡è®¢å•æ•°é‡
    orders_by_status = db.session.query(
        Order.status, func.count(Order.id)
    ).group_by(Order.status).all()

    # æ ¼å¼åŒ–ä¸ºå­—å…¸
    status_distribution = {status.value: count for status, count in orders_by_status}

    return {
        "total_users": total_users or 0,
        "total_orders": total_orders or 0,
        "total_settled_value": float(total_settled_value or 0),
        "status_distribution": status_distribution
    }

def get_team_performance_stats() -> dict:
    """
    è·å–å›¢é˜Ÿç»©æ•ˆç»Ÿè®¡ï¼ˆæœ¬æœˆï¼‰
    :return: åŒ…å«å®¢æœå’ŒæŠ€æœ¯å›¢é˜Ÿä¸šç»©çš„å­—å…¸
    """
    today = datetime.utcnow()
    current_month = today.month
    current_year = today.year

    # 1. æŸ¥è¯¢å®¢æœå›¢é˜Ÿä¸šç»©ï¼ˆæŒ‰æœ¬æœˆåˆ›å»ºè®¢å•çš„é‡‘é¢æ’åï¼‰
    cs_performance = db.session.query(
        User.full_name,
        func.sum(Order.final_price).label('total_amount')
    ).join(
        Order, User.id == Order.creator_id
    ).filter(
        User.role == UserRole.CUSTOMER_SERVICE,
        extract('year', Order.created_at) == current_year,
        extract('month', Order.created_at) == current_month,
        Order.final_price.isnot(None) # åªç»Ÿè®¡å·²å®šä»·çš„è®¢å•
    ).group_by(
        User.id
    ).order_by(
        func.sum(Order.final_price).desc()
    ).all()

    # 2. æŸ¥è¯¢æŠ€æœ¯å›¢é˜Ÿä¸šç»©ï¼ˆæŒ‰æœ¬æœˆå®Œæˆç»“ç®—çš„è®¢å•é‡‘é¢æ’åï¼‰
    dev_performance = db.session.query(
        User.full_name,
        func.sum(Order.final_price).label('total_amount')
    ).join(
        Order, User.id == Order.developer_id
    ).filter(
        User.role == UserRole.DEVELOPER,
        # è®¢å•çš„æœ€ç»ˆæ›´æ–°æ—¶é—´ï¼ˆå˜ä¸ºSETTLEDçŠ¶æ€çš„æ—¶é—´ï¼‰åœ¨æœ¬æœˆ
        extract('year', Order.updated_at) == current_year,
        extract('month', Order.updated_at) == current_month,
        Order.status == OrderStatus.SETTLED # åªç»Ÿè®¡å·²ç»“ç®—çš„è®¢å•
    ).group_by(
        User.id
    ).order_by(
        func.sum(Order.final_price).desc()
    ).all()

    # æ ¼å¼åŒ–ç»“æœ
    formatted_cs = [{"full_name": name, "total_value": float(amount or 0)} for name, amount in cs_performance]
    formatted_dev = [{"full_name": name, "total_value": float(amount or 0)} for name, amount in dev_performance]

    return {
        "customer_service_performance": formatted_cs,
        "developer_performance": formatted_dev
    }

===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\app\services\notification_service.py
========================================

# backend/app/services/notification_service.py

from .. import db
from ..models.notification import Notification
from ..models.user import User, UserRole

def create_notification(recipient_id: int, content: str, related_order_id: int = None):
    """
    åˆ›å»ºä¸€ä¸ªæ–°çš„é€šçŸ¥å¹¶å­˜å…¥æ•°æ®åº“
    """
    notification = Notification(
        recipient_id=recipient_id,
        content=content,
        related_order_id=related_order_id
    )
    db.session.add(notification)
    # æ­¤å¤„çš„ commit å°†ç”±è°ƒç”¨å®ƒçš„ä¸Šå±‚ä¸šåŠ¡å‡½æ•°ç»Ÿä¸€å¤„ç†

def notify_all_finances(content: str, related_order_id: int):
    """
    é€šçŸ¥æ‰€æœ‰è´¢åŠ¡äººå‘˜
    """
    finance_users = User.query.filter_by(role=UserRole.FINANCE, is_active=True).all()
    for user in finance_users:
        create_notification(user.id, content, related_order_id)
        
def get_notifications_for_user(user_id: int) -> list[Notification]:
    """
    è·å–æŒ‡å®šç”¨æˆ·çš„æ‰€æœ‰é€šçŸ¥ï¼ŒæŒ‰æ—¶é—´å€’åºæ’åˆ—ã€‚
    """
    return Notification.query.filter_by(recipient_id=user_id).order_by(Notification.created_at.desc()).all()


def mark_notification_as_read(notification_id: int, user_id: int) -> Notification | None:
    """
    å°†æŒ‡å®šIDçš„é€šçŸ¥æ ‡è®°ä¸ºå·²è¯»ã€‚
    åŒæ—¶æ ¡éªŒæ“ä½œè€…æ˜¯å¦ä¸ºé€šçŸ¥çš„æ¥æ”¶è€…ã€‚
    """
    notification = db.session.get(Notification, notification_id)
    
    # æ ¡éªŒé€šçŸ¥æ˜¯å¦å­˜åœ¨
    if not notification:
        return None
        
    # æ ¡éªŒæ“ä½œæƒé™
    if notification.recipient_id != user_id:
        raise PermissionError("You do not have permission to modify this notification.")
        
    notification.is_read = True
    db.session.commit()
    
    return notification

===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\app\services\order_service.py
========================================

# backend/app/services/order_service.py

from .. import db
from ..models.user import User, UserRole
from ..models.order import Order, OrderStatus
from ..schemas import order_schemas
from datetime import datetime
import random

# --- ADDED: å¯¼å…¥é€šçŸ¥æœåŠ¡ ---
from . import notification_service 
from . import commission_service # <-- æ–°å¢å¯¼å…¥

def generate_order_uid():
    """ç”Ÿæˆæ ¼å¼ä¸º PREFIX-YYYYMMDD-XXXX çš„å”¯ä¸€è®¢å•ID"""
    prefix = "PROJ"
    date_str = datetime.utcnow().strftime('%Y%m%d')
    random_part = f'{random.randint(0, 9999):04d}'
    # åœ¨å®é™…ç”Ÿäº§ä¸­ï¼Œè¿˜éœ€è¦æ£€æŸ¥IDæ˜¯å¦å·²å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™é‡æ–°ç”Ÿæˆ
    return f"{prefix}-{date_str}-{random_part}"

def create_order(order_data: order_schemas.OrderCreate, creator_id: int) -> Order:
    """
    åˆ›å»ºæ–°è®¢å•å¹¶å­˜å…¥æ•°æ®åº“
    """
    new_order = Order(
        order_uid=generate_order_uid(),
        customer_info=order_data.customer_info,
        requirements_desc=order_data.requirements_desc,
        creator_id=creator_id
    )
    db.session.add(new_order)
    db.session.commit()
    return new_order

def get_orders_for_user(user_id: int, user_role: str):
    """
    æ ¹æ®ç”¨æˆ·è§’è‰²è·å–å…¶æœ‰æƒæŸ¥çœ‹çš„è®¢å•åˆ—è¡¨
    """
    query = Order.query.order_by(Order.created_at.desc())
    
    if user_role == UserRole.SUPER_ADMIN.value or user_role == UserRole.FINANCE.value:
        return query.all()
    elif user_role == UserRole.CUSTOMER_SERVICE.value:
        return query.filter_by(creator_id=user_id).all()
    elif user_role == UserRole.DEVELOPER.value:
        return query.filter_by(developer_id=user_id).all()
    
    return [] # å…¶ä»–è§’è‰²æˆ–æ— è§’è‰²ï¼Œè¿”å›ç©ºåˆ—è¡¨

# --- ADDED: è®¢å•çŠ¶æ€æµè½¬çš„æ ¸å¿ƒé€»è¾‘ ---
# å®šä¹‰çŠ¶æ€æœº: { 'å½“å‰è§’è‰²': { 'å½“å‰çŠ¶æ€': ['å…è®¸çš„ç›®æ ‡çŠ¶æ€1', 'å…è®¸çš„ç›®æ ‡çŠ¶æ€2'] } }
# å®šä¹‰çŠ¶æ€æœº (ä¿æŒä¸å˜)
VALID_TRANSITIONS = {
    UserRole.CUSTOMER_SERVICE.value: {
        OrderStatus.PENDING_ASSIGNMENT: [OrderStatus.PENDING_PAYMENT, OrderStatus.CANCELLED],
        OrderStatus.PENDING_PAYMENT: [OrderStatus.PAID, OrderStatus.CANCELLED],
        OrderStatus.PAID: [OrderStatus.IN_DEVELOPMENT, OrderStatus.CANCELLED],
        OrderStatus.IN_DEVELOPMENT: [OrderStatus.SHIPPED, OrderStatus.CANCELLED],
        OrderStatus.SHIPPED: [OrderStatus.RECEIVED, OrderStatus.IN_DEVELOPMENT, OrderStatus.CANCELLED],
        OrderStatus.RECEIVED: [OrderStatus.IN_DEVELOPMENT, OrderStatus.CANCELLED],
    },
    UserRole.DEVELOPER.value: {
        OrderStatus.RECEIVED: [OrderStatus.PENDING_SETTLEMENT]
    },
    UserRole.FINANCE.value: {
        OrderStatus.PENDING_SETTLEMENT: [OrderStatus.VERIFIED], # å®¡æ ¸é€šè¿‡ï¼Œè§¦å‘ææˆè®¡ç®—
        OrderStatus.VERIFIED: [OrderStatus.SETTLED] # ç¡®è®¤ç»“ç®—ï¼Œé”å®šè®¢å•
    },
    UserRole.SUPER_ADMIN.value: {
        # è¶…ç®¡å¯ä»¥å–æ¶ˆä»»ä½•æœªé”å®šçŠ¶æ€çš„è®¢å• (ç®€åŒ–å¤„ç†ï¼Œèµ‹äºˆæ›´å¤§æƒé™)
        OrderStatus.PENDING_ASSIGNMENT: [OrderStatus.CANCELLED],
        OrderStatus.PENDING_PAYMENT: [OrderStatus.CANCELLED],
        OrderStatus.IN_DEVELOPMENT: [OrderStatus.CANCELLED],
        OrderStatus.SHIPPED: [OrderStatus.CANCELLED],
        OrderStatus.RECEIVED: [OrderStatus.CANCELLED],
        OrderStatus.PENDING_SETTLEMENT: [OrderStatus.CANCELLED],
    }
}

def get_order_by_id(order_id: int) -> Order | None:
    """é€šè¿‡IDè·å–è®¢å•"""
    return db.session.get(Order, order_id)

def update_order_status(order: Order, target_status: OrderStatus, user_role: str) -> Order:
    """æ›´æ–°è®¢å•çŠ¶æ€ï¼Œå†…ç½®æƒé™å’Œé€»è¾‘æ ¡éªŒ"""
    # ã€ä¿®å¤ç‚¹ã€‘æ£€æŸ¥è®¢å•æ˜¯å¦é”å®šï¼Œä½†å¯¹è¶…ç®¡è±å…
    # - if order.is_locked:
    # + æ–°çš„è±å…é€»è¾‘
    if order.is_locked and user_role != UserRole.SUPER_ADMIN.value:
        raise ValueError("Order is locked and cannot be modified.")

    current_status = order.status
    
    # ... (æƒé™å’ŒçŠ¶æ€è½¬æ¢æ ¡éªŒé€»è¾‘ä¿æŒä¸å˜) ...
    role_transitions = VALID_TRANSITIONS.get(user_role)
    if not role_transitions:
        raise PermissionError("You do not have permission to change order status.")

    allowed_statuses = role_transitions.get(current_status)
    if not allowed_statuses or target_status not in allowed_statuses:
        raise ValueError(f"Transition from {current_status.value} to {target_status.value} is not allowed for your role.")

    # æ›´æ–°çŠ¶æ€å’Œç›¸å…³æ—¶é—´æˆ³
    order.status = target_status
    if target_status == OrderStatus.SHIPPED:
        order.shipped_at = datetime.utcnow()
    
    # --- è§¦å‘é€šçŸ¥å’Œä¸šåŠ¡é€»è¾‘ ---
    if target_status == OrderStatus.PENDING_SETTLEMENT and order.developer:
        content = f"è®¢å• [{order.order_uid}] å·²è¢«æŠ€æœ¯äººå‘˜ {order.developer.full_name} ç¡®è®¤ä¸ºå¯ç»“ç®—ï¼Œè¯·å®¡æ ¸ã€‚"
        notification_service.notify_all_finances(content, order.id)

    # ã€Bug 2 ä¿®å¤ã€‘å½“è´¢åŠ¡æ ¸éªŒé€šè¿‡æ—¶ï¼Œè®¡ç®—ææˆ
    if target_status == OrderStatus.VERIFIED:
        commission_service.calculate_and_create_commissions(order)
        # å¯ä»¥é€‰æ‹©æ€§åœ°é€šçŸ¥å®¢æœå’ŒæŠ€æœ¯ææˆå·²ç”Ÿæˆ
        if order.creator:
             notification_service.create_notification(order.creator.id, f"æ‚¨çš„è®¢å• [{order.order_uid}] ææˆå·²è®¡ç®—å®Œæˆã€‚", order.id)
        if order.developer:
             notification_service.create_notification(order.developer.id, f"æ‚¨çš„è®¢å• [{order.order_uid}] ææˆå·²è®¡ç®—å®Œæˆã€‚", order.id)
            
    # ã€Bug 1 ä¿®å¤ã€‘å½“è®¢å•æœ€ç»ˆå®Œæˆæˆ–å–æ¶ˆæ—¶ï¼Œé”å®šè®¢å•
    if target_status in [OrderStatus.SETTLED, OrderStatus.CANCELLED]:
        order.is_locked = True
        
    db.session.commit()
    return order


def update_order_details_by_cs(order: Order, update_data: order_schemas.OrderUpdateByCs, user_role: str) -> Order:
    """ç”±å®¢æœæ›´æ–°è®¢å•ä¿¡æ¯ï¼ˆä»·æ ¼ã€åˆ†é…æŠ€æœ¯ï¼‰ï¼Œè¶…ç®¡ä¹Ÿå¯æ“ä½œ"""
    # + ä¼ å…¥ user_role å¹¶æ·»åŠ è±å…é€»è¾‘
    if order.is_locked and user_role != UserRole.SUPER_ADMIN.value:
        raise ValueError("Order is locked and cannot be modified.")
    
    update_dict = update_data.model_dump(exclude_unset=True)

    if 'final_price' in update_dict:
        order.final_price = update_dict['final_price']

    if 'developer_id' in update_dict and update_dict['developer_id'] != order.developer_id:
        developer_id = update_dict['developer_id']
        # è¿™é‡Œå¯ä»¥å¢åŠ ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœä¼ å…¥çš„ developer_id æ˜¯ nullï¼Œåˆ™è¡¨ç¤ºå–æ¶ˆåˆ†é…
        if developer_id:
            developer = db.session.get(User, developer_id)
            if not developer or developer.role != UserRole.DEVELOPER:
                raise ValueError("Invalid developer ID or user is not a developer.")
            
            order.developer_id = developer_id
            # ---ã€ä»»åŠ¡4.2ã€‘æ–°å¢é€šçŸ¥é€»è¾‘ ---
            content = f"æ‚¨æœ‰ä¸€ä¸ªæ–°è®¢å• [{order.order_uid}] è¢«åˆ†é…ç»™æ‚¨ï¼Œè¯·åŠæ—¶è·Ÿè¿›ã€‚"
            notification_service.create_notification(developer.id, content, order.id)
        else:
            # å¦‚æœä¼ å…¥çš„ developer_id ä¸ºç©ºï¼Œåˆ™è§†ä¸ºå–æ¶ˆåˆ†é…
            order.developer_id = None


    db.session.commit()
    return order


def set_commission_override(order: Order, override_data: order_schemas.CommissionOverrideUpdate, user_role: str) -> Order:
    """ç”±è¶…ç®¡è®¾ç½®ç‰¹æ®Šææˆ"""
    # + ä¼ å…¥ user_role å¹¶æ·»åŠ è±å…é€»è¾‘
    if order.is_locked and user_role != UserRole.SUPER_ADMIN.value:
        raise ValueError("Order is locked and cannot be modified.")
        
    current_override = order.commission_rate_override or {}
    update_dict = override_data.model_dump(exclude_unset=True)
    
    current_override.update(update_dict)
    order.commission_rate_override = current_override
    
    db.session.commit()
    return order

===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\app\services\report_service.py
========================================

# backend/app/services/report_service.py

from io import BytesIO
from datetime import datetime
from openpyxl import Workbook
from openpyxl.styles import Font, Alignment
from .. import db
from ..models.order import Order, OrderStatus
from ..models.commission import Commission
from ..models.user import UserRole

def generate_settled_orders_report(start_date_str: str, end_date_str: str) -> BytesIO:
    """
    æ ¹æ®æ—¶é—´èŒƒå›´ç”Ÿæˆå·²ç»“ç®—è®¢å•çš„ExcelæŠ¥è¡¨ã€‚
    """
    try:
        start_date = datetime.strptime(start_date_str, '%Y-%m-%d')
        # ç»“æŸæ—¥æœŸéœ€è¦åŒ…å«å½“å¤©ï¼Œæ‰€ä»¥è®¾ç½®ä¸ºå½“å¤©çš„23:59:59
        end_date = datetime.strptime(end_date_str, '%Y-%m-%d').replace(hour=23, minute=59, second=59)
    except (ValueError, TypeError):
        raise ValueError("Invalid date format. Please use YYYY-MM-DD.")

    # 1. æŸ¥è¯¢å·²ç»“ç®—çš„è®¢å•
    orders = db.session.query(Order).filter(
        Order.status == OrderStatus.SETTLED,
        Order.updated_at.between(start_date, end_date)
    ).order_by(Order.updated_at.desc()).all()

    # 2. åˆ›å»ºExcelå·¥ä½œç°¿
    workbook = Workbook()
    ws = workbook.active
    ws.title = "å·²ç»“ç®—è®¢å•æŠ¥è¡¨"

    # 3. è®¾ç½®è¡¨å¤´
    headers = [
        "è®¢å•ä¸šåŠ¡ID", "ç»“ç®—æ—¶é—´", "å®¢æˆ·å§“å", "è®¢å•é‡‘é¢", 
        "å®¢æœ", "å®¢æœææˆ", "æŠ€æœ¯", "æŠ€æœ¯ææˆ"
    ]
    ws.append(headers)
    for cell in ws[1]:
        cell.font = Font(bold=True)
        cell.alignment = Alignment(horizontal='center')

    # 4. å¡«å……æ•°æ®
    for order in orders:
        # è·å–å…³è”çš„ææˆè®°å½•
        commissions = {
            comm.role_at_time: comm.amount 
            for comm in order.commissions
        }
        
        cs_commission = commissions.get(UserRole.CUSTOMER_SERVICE.value, 0)
        dev_commission = commissions.get(UserRole.DEVELOPER.value, 0)

        row_data = [
            order.order_uid,
            order.updated_at.strftime('%Y-%m-%d %H:%M:%S'),
            order.customer_info.get('name', 'N/A'),
            order.final_price,
            order.creator.full_name if order.creator else 'N/A',
            cs_commission,
            order.developer.full_name if order.developer else 'N/A',
            dev_commission
        ]
        ws.append(row_data)

    # è°ƒæ•´åˆ—å®½ (å¯é€‰ï¼Œä½†èƒ½æå‡å¯è¯»æ€§)
    for col in ws.columns:
        max_length = 0
        column = col[0].column_letter # è·å–åˆ—çš„å­—æ¯
        for cell in col:
            try:
                if len(str(cell.value)) > max_length:
                    max_length = len(str(cell.value))
            except:
                pass
        adjusted_width = (max_length + 2)
        ws.column_dimensions[column].width = adjusted_width

    # 5. å°†å·¥ä½œç°¿ä¿å­˜åˆ°å†…å­˜ä¸­
    excel_file = BytesIO()
    workbook.save(excel_file)
    excel_file.seek(0)
    
    return excel_file

===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\app\services\user_service.py
========================================

# backend/app/services/user_service.py

import bcrypt
from .. import db
from ..models.user import User, UserRole
from ..schemas import user_schemas
import openpyxl
from io import BytesIO

# +--- æ–°å¢çš„å®Œæ•´å‡½æ•°å¼€å§‹ ---+
def batch_import_users(file_stream: BytesIO) -> dict:
    """
    ä»Excelæ–‡ä»¶æµä¸­æ‰¹é‡å¯¼å…¥ç”¨æˆ·ã€‚
    Excelæ–‡ä»¶åº”åŒ…å«è¡¨å¤´: username, password, full_name, role, gender, 
                        skills (å¤šä¸ªç”¨é€—å·åˆ†éš”), default_commission_rate, financial_account
    å…¶ä¸­ username, password, full_name, role æ˜¯å¿…éœ€çš„ã€‚
    
    :param file_stream: æ–‡ä»¶IOæµ
    :return: ä¸€ä¸ªåŒ…å«æˆåŠŸå’Œå¤±è´¥ä¿¡æ¯çš„å­—å…¸
    """
    try:
        workbook = openpyxl.load_workbook(file_stream)
        sheet = workbook.active
    except Exception as e:
        raise ValueError(f"æ— æ³•è¯»å–æˆ–è§£æExcelæ–‡ä»¶: {e}")

    header = [cell.value for cell in sheet[1]]
    required_headers = ['username', 'password', 'full_name', 'role']
    if not all(h in header for h in required_headers):
        raise ValueError(f"Excelæ–‡ä»¶è¡¨å¤´å¿…é¡»è‡³å°‘åŒ…å«: {', '.join(required_headers)}")

    results = {"success_count": 0, "failure_count": 0, "errors": []}
    
    # ä»ç¬¬äºŒè¡Œå¼€å§‹è¯»å–æ•°æ®
    for row_index in range(2, sheet.max_row + 1):
        # å°†è¡Œæ•°æ®ä¸è¡¨å¤´æ‰“åŒ…æˆå­—å…¸
        row_data = dict(zip(header, [cell.value for cell in sheet[row_index]]))
        username = row_data.get('username')

        # è·³è¿‡æ²¡æœ‰ç”¨æˆ·åçš„è¡Œ
        if not username:
            results["failure_count"] += 1
            results["errors"].append(f"ç¬¬ {row_index} è¡Œ: 'username' ä¸èƒ½ä¸ºç©ºã€‚")
            continue

        try:
            # ä½¿ç”¨Pydantic Schemaè¿›è¡Œæ•°æ®æ ¡éªŒå’Œè½¬æ¢
            user_data_dict = {
                "username": username,
                "password": str(row_data.get('password')) if row_data.get('password') else '123456', # é»˜è®¤å¯†ç 
                "full_name": row_data.get('full_name'),
                "role": UserRole(row_data.get('role')), # ä¼šè‡ªåŠ¨æ ¡éªŒè§’è‰²æšä¸¾å€¼æ˜¯å¦æœ‰æ•ˆ
                "gender": row_data.get('gender'),
                "skills": row_data.get('skills').split(',') if row_data.get('skills') and isinstance(row_data.get('skills'), str) else None,
                "default_commission_rate": row_data.get('default_commission_rate'),
                "financial_account": row_data.get('financial_account')
            }
            # æ¸…ç†Noneå€¼ï¼Œä»¥ä¾¿Pydanticä½¿ç”¨é»˜è®¤å€¼
            user_data_dict_cleaned = {k: v for k, v in user_data_dict.items() if v is not None}
            
            user_create_schema = user_schemas.UserCreate(**user_data_dict_cleaned)
            
            # è°ƒç”¨å·²æœ‰çš„åˆ›å»ºç”¨æˆ·æœåŠ¡ï¼Œå®ƒå†…éƒ¨åŒ…å«äº†å¯¹ç”¨æˆ·åæ˜¯å¦å­˜åœ¨çš„æ£€æŸ¥
            # æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ä¸ºæ¯ä¸ªç”¨æˆ·å¼€å¯ä¸€ä¸ªå­äº‹åŠ¡ï¼Œä»¥å¤„ç†å•è¡Œé”™è¯¯è€Œä¸å½±å“æ•´ä¸ªæ‰¹å¤„ç†
            try:
                db.session.begin_nested()
                create_user(user_create_schema)
                db.session.commit() # æäº¤å­äº‹åŠ¡
                results["success_count"] += 1
            except Exception as e_inner:
                db.session.rollback() # å›æ»šå­äº‹åŠ¡
                raise e_inner # é‡æ–°æŠ›å‡ºé”™è¯¯ï¼Œç”±å¤–å±‚æ•è·

        except ValueError as e: # æ•è·ç”¨æˆ·åå·²å­˜åœ¨ç­‰ä¸šåŠ¡é”™è¯¯
             results["failure_count"] += 1
             results["errors"].append(f"ç¬¬ {row_index} è¡Œ (ç”¨æˆ·: {username}): {e}")
        except Exception as e: # æ•è·å…¶ä»–æ‰€æœ‰é”™è¯¯ï¼Œå¦‚è§’è‰²åç§°æ— æ•ˆ
            results["failure_count"] += 1
            results["errors"].append(f"ç¬¬ {row_index} è¡Œ (ç”¨æˆ·: {username}): å¯¼å…¥å¤±è´¥ - {e}")
            
    return results

def get_user_by_username(username: str) -> User | None:
    return User.query.filter_by(username=username).first()

def get_user_by_id(user_id: int) -> User | None:
    return db.session.get(User, user_id)

def get_all_users() -> list[User]:
    return User.query.order_by(User.id).all()

def get_active_developers() -> list[User]:
    """è·å–æ‰€æœ‰å·²å¯ç”¨çš„æŠ€æœ¯äººå‘˜åˆ—è¡¨"""
    return User.query.filter_by(role=UserRole.DEVELOPER, is_active=True).order_by(User.id).all()

def create_user(user_data: user_schemas.UserCreate) -> User:
    """åˆ›å»ºæ–°ç”¨æˆ·"""
    if get_user_by_username(user_data.username):
        raise ValueError("Username already exists")

    hashed_password = bcrypt.hashpw(user_data.password.encode('utf-8'), bcrypt.gensalt())
    
    new_user = User(
        username=user_data.username,
        full_name=user_data.full_name,
        password_hash=hashed_password.decode('utf-8'),
        role=user_data.role,
        gender=user_data.gender,
        skills=user_data.skills,
        default_commission_rate=user_data.default_commission_rate,
        financial_account=user_data.financial_account
    )
    db.session.add(new_user)
    db.session.commit()
    return new_user

def update_user(user_id: int, update_data: user_schemas.UserUpdate) -> User:
    """æ›´æ–°ç”¨æˆ·ä¿¡æ¯"""
    user = get_user_by_id(user_id)
    if not user:
        raise ValueError("User not found")

    update_dict = update_data.model_dump(exclude_unset=True)

    if 'username' in update_dict and update_dict['username'] != user.username:
        if get_user_by_username(update_dict['username']):
            raise ValueError("Username already exists")

    for key, value in update_dict.items():
        if key == 'password':
            if value: # ç¡®ä¿å¯†ç éç©º
                hashed_password = bcrypt.hashpw(value.encode('utf-8'), bcrypt.gensalt())
                setattr(user, 'password_hash', hashed_password.decode('utf-8'))
        else:
            setattr(user, key, value)
            
    db.session.commit()
    return user

def toggle_user_status(user_id: int) -> User:
    """å¯ç”¨/ç¦ç”¨ç”¨æˆ·"""
    user = get_user_by_id(user_id)
    if not user:
        raise ValueError("User not found")
    
    user.is_active = not user.is_active
    db.session.commit()
    return user

def delete_user(user_id: int):
    """åˆ é™¤ç”¨æˆ·"""
    user = get_user_by_id(user_id)
    if not user:
        raise ValueError("User not found")

    db.session.delete(user)
    db.session.commit()

===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\app\services\work_log_service.py
========================================

# backend/app/services/work_log_service.py (æ–°å»ºæ–‡ä»¶)

from .. import db
from ..models.order import Order, WorkLog
from ..models.user import UserRole
from ..schemas import work_log_schemas

def add_work_log(order: Order, user_id: int, user_role: str, log_data: work_log_schemas.WorkLogCreate) -> WorkLog:
    """
    ä¸ºè®¢å•æ·»åŠ ä¸€æ¡æ–°çš„å·¥ä½œæ—¥å¿—ã€‚
    æ‰§è¡Œæƒé™å’Œé€»è¾‘æ ¡éªŒã€‚
    """
    # æ ¡éªŒ1: åªæœ‰æŠ€æœ¯äººå‘˜å¯ä»¥å¡«å†™æ—¥å¿—
    if user_role != UserRole.DEVELOPER.value:
        raise PermissionError("Only developers can add work logs.")

    # æ ¡éªŒ2: å¡«å†™æ—¥å¿—çš„æŠ€æœ¯å¿…é¡»æ˜¯è¯¥è®¢å•çš„è´Ÿè´£äºº
    if order.developer_id != user_id:
        raise PermissionError("You are not the developer assigned to this order.")

    # æ ¡éªŒ3: å·²é”å®šçš„è®¢å•ä¸èƒ½æ·»åŠ æ—¥å¿—
    if order.is_locked:
        raise ValueError("Cannot add work log to a locked order.")

    new_log = WorkLog(
        order_id=order.id,
        user_id=user_id,
        log_content=log_data.log_content
    )

    db.session.add(new_log)
    db.session.commit()

    return new_log

===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\app\utils\decorators.py
========================================

from functools import wraps
from flask import jsonify
from flask_jwt_extended import verify_jwt_in_request, get_jwt
from typing import Union, List  # å¯¼å…¥ Union å’Œ List ç”¨äºç±»å‹æç¤º

def role_required(required_roles: Union[str, List[str]]):
    """
    ä¸€ä¸ªè£…é¥°å™¨ï¼Œç”¨äºéªŒè¯ç”¨æˆ·æ˜¯å¦å…·æœ‰æ‰€éœ€çš„è§’è‰²ã€‚
    å®ƒæ—¢å¯ä»¥æ¥æ”¶å•ä¸ªè§’è‰²å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ¥æ”¶ä¸€ä¸ªåŒ…å«å¤šä¸ªå¯æ¥å—è§’è‰²çš„åˆ—è¡¨ã€‚
    
    :param required_roles: æ‰€éœ€çš„è§’è‰²åï¼Œæˆ–ä¸€ä¸ªåŒ…å«å¤šä¸ªè§’è‰²åçš„åˆ—è¡¨ã€‚
    """
    def decorator(fn):
        @wraps(fn)
        def wrapper(*args, **kwargs):
            # é¦–å…ˆï¼ŒéªŒè¯JWTæ˜¯å¦å­˜åœ¨ä¸”æœ‰æ•ˆ
            try:
                verify_jwt_in_request()
            except Exception as e:
                return jsonify({"msg": f"JWT verification failed: {str(e)}"}), 401

            # è·å–JWTä¸­çš„å£°æ˜
            claims = get_jwt()
            # ä» additional_claims ä¸­è·å–è§’è‰²
            user_role = claims.get("role", None)

            # å¦‚æœTokenä¸­æ²¡æœ‰è§’è‰²ä¿¡æ¯ï¼Œåˆ™æ‹’ç»è®¿é—®
            if user_role is None:
                return jsonify({"msg": "Forbidden: Role information missing in token"}), 403

            # --- æ ¸å¿ƒä¿®å¤é€»è¾‘ ---
            is_authorized = False
            if isinstance(required_roles, str):
                # æƒ…å†µä¸€ï¼šè¦æ±‚çš„æ˜¯å•ä¸ªè§’è‰²ï¼ˆå­—ç¬¦ä¸²ï¼‰
                if user_role == required_roles:
                    is_authorized = True
            elif isinstance(required_roles, list):
                # æƒ…å†µäºŒï¼šè¦æ±‚çš„æ˜¯è§’è‰²åˆ—è¡¨ä¸­çš„ä»»æ„ä¸€ä¸ª
                if user_role in required_roles:
                    is_authorized = True

            # å¦‚æœç”¨æˆ·è§’è‰²ä¸ç¬¦åˆè¦æ±‚ï¼Œåˆ™è¿”å› 403 ç¦æ­¢è®¿é—®
            if not is_authorized:
                return jsonify({"msg": "Forbidden: Insufficient permissions"}), 403
            
            # è§’è‰²åŒ¹é…ï¼Œæ‰§è¡ŒåŸå‡½æ•°
            return fn(*args, **kwargs)
        return wrapper
    return decorator

===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\migrations\alembic.ini
========================================

# A generic, single database configuration.

[alembic]
# template used to generate migration files
# file_template = %%(rev)s_%%(slug)s

# set to 'true' to run the environment during
# the 'revision' command, regardless of autogenerate
# revision_environment = false


# Logging configuration
[loggers]
keys = root,sqlalchemy,alembic,flask_migrate

[handlers]
keys = console

[formatters]
keys = generic

[logger_root]
level = WARN
handlers = console
qualname =

[logger_sqlalchemy]
level = WARN
handlers =
qualname = sqlalchemy.engine

[logger_alembic]
level = INFO
handlers =
qualname = alembic

[logger_flask_migrate]
level = INFO
handlers =
qualname = flask_migrate

[handler_console]
class = StreamHandler
args = (sys.stderr,)
level = NOTSET
formatter = generic

[formatter_generic]
format = %(levelname)-5.5s [%(name)s] %(message)s
datefmt = %H:%M:%S


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\migrations\env.py
========================================

import logging
from logging.config import fileConfig

from flask import current_app

from alembic import context

# this is the Alembic Config object, which provides
# access to the values within the .ini file in use.
config = context.config

# Interpret the config file for Python logging.
# This line sets up loggers basically.
fileConfig(config.config_file_name)
logger = logging.getLogger('alembic.env')


def get_engine():
    try:
        # this works with Flask-SQLAlchemy<3 and Alchemical
        return current_app.extensions['migrate'].db.get_engine()
    except TypeError:
        # this works with Flask-SQLAlchemy>=3
        return current_app.extensions['migrate'].db.engine


def get_engine_url():
    try:
        return get_engine().url.render_as_string(hide_password=False).replace(
            '%', '%%')
    except AttributeError:
        return str(get_engine().url).replace('%', '%%')


# add your model's MetaData object here
# for 'autogenerate' support
# from myapp import mymodel
# target_metadata = mymodel.Base.metadata
config.set_main_option('sqlalchemy.url', get_engine_url())
target_db = current_app.extensions['migrate'].db

# other values from the config, defined by the needs of env.py,
# can be acquired:
# my_important_option = config.get_main_option("my_important_option")
# ... etc.


def get_metadata():
    if hasattr(target_db, 'metadatas'):
        return target_db.metadatas[None]
    return target_db.metadata


def run_migrations_offline():
    """Run migrations in 'offline' mode.

    This configures the context with just a URL
    and not an Engine, though an Engine is acceptable
    here as well.  By skipping the Engine creation
    we don't even need a DBAPI to be available.

    Calls to context.execute() here emit the given string to the
    script output.

    """
    url = config.get_main_option("sqlalchemy.url")
    context.configure(
        url=url, target_metadata=get_metadata(), literal_binds=True
    )

    with context.begin_transaction():
        context.run_migrations()


def run_migrations_online():
    """Run migrations in 'online' mode.

    In this scenario we need to create an Engine
    and associate a connection with the context.

    """

    # this callback is used to prevent an auto-migration from being generated
    # when there are no changes to the schema
    # reference: http://alembic.zzzcomputing.com/en/latest/cookbook.html
    def process_revision_directives(context, revision, directives):
        if getattr(config.cmd_opts, 'autogenerate', False):
            script = directives[0]
            if script.upgrade_ops.is_empty():
                directives[:] = []
                logger.info('No changes in schema detected.')

    connectable = get_engine()

    with connectable.connect() as connection:
        context.configure(
            connection=connection,
            target_metadata=get_metadata(),
            process_revision_directives=process_revision_directives,
            **current_app.extensions['migrate'].configure_args
        )

        with context.begin_transaction():
            context.run_migrations()


if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\migrations\versions\10e42f6ae8cc_align_models_with_spec_and_add_.py
========================================

"""Align models with spec and add commission, notification tables

Revision ID: 10e42f6ae8cc
Revises: 1855c37dd305
Create Date: 2025-07-31 17:04:11.574908

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import mysql

# revision identifiers, used by Alembic.
revision = '10e42f6ae8cc'
down_revision = '1855c37dd305'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('commissions',
    sa.Column('id', sa.Integer(), nullable=False, comment='ææˆè®°å½•ID(ä¸»é”®)'),
    sa.Column('order_id', sa.Integer(), nullable=False, comment='å…³è”çš„è®¢å•ID'),
    sa.Column('user_id', sa.Integer(), nullable=False, comment='ææˆå½’å±çš„ç”¨æˆ·ID'),
    sa.Column('amount', sa.Numeric(precision=10, scale=2), nullable=False, comment='ææˆé‡‘é¢'),
    sa.Column('role_at_time', sa.String(length=50), nullable=False, comment='è®¡ç®—æ—¶è¯¥ç”¨æˆ·åœ¨è®¢å•ä¸­çš„è§’è‰²(å®¢æœ/æŠ€æœ¯)'),
    sa.Column('created_at', sa.DateTime(), nullable=True, comment='ææˆè®¡ç®—æ—¶é—´'),
    sa.ForeignKeyConstraint(['order_id'], ['orders.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('notifications',
    sa.Column('id', sa.Integer(), nullable=False, comment='é€šçŸ¥ID(ä¸»é”®)'),
    sa.Column('recipient_id', sa.Integer(), nullable=False, comment='æ¥æ”¶é€šçŸ¥çš„ç”¨æˆ·ID'),
    sa.Column('content', sa.String(length=255), nullable=False, comment='é€šçŸ¥å†…å®¹'),
    sa.Column('is_read', sa.Boolean(), nullable=False, comment='æ˜¯å¦å·²è¯»'),
    sa.Column('related_order_id', sa.Integer(), nullable=True, comment='(å¯é€‰)å…³è”çš„è®¢å•ID,ç”¨äºè·³è½¬'),
    sa.Column('created_at', sa.DateTime(), nullable=True, comment='é€šçŸ¥åˆ›å»ºæ—¶é—´'),
    sa.ForeignKeyConstraint(['recipient_id'], ['users.id'], ),
    sa.ForeignKeyConstraint(['related_order_id'], ['orders.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('orders', schema=None) as batch_op:
        batch_op.add_column(sa.Column('order_uid', sa.String(length=50), nullable=False, comment='ä¸šåŠ¡ID, PREFIX-YYYYMMDD-XXXX'))
        batch_op.add_column(sa.Column('commission_rate_override', mysql.JSON(), nullable=True, comment='ç‰¹æ®Šææˆæ¯”ä¾‹, å¦‚ {"cs_rate": 12.5, "tech_rate": 15.0}'))
        batch_op.add_column(sa.Column('is_locked', sa.Boolean(), nullable=False, comment='è®¢å•æ˜¯å¦é”å®š(å·²ç»“ç®—/å·²å–æ¶ˆ)'))
        batch_op.alter_column('customer_info',
               existing_type=mysql.VARCHAR(collation='utf8mb4_unicode_ci', length=500),
               type_=mysql.JSON(),
               comment='å®¢æˆ·ä¿¡æ¯, å¦‚{"name": "å¼ ä¸‰", "phone": ...}',
               existing_nullable=False)
        batch_op.alter_column('requirements_desc',
               existing_type=mysql.TEXT(collation='utf8mb4_unicode_ci'),
               comment='éœ€æ±‚æè¿°',
               existing_nullable=False)
        batch_op.alter_column('final_price',
               existing_type=mysql.FLOAT(),
               type_=sa.Numeric(precision=10, scale=2),
               comment='è®¢å•ä»·æ ¼',
               existing_nullable=True)
        batch_op.create_unique_constraint(None, ['order_uid'])
        batch_op.drop_column('initial_budget')
        batch_op.drop_column('special_commission_rate')

    with op.batch_alter_table('users', schema=None) as batch_op:
        batch_op.add_column(sa.Column('skills', mysql.JSON(), nullable=True, comment='æ“…é•¿é¢†åŸŸ(ä¸ºæŠ€æœ¯è§’è‰²)'))
        batch_op.alter_column('default_commission_rate',
               existing_type=mysql.FLOAT(),
               type_=sa.Numeric(precision=5, scale=2),
               comment='é»˜è®¤ææˆæ¯”ä¾‹,å¦‚10.00(%)',
               existing_nullable=True)
        batch_op.alter_column('financial_account',
               existing_type=mysql.VARCHAR(collation='utf8mb4_unicode_ci', length=255),
               comment='è´¢åŠ¡è´¦å·(é“¶è¡Œå¡/æ”¯ä»˜å®)',
               existing_nullable=True)
        batch_op.drop_column('specialized_field')

    with op.batch_alter_table('work_logs', schema=None) as batch_op:
        batch_op.add_column(sa.Column('created_at', sa.DateTime(), nullable=True))
        batch_op.add_column(sa.Column('user_id', sa.Integer(), nullable=False, comment='å¡«å†™æ—¥å¿—çš„æŠ€æœ¯äººå‘˜ID'))
        batch_op.drop_constraint(batch_op.f('work_logs_ibfk_1'), type_='foreignkey')
        batch_op.create_foreign_key(None, 'users', ['user_id'], ['id'])
        batch_op.drop_column('log_date')
        batch_op.drop_column('developer_id')

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('work_logs', schema=None) as batch_op:
        batch_op.add_column(sa.Column('developer_id', mysql.INTEGER(), autoincrement=False, nullable=False))
        batch_op.add_column(sa.Column('log_date', sa.DATE(), nullable=False))
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.create_foreign_key(batch_op.f('work_logs_ibfk_1'), 'users', ['developer_id'], ['id'])
        batch_op.drop_column('user_id')
        batch_op.drop_column('created_at')

    with op.batch_alter_table('users', schema=None) as batch_op:
        batch_op.add_column(sa.Column('specialized_field', mysql.VARCHAR(collation='utf8mb4_unicode_ci', length=255), nullable=True))
        batch_op.alter_column('financial_account',
               existing_type=mysql.VARCHAR(collation='utf8mb4_unicode_ci', length=255),
               comment=None,
               existing_comment='è´¢åŠ¡è´¦å·(é“¶è¡Œå¡/æ”¯ä»˜å®)',
               existing_nullable=True)
        batch_op.alter_column('default_commission_rate',
               existing_type=sa.Numeric(precision=5, scale=2),
               type_=mysql.FLOAT(),
               comment=None,
               existing_comment='é»˜è®¤ææˆæ¯”ä¾‹,å¦‚10.00(%)',
               existing_nullable=True)
        batch_op.drop_column('skills')

    with op.batch_alter_table('orders', schema=None) as batch_op:
        batch_op.add_column(sa.Column('special_commission_rate', mysql.FLOAT(), nullable=True))
        batch_op.add_column(sa.Column('initial_budget', mysql.FLOAT(), nullable=True))
        batch_op.drop_constraint(None, type_='unique')
        batch_op.alter_column('final_price',
               existing_type=sa.Numeric(precision=10, scale=2),
               type_=mysql.FLOAT(),
               comment=None,
               existing_comment='è®¢å•ä»·æ ¼',
               existing_nullable=True)
        batch_op.alter_column('requirements_desc',
               existing_type=mysql.TEXT(collation='utf8mb4_unicode_ci'),
               comment=None,
               existing_comment='éœ€æ±‚æè¿°',
               existing_nullable=False)
        batch_op.alter_column('customer_info',
               existing_type=mysql.JSON(),
               type_=mysql.VARCHAR(collation='utf8mb4_unicode_ci', length=500),
               comment=None,
               existing_comment='å®¢æˆ·ä¿¡æ¯, å¦‚{"name": "å¼ ä¸‰", "phone": ...}',
               existing_nullable=False)
        batch_op.drop_column('is_locked')
        batch_op.drop_column('commission_rate_override')
        batch_op.drop_column('order_uid')

    op.drop_table('notifications')
    op.drop_table('commissions')
    # ### end Alembic commands ###


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\migrations\versions\1855c37dd305_add_orders_and_work_logs_tables.py
========================================

"""add orders and work_logs tables

Revision ID: 1855c37dd305
Revises: ea16599a186c
Create Date: 2025-07-13 15:31:11.495459

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = '1855c37dd305'
down_revision = 'ea16599a186c'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('orders',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('customer_info', sa.String(length=500), nullable=False),
    sa.Column('requirements_desc', sa.Text(), nullable=False),
    sa.Column('initial_budget', sa.Float(), nullable=True),
    sa.Column('final_price', sa.Float(), nullable=True),
    sa.Column('status', sa.Enum('PENDING_ASSIGNMENT', 'PENDING_PAYMENT', 'IN_DEVELOPMENT', 'SHIPPED', 'RECEIVED', 'PENDING_SETTLEMENT', 'VERIFIED', 'SETTLED', 'CANCELLED', name='orderstatus'), nullable=False),
    sa.Column('creator_id', sa.Integer(), nullable=False),
    sa.Column('developer_id', sa.Integer(), nullable=True),
    sa.Column('special_commission_rate', sa.Float(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.Column('shipped_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['creator_id'], ['users.id'], ),
    sa.ForeignKeyConstraint(['developer_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('work_logs',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('log_content', sa.Text(), nullable=False),
    sa.Column('log_date', sa.Date(), nullable=False),
    sa.Column('order_id', sa.Integer(), nullable=False),
    sa.Column('developer_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['developer_id'], ['users.id'], ),
    sa.ForeignKeyConstraint(['order_id'], ['orders.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table('work_logs')
    op.drop_table('orders')
    # ### end Alembic commands ###


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: backend\migrations\versions\ea16599a186c_initial_migration_with_user_table.py
========================================

"""Initial migration with User table

Revision ID: ea16599a186c
Revises: 
Create Date: 2025-07-12 08:46:30.382590

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = 'ea16599a186c'
down_revision = None
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('users',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('username', sa.String(length=80), nullable=False),
    sa.Column('password_hash', sa.String(length=128), nullable=False),
    sa.Column('full_name', sa.String(length=100), nullable=True),
    sa.Column('role', sa.Enum('SUPER_ADMIN', 'CUSTOMER_SERVICE', 'DEVELOPER', 'FINANCE', name='userrole'), nullable=False),
    sa.Column('gender', sa.String(length=10), nullable=True),
    sa.Column('specialized_field', sa.String(length=255), nullable=True),
    sa.Column('default_commission_rate', sa.Float(), nullable=True),
    sa.Column('financial_account', sa.String(length=255), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('username')
    )
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table('users')
    # ### end Alembic commands ###


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\.gitignore
========================================

# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
.DS_Store
dist
dist-ssr
coverage
*.local

/cypress/videos/
/cypress/screenshots/

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?

*.tsbuildinfo


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\.prettierrc.json
========================================

{
  "$schema": "https://json.schemastore.org/prettierrc",
  "semi": false,
  "singleQuote": true,
  "printWidth": 100
}


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\README.md
========================================

# frontend

This template should help get you started developing with Vue 3 in Vite.

## Recommended IDE Setup

[VSCode](https://code.visualstudio.com/) + [Volar](https://marketplace.visualstudio.com/items?itemName=Vue.volar) (and disable Vetur).

## Type Support for `.vue` Imports in TS

TypeScript cannot handle type information for `.vue` imports by default, so we replace the `tsc` CLI with `vue-tsc` for type checking. In editors, we need [Volar](https://marketplace.visualstudio.com/items?itemName=Vue.volar) to make the TypeScript language service aware of `.vue` types.

## Customize configuration

See [Vite Configuration Reference](https://vite.dev/config/).

## Project Setup

```sh
npm install
```

### Compile and Hot-Reload for Development

```sh
npm run dev
```

### Type-Check, Compile and Minify for Production

```sh
npm run build
```

### Lint with [ESLint](https://eslint.org/)

```sh
npm run lint
```


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\env.d.ts
========================================

/// <reference types="vite/client" />


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\eslint.config.ts
========================================

import { globalIgnores } from 'eslint/config'
import { defineConfigWithVueTs, vueTsConfigs } from '@vue/eslint-config-typescript'
import pluginVue from 'eslint-plugin-vue'
import skipFormatting from '@vue/eslint-config-prettier/skip-formatting'

// To allow more languages other than `ts` in `.vue` files, uncomment the following lines:
// import { configureVueProject } from '@vue/eslint-config-typescript'
// configureVueProject({ scriptLangs: ['ts', 'tsx'] })
// More info at https://github.com/vuejs/eslint-config-typescript/#advanced-setup

export default defineConfigWithVueTs(
  {
    name: 'app/files-to-lint',
    files: ['**/*.{ts,mts,tsx,vue}'],
  },

  globalIgnores(['**/dist/**', '**/dist-ssr/**', '**/coverage/**']),

  pluginVue.configs['flat/essential'],
  vueTsConfigs.recommended,
  skipFormatting,
)


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\index.html
========================================

<!DOCTYPE html>
<html lang="">
  <head>
    <meta charset="UTF-8">
    <link rel="icon" href="/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vite App</title>
  </head>
  <body>
    <div id="app"></div>
    <script type="module" src="/src/main.ts"></script>
  </body>
</html>


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\nginx.conf
========================================

server {
    listen 80;
    server_name localhost;

    # ç½‘ç«™æ ¹ç›®å½•
    root /usr/share/nginx/html;
    index index.html index.htm;

    # å¯¹æ‰€æœ‰URLè¿›è¡Œå¤„ç†
    location / {
        # å°è¯•æŸ¥æ‰¾å¯¹åº”çš„æ–‡ä»¶ï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™å›é€€åˆ° index.html
        # è¿™ä½¿å¾—Vue Routerçš„historyæ¨¡å¼èƒ½å¤Ÿæ­£å¸¸å·¥ä½œ
        try_files $uri $uri/ /index.html;
    }

    # å¯ä»¥æ·»åŠ å¯¹APIçš„åå‘ä»£ç†ï¼Œä½†ä¸ºäº†å¼€å‘åˆæœŸå‰åç«¯è§£è€¦ï¼Œæˆ‘ä»¬æš‚æ—¶ä¸é…ç½®
    # location /api/ {
    #     proxy_pass http://backend:5000;
    # }
}

===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\package.json
========================================

{
  "name": "frontend",
  "version": "0.0.0",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "run-p type-check \"build-only {@}\" --",
    "preview": "vite preview",
    "build-only": "vite build",
    "type-check": "vue-tsc --noEmit -p tsconfig.app.json",
    "lint": "eslint . --fix",
    "format": "prettier --write src/"
  },
  "dependencies": {
    "@ant-design/icons-vue": "^7.0.1",
    "ant-design-vue": "^4.2.6",
    "axios": "^1.10.0",
    "echarts": "^5.5.1",
    "pinia": "^3.0.3",
    "vue-echarts": "^6.7.3",
    "vue-router": "^4.5.1"
  },
  "devDependencies": {
    "@tsconfig/node18": "^18.2.4",
    "@types/node": "^18.19.3",
    "@vitejs/plugin-vue": "^5.0.5",
    "@vue/eslint-config-prettier": "^8.0.0",
    "@vue/eslint-config-typescript": "^12.0.0",
    "@vue/tsconfig": "^0.5.1",
    "eslint": "^8.57.0",
    "eslint-plugin-vue": "^9.23.0",
    "npm-run-all2": "^6.2.0",
    "prettier": "^3.2.5",
    "typescript": "~5.4.0",
    "vite": "^5.3.1",
    "vite-plugin-vue-devtools": "^7.7.7",
    "vue-tsc": "^2.0.21"
  },
  "overrides": {
    "vue": "^3.4.0"
  }
}

===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\tsconfig.app.json
========================================

{
  "extends": "@vue/tsconfig/tsconfig.dom.json",
  "include": ["env.d.ts", "src/**/*", "src/**/*.vue"],
  "exclude": ["src/**/__tests__/*"],
  "compilerOptions": {
    "composite": true,
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  }
}


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\tsconfig.json
========================================

{
  "files": [],
  "references": [
    {
      "path": "./tsconfig.node.json"
    },
    {
      "path": "./tsconfig.app.json"
    }
  ]
}


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\tsconfig.node.json
========================================

{
  "extends": "@tsconfig/node18/tsconfig.json",
  "include": [
    "vite.config.*",
    "vitest.config.*",
    "cypress.config.*",
    "nightwatch.conf.*",
    "playwright.config.*",
    "eslint.config.*"
  ],
  "compilerOptions": {
    "incremental": true, // <-- æ·»åŠ è¿™ä¸€è¡Œ
    "noEmit": true,
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",

    "module": "ESNext",
    "moduleResolution": "Bundler",
    "types": ["node"]
  }
}


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\vite.config.ts
========================================

// frontend/vite.config.ts

import { fileURLToPath, URL } from 'node:url'

import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import vueDevTools from 'vite-plugin-vue-devtools'

// https://vite.dev/config/
export default defineConfig({
  plugins: [
    vue(),
    vueDevTools(),
  ],
  resolve: {
    alias: {
      '@': fileURLToPath(new URL('./src', import.meta.url))
    }
  },

  // =========== æ–°å¢æœåŠ¡å™¨é…ç½® ===========
  server: {
    // ç›‘å¬æ‰€æœ‰ç½‘ç»œåœ°å€ï¼Œè¿™å¯¹äºåœ¨Dockerä¸­æš´éœ²æœåŠ¡è‡³å…³é‡è¦
    host: true,
    // æˆ‘ä»¬å°†å¼€å‘æœåŠ¡å™¨çš„ç«¯å£å›ºå®šä¸º 8080
    port: 8080,
    // ç¡®ä¿çƒ­æ¨¡å—æ›¿æ¢ (HMR) æ˜¯å¼€å¯çš„
    hmr: true,
    // è¿™æ˜¯è§£å†³çƒ­æ›´æ–°é—®é¢˜çš„æ ¸å¿ƒï¼šä½¿ç”¨è½®è¯¢æ–¹å¼æ¥æ£€æµ‹æ–‡ä»¶å˜åŠ¨
    watch: {
      usePolling: true,
    },
  },
  // =========== æ–°å¢é…ç½®ç»“æŸ ===========
})


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\App.vue
========================================

<script setup lang="ts">
import { RouterView } from 'vue-router';
</script>

<template>
  <RouterView />
</template>

<style>

</style>


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\main.ts
========================================

import './assets/main.css'

import { createApp } from 'vue'
import { createPinia } from 'pinia'
import Antd from 'ant-design-vue'
import 'ant-design-vue/dist/reset.css' // Antd v4çš„æ ·å¼é‡ç½®

import App from './App.vue'
import router from './router'

const app = createApp(App)

app.use(createPinia())
app.use(router)
app.use(Antd) // æ³¨å†ŒAntd

app.mount('#app')


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\assets\base.css
========================================

/* color palette from <https://github.com/vuejs/theme> */
:root {
  --vt-c-white: #ffffff;
  --vt-c-white-soft: #f8f8f8;
  --vt-c-white-mute: #f2f2f2;

  --vt-c-black: #181818;
  --vt-c-black-soft: #222222;
  --vt-c-black-mute: #282828;

  --vt-c-indigo: #2c3e50;

  --vt-c-divider-light-1: rgba(60, 60, 60, 0.29);
  --vt-c-divider-light-2: rgba(60, 60, 60, 0.12);
  --vt-c-divider-dark-1: rgba(84, 84, 84, 0.65);
  --vt-c-divider-dark-2: rgba(84, 84, 84, 0.48);

  --vt-c-text-light-1: var(--vt-c-indigo);
  --vt-c-text-light-2: rgba(60, 60, 60, 0.66);
  --vt-c-text-dark-1: var(--vt-c-white);
  --vt-c-text-dark-2: rgba(235, 235, 235, 0.64);
}

/* semantic color variables for this project */
:root {
  --color-background: var(--vt-c-white);
  --color-background-soft: var(--vt-c-white-soft);
  --color-background-mute: var(--vt-c-white-mute);

  --color-border: var(--vt-c-divider-light-2);
  --color-border-hover: var(--vt-c-divider-light-1);

  --color-heading: var(--vt-c-text-light-1);
  --color-text: var(--vt-c-text-light-1);

  --section-gap: 160px;
}

@media (prefers-color-scheme: dark) {
  :root {
    --color-background: var(--vt-c-black);
    --color-background-soft: var(--vt-c-black-soft);
    --color-background-mute: var(--vt-c-black-mute);

    --color-border: var(--vt-c-divider-dark-2);
    --color-border-hover: var(--vt-c-divider-dark-1);

    --color-heading: var(--vt-c-text-dark-1);
    --color-text: var(--vt-c-text-dark-2);
  }
}

*,
*::before,
*::after {
  box-sizing: border-box;
  margin: 0;
  font-weight: normal;
}

body {
  min-height: 100vh;
  color: var(--color-text);
  background: var(--color-background);
  transition:
    color 0.5s,
    background-color 0.5s;
  line-height: 1.6;
  font-family:
    Inter,
    -apple-system,
    BlinkMacSystemFont,
    'Segoe UI',
    Roboto,
    Oxygen,
    Ubuntu,
    Cantarell,
    'Fira Sans',
    'Droid Sans',
    'Helvetica Neue',
    sans-serif;
  font-size: 15px;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\assets\logo.svg
========================================

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 261.76 226.69"><path d="M161.096.001l-30.225 52.351L100.647.001H-.005l130.877 226.688L261.749.001z" fill="#41b883"/><path d="M161.096.001l-30.225 52.351L100.647.001H52.346l78.526 136.01L209.398.001z" fill="#34495e"/></svg>


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\assets\main.css
========================================

/* frontend/src/assets/main.css */

@import './base.css';

/* ç§»é™¤æ‰€æœ‰å†…å®¹ï¼Œå› ä¸ºé»˜è®¤çš„æ ·å¼ä¸é€‚åˆåå°ç³»ç»Ÿ */
/* æˆ‘ä»¬å°†åœ¨ MainLayout.vue å’Œå…·ä½“é¡µé¢ä¸­å®šä¹‰æ‰€éœ€æ ·å¼ */

/* å¦‚æœ base.css ä¸­æœ‰å¯¹ #app çš„å®½åº¦é™åˆ¶ï¼Œä¹Ÿéœ€è¦ç§»é™¤ */
/* æ£€æŸ¥ base.cssï¼Œç¡®ä¿ body å’Œ #app å¯ä»¥æ’‘æ»¡å…¨å± */
/* é»˜è®¤çš„ vite + vue æ¨¡æ¿ï¼Œä¸»è¦ä¿®æ”¹ç‚¹åœ¨æœ¬æ–‡ä»¶ */

#app {
  height: 100vh;
  width: 100vw;
}

/* ç§»é™¤ Vite æ¨¡æ¿é»˜è®¤çš„å±…ä¸­å’Œå†…è¾¹è·æ ·å¼ */
@media (min-width: 1024px) {
  body {
    display: block; /* è¦†ç›– flex */
    place-items: normal; /* è¦†ç›– center */
  }

  /* ç§»é™¤å†…è¾¹è·ï¼Œè®©å¸ƒå±€ç»„ä»¶å®Œå…¨æ§åˆ¶é¡µé¢ */
  /* #app åœ¨ä¸Šé¢å·²ç»è®¾ç½®äº†100%å®½é«˜ï¼Œè¿™é‡Œä¸å†éœ€è¦é¢å¤–æ ·å¼ */
}


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\components\NotificationCenter.vue
========================================

<template>
  <a-drawer
    :visible="visible"
    title="é€šçŸ¥ä¸­å¿ƒ"
    placement="right"
    @close="$emit('close')"
    :width="400"
  >
    <a-list item-layout="horizontal" :data-source="notificationStore.notifications">
      <template #renderItem="{ item }">
        <a-list-item
          :class="{ 'notification-read': item.is_read }"
          @click="handleItemClick(item)"
        >
          <a-list-item-meta :description="item.content">
            <template #title>
              <a-badge :dot="!item.is_read" status="processing" />
              <span> è®¢å•ç›¸å…³é€šçŸ¥</span>
            </template>
          </a-list-item-meta>
          <div class="notification-time">{{ formatTime(item.created_at) }}</div>
        </a-list-item>
      </template>

      <template #header v-if="notificationStore.notifications.length > 0">
        <div style="text-align: right;">
            </div>
      </template>

      <template #loadMore>
        <div v-if="notificationStore.notifications.length === 0" style="text-align: center; margin-top: 20px;">
          <a-empty description="æš‚æ— é€šçŸ¥" />
        </div>
      </template>
    </a-list>
  </a-drawer>
</template>

<script setup lang="ts">
import {
  Drawer as ADrawer,
  List as AList,
  ListItem as AListItem,
  ListItemMeta as AListItemMeta,
  Badge as ABadge,
  Empty as AEmpty,
} from 'ant-design-vue'
import { useNotificationStore } from '@/stores/notifications'
import { useRouter } from 'vue-router'
import type { Notification } from '@/services/types'

defineProps<{
  visible: boolean
}>()

const emit = defineEmits(['close'])

const notificationStore = useNotificationStore()
const router = useRouter()

const formatTime = (timeStr: string) => {
    // ç®€å•çš„ç›¸å¯¹æ—¶é—´æ ¼å¼åŒ–
    const seconds = Math.floor((new Date().getTime() - new Date(timeStr).getTime()) / 1000)
    let interval = seconds / 31536000
    if (interval > 1) return Math.floor(interval) + " å¹´å‰"
    interval = seconds / 2592000
    if (interval > 1) return Math.floor(interval) + " ä¸ªæœˆå‰"
    interval = seconds / 86400
    if (interval > 1) return Math.floor(interval) + " å¤©å‰"
    interval = seconds / 3600
    if (interval > 1) return Math.floor(interval) + " å°æ—¶å‰"
    interval = seconds / 60
    if (interval > 1) return Math.floor(interval) + " åˆ†é’Ÿå‰"
    return "åˆšåˆš"
}

const handleItemClick = async (item: Notification) => { // 1. å°†å‡½æ•°å£°æ˜ä¸º async
  // é¦–å…ˆï¼Œå¤„ç†çŠ¶æ€æ›´æ–°ï¼Œå¹¶ç­‰å¾…å®ƒå®Œæˆ
  if (!item.is_read) {
    // 2. ä½¿ç”¨ await ç­‰å¾… store ä¸­çš„å¼‚æ­¥æ“ä½œæ‰§è¡Œå®Œæ¯•
    await notificationStore.markOneAsRead(item.id);
  }

  // ç°åœ¨ï¼Œæœ¬åœ°çŠ¶æ€ä¿è¯å·²ç»æ›´æ–°ï¼ŒUIä¹Ÿå·²ç»é‡æ–°æ¸²æŸ“ï¼ˆå°è“ç‚¹æ¶ˆå¤±ï¼‰
  // æ­¤æ—¶å†æ‰§è¡Œé¡µé¢è·³è½¬
  if (item.related_order_id) {
    router.push(`/orders/${item.related_order_id}`);
    emit('close'); // å…³é—­æŠ½å±‰
  }
};

</script>

<style scoped>
.notification-read {
  color: #888;
  background-color: #f7f7f7;
}
.notification-time {
    font-size: 12px;
    color: #aaa;
    margin-left: 16px;
}
.ant-list-item {
    cursor: pointer;
    transition: background-color 0.3s;
}
.ant-list-item:hover {
    background-color: #e6f7ff;
}
</style>


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\components\admin\UserForm.vue
========================================

<template>
  <a-modal
    :open="open"
    :title="isEditMode ? 'ç¼–è¾‘ç”¨æˆ·' : 'æ–°å¢ç”¨æˆ·'"
    @update:open="$emit('update:open', $event)"
    @ok="handleOk"
    :confirm-loading="saving"
  >
    <a-form :model="formState" ref="formRef" layout="vertical" :rules="rules">
      <a-form-item label="ç”¨æˆ·å" name="username">
        <a-input v-model:value="formState.username" />
      </a-form-item>
      <a-form-item label="å§“å" name="full_name">
        <a-input v-model:value="formState.full_name" />
      </a-form-item>
      <a-form-item label="å¯†ç " :name="isEditMode ? 'password_optional' : 'password'">
        <a-input-password
          v-model:value="formState.password"
          :placeholder="isEditMode ? 'ç•™ç©ºåˆ™ä¸ä¿®æ”¹å¯†ç ' : ''"
        />
      </a-form-item>
      <a-form-item label="è§’è‰²" name="role">
        <a-select v-model:value="formState.role" :options="roleOptions" />
      </a-form-item>

      <a-form-item label="æ“…é•¿é¢†åŸŸ (æŠ€æœ¯è§’è‰²)" name="skills">
        <a-select
          v-model:value="formState.skills"
          mode="tags"
          style="width: 100%"
          placeholder="è¾“å…¥æŠ€èƒ½åæŒ‰å›è½¦ç¡®è®¤, å¦‚ Java, UIè®¾è®¡"
        />
      </a-form-item>

      <a-form-item label="è´¢åŠ¡è´¦å·" name="financial_account">
        <a-input v-model:value="formState.financial_account" />
      </a-form-item>
    </a-form>
  </a-modal>
</template>

<script setup lang="ts">
import { ref, reactive, watch, computed } from 'vue';
import {
  Modal as AModal,
  Form as AForm,
  FormItem as AFormItem,
  Input as AInput,
  InputPassword as AInputPassword,
  Select as ASelect,
  message,
} from 'ant-design-vue';
import type { FormInstance, FormProps } from 'ant-design-vue';
import { userService } from '@/services/userService';
// å¯¼å…¥ UserCreationData ç±»å‹ï¼Œç”¨äºç±»å‹æ–­è¨€
import { UserRole, type User, type UserCreationData } from '@/services/types';

const props = defineProps<{
  open: boolean
  user: User | null
}>()

const emit = defineEmits(['save', 'update:open'])

const formRef = ref<FormInstance>()
// ã€é”™è¯¯ä¸€ ä¿®å¤ã€‘formState çš„ç±»å‹å®šä¹‰ä¸­å·²ç»éšå¼åŒ…å«äº† User ç±»å‹çš„ skills å±æ€§
const formState = reactive<Partial<User & { password?: string }>>({})
const saving = ref(false)

const isEditMode = computed(() => !!props.user?.id)

const rules: FormProps['rules'] = {
  username: [{ required: true, message: 'è¯·è¾“å…¥ç”¨æˆ·å' }],
  role: [{ required: true, message: 'è¯·é€‰æ‹©è§’è‰²' }],
  password: [{ required: !isEditMode.value, message: 'è¯·è¾“å…¥å¯†ç ', min: 6 }],
  password_optional: [{ required: false, min: 6, message: 'å¯†ç è‡³å°‘ä¸º6ä½' }],
}

const roleOptions = Object.values(UserRole).map((role) => ({
  value: role,
  label: role,
}))

watch(
  () => props.open,
  (isOpen) => {
    if (isOpen) {
      if (props.user) {
        // ç¼–è¾‘æ¨¡å¼ï¼šè¿™é‡Œä¼šæ­£ç¡®åœ°å°† user.skills èµ‹å€¼ç»™ formState.skills
        Object.assign(formState, props.user)
        delete formState.password
      } else {
        // æ–°å¢æ¨¡å¼ï¼šæ¸…ç©º formState
        Object.keys(formState).forEach((key) => delete (formState as any)[key])
        formState.role = UserRole.DEVELOPER
        formState.skills = [] // åˆå§‹åŒ–ä¸ºç©ºæ•°ç»„
      }
    } else {
      formRef.value?.resetFields()
    }
  },
)

const handleOk = async () => {
  try {
    await formRef.value?.validate()
    saving.value = true

    if (isEditMode.value && props.user) {
      const payload = { ...formState }
      if (!payload.password) {
        delete payload.password
      }
      await userService.updateUser(props.user.id, payload)
      message.success('ç”¨æˆ·æ›´æ–°æˆåŠŸ')
    } else {
      // ã€é”™è¯¯äºŒ ä¿®å¤ã€‘
      // åœ¨è°ƒç”¨ createUser ä¹‹å‰ï¼Œå°† formState æ–­è¨€ä¸º UserCreationData ç±»å‹
      // å› ä¸ºæ­¤æ—¶è¡¨å•éªŒè¯å·²é€šè¿‡ï¼Œå¯ä»¥ç¡®ä¿ password æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ string
      await userService.createUser(formState as UserCreationData);
      message.success('ç”¨æˆ·åˆ›å»ºæˆåŠŸ')
    }
    emit('save')
  } catch (error: any) {
    const errorMsg = error.response?.data?.msg || (isEditMode.value ? 'æ›´æ–°å¤±è´¥' : 'åˆ›å»ºå¤±è´¥')
    message.error(errorMsg)
    console.error(error)
  } finally {
    saving.value = false
  }
}
</script>


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\components\admin\UserTable.vue
========================================

<template>
  <a-table :columns="columns" :data-source="users" :loading="loading" row-key="id">
    <template #bodyCell="{ column, record }">
      <template v-if="column.key === 'role'">
        <a-tag :color="getRoleColor(record.role)">{{ record.role }}</a-tag>
      </template>
      <template v-if="column.key === 'is_active'">
        <a-tag :color="record.is_active ? 'green' : 'red'">
          {{ record.is_active ? 'å¯ç”¨' : 'ç¦ç”¨' }}
        </a-tag>
      </template>
      <template v-if="column.key === 'action'">
        <a-space>
          <a-button type="link" @click="$emit('edit', record)">ç¼–è¾‘</a-button>
          <a-button type="link" @click="$emit('toggle-status', record)">
            {{ record.is_active ? 'ç¦ç”¨' : 'å¯ç”¨' }}
          </a-button>
          <a-button type="link" danger @click="$emit('delete', record.id)">åˆ é™¤</a-button>
        </a-space>
      </template>
    </template>
  </a-table>
</template>

<script setup lang="ts">
import { Table as ATable, Tag as ATag, Space as ASpace, Button as AButton } from 'ant-design-vue'
import type { User, UserRole } from '@/services/types'

defineProps<{
  users: User[]
  loading: boolean
}>()

defineEmits(['edit', 'delete', 'toggle-status'])

const columns = [
  { title: 'ID', dataIndex: 'id', key: 'id', sorter: (a: User, b: User) => a.id - b.id },
  { title: 'ç”¨æˆ·å', dataIndex: 'username', key: 'username' },
  { title: 'å§“å', dataIndex: 'full_name', key: 'full_name' },
  { title: 'è§’è‰²', dataIndex: 'role', key: 'role' },
  { title: 'çŠ¶æ€', dataIndex: 'is_active', key: 'is_active' },
  { title: 'æ“ä½œ', key: 'action' },
]

const getRoleColor = (role: UserRole) => {
  const colors: Record<UserRole, string> = {
    SUPER_ADMIN: 'gold',
    CUSTOMER_SERVICE: 'blue',
    DEVELOPER: 'geekblue',
    FINANCE: 'purple',
  }
  return colors[role] || 'default'
}
</script>


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\components\orders\AddWorkLogForm.vue
========================================

<template>
  <a-card title="æ·»åŠ å·¥ä½œæ—¥å¿—">
    <a-form :model="logFormState" layout="vertical" @finish="handleLogSubmit" ref="formRef">
      <a-form-item label="æ—¥å¿—å†…å®¹" name="log_content" :rules="[{ required: true, message: 'æ—¥å¿—å†…å®¹ä¸èƒ½ä¸ºç©º' }]">
        <a-textarea v-model:value="logFormState.log_content" :rows="4" placeholder="è¯·å¡«å†™å·¥ä½œè¿›å±•..." />
      </a-form-item>
      <a-form-item>
        <a-button type="primary" html-type="submit" :loading="isLogSubmitting">æäº¤æ—¥å¿—</a-button>
      </a-form-item>
    </a-form>
  </a-card>
</template>

<script setup lang="ts">
import { reactive, ref } from 'vue';
import { orderService } from '@/services/orderService';
import { message, Card as ACard, Form as AForm, FormItem as AFormItem, Textarea as ATextarea, Button as AButton } from 'ant-design-vue';
import type { FormInstance } from 'ant-design-vue';

const props = defineProps({
  orderId: {
    type: Number,
    required: true
  }
});

const emit = defineEmits(['log-added']);

const formRef = ref<FormInstance>();
const logFormState = reactive({ log_content: '' });
const isLogSubmitting = ref(false);

const handleLogSubmit = async () => {
  isLogSubmitting.value = true;
  try {
    await orderService.addWorkLog(props.orderId, { log_content: logFormState.log_content });
    message.success('å·¥ä½œæ—¥å¿—æäº¤æˆåŠŸ');
    logFormState.log_content = ''; // é‡ç½®è¡¨å•
    formRef.value?.clearValidate();
    emit('log-added'); // é€šçŸ¥çˆ¶ç»„ä»¶åˆ·æ–°æ•°æ®
  } catch (error: any) {
    message.error(error.response?.data?.msg || 'æ—¥å¿—æäº¤å¤±è´¥');
  } finally {
    isLogSubmitting.value = false;
  }
};
</script>


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\components\orders\CommissionInfoCard.vue
========================================

<template>
  <a-card v-if="myCommissionAmount !== null" title="æˆ‘çš„æœ¬å•ææˆ" size="small">
    <a-statistic
      :value="myCommissionAmount"
      :precision="2"
      suffix="å…ƒ"
      :value-style="{ color: '#3f8600', fontSize: '24px' }"
    >
      <template #prefix>
        <TrophyOutlined />
      </template>
    </a-statistic>
    <div style="color: #888; font-size: 12px; margin-top: 8px;">
      * ææˆåœ¨è®¢å•çŠ¶æ€å˜ä¸ºâ€œå·²æ ¸éªŒâ€åç”Ÿæˆ
    </div>
  </a-card>
</template>

<script setup lang="ts">
import { computed, type PropType } from 'vue';
import { useAuthStore } from '@/stores/auth';
import { type Order, OrderStatus } from '@/services/types';
import { TrophyOutlined } from '@ant-design/icons-vue';
import { Card as ACard, Statistic as AStatistic } from 'ant-design-vue';

const props = defineProps({
  // æ¥æ”¶å®Œæ•´çš„è®¢å•å¯¹è±¡ä½œä¸º prop
  order: {
    type: Object as PropType<Order>,
    required: true
  }
});

const authStore = useAuthStore();
// ä» Pinia store ä¸­è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„ID
const currentUserId = computed(() => (authStore.user?.sub ? parseInt(authStore.user.sub, 10) : null));

// æ ¸å¿ƒè®¡ç®—å±æ€§ï¼šå†³å®šæ˜¯å¦æ˜¾ç¤ºä»¥åŠæ˜¾ç¤ºå¤šå°‘é‡‘é¢
const myCommissionAmount = computed(() => {
  // 1. æ£€æŸ¥è®¢å•çŠ¶æ€æ˜¯å¦å·²ç»è¿‡äº†ææˆè®¡ç®—èŠ‚ç‚¹
  if (![OrderStatus.VERIFIED, OrderStatus.SETTLED].includes(props.order.status)) {
    return null; // çŠ¶æ€ä¸ç¬¦ï¼Œä¸æ˜¾ç¤º
  }

  // 2. æ£€æŸ¥å½“å‰ç”¨æˆ·IDæ˜¯å¦å­˜åœ¨
  if (currentUserId.value === null) {
      return null;
  }

  // 3. åœ¨è®¢å•çš„ commissions æ•°ç»„ä¸­æŸ¥æ‰¾å±äºå½“å‰ç”¨æˆ·çš„ææˆè®°å½•
  const myCommissionRecord = props.order.commissions.find(
    commission => commission.user_id === currentUserId.value
  );

  // 4. å¦‚æœæ‰¾åˆ°äº†ï¼Œè¿”å›ææˆé‡‘é¢ï¼›å¦åˆ™è¿”å›null
  return myCommissionRecord ? myCommissionRecord.amount : null;
});
</script>


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\components\orders\FinanceSummaryCard.vue
========================================

<template>
  <a-card title="è´¢åŠ¡ç»“ç®—æ‘˜è¦" :bordered="false" style="background-color: #fafafa;">
    <a-descriptions :column="1" layout="horizontal" bordered size="small">

      <a-descriptions-item label="è®¢å•æ€»é‡‘é¢">
        <span style="font-weight: bold; color: #d48806;">{{ order.final_price ?? 'N/A' }} å…ƒ</span>
      </a-descriptions-item>

      <a-descriptions-item :label="`å®¢æœææˆ (${order.creator.full_name})`">
        <span style="font-weight: bold; color: #3f8600;">{{ cs_commission?.amount ?? 0 }} å…ƒ</span>
      </a-descriptions-item>
      <a-descriptions-item label="å®¢æœæ”¶æ¬¾è´¦å·">
        <div v-if="order.creator?.financial_account">
          <CopyOutlined @click="copyToClipboard(order.creator.financial_account)" style="cursor: pointer; color: #1890ff; margin-right: 8px;" />
          <span>{{ order.creator.financial_account }}</span>
        </div>
        <a-tag v-else color="warning">æœªæä¾›</a-tag>
      </a-descriptions-item>

      <template v-if="order.developer">
        <a-descriptions-item :label="`æŠ€æœ¯ææˆ (${order.developer.full_name})`">
           <span style="font-weight: bold; color: #3f8600;">{{ tech_commission?.amount ?? 0 }} å…ƒ</span>
        </a-descriptions-item>
        <a-descriptions-item label="æŠ€æœ¯æ”¶æ¬¾è´¦å·">
          <div v-if="order.developer.financial_account">
            <CopyOutlined @click="copyToClipboard(order.developer.financial_account)" style="cursor: pointer; color: #1890ff; margin-right: 8px;" />
            <span>{{ order.developer.financial_account }}</span>
          </div>
          <a-tag v-else color="warning">æœªæä¾›</a-tag>
        </a-descriptions-item>
      </template>

    </a-descriptions>
  </a-card>
</template>

<script setup lang="ts">
import { computed, type PropType } from 'vue';
import { type Order, type Commission, UserRole } from '@/services/types';
import { Card as ACard, Descriptions as ADescriptions, DescriptionsItem as ADescriptionsItem, Tag as ATag, message } from 'ant-design-vue';
import { CopyOutlined } from '@ant-design/icons-vue';

const props = defineProps({
  order: {
    type: Object as PropType<Order>,
    required: true
  }
});

// è®¡ç®—å®¢æœçš„ææˆè®°å½•
const cs_commission = computed<Commission | undefined>(() => {
  return props.order.commissions.find(c => c.role_at_time === UserRole.CUSTOMER_SERVICE);
});

// è®¡ç®—æŠ€æœ¯çš„ææˆè®°å½•
const tech_commission = computed<Commission | undefined>(() => {
  return props.order.commissions.find(c => c.role_at_time === UserRole.DEVELOPER);
});

// å®ç°ç‚¹å‡»å¤åˆ¶åˆ°å‰ªè´´æ¿åŠŸèƒ½
const copyToClipboard = async (text: string) => {
  try {
    await navigator.clipboard.writeText(text);
    message.success('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
  } catch (err) {
    message.error('å¤åˆ¶å¤±è´¥');
  }
};
</script>


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\components\orders\OrderActionPanel.vue
========================================

<template>
  <div class="sidebar">
    <template v-if="order">
      <finance-summary-card
        v-if="actions.isFinance.value && [OrderStatus.PENDING_SETTLEMENT, OrderStatus.VERIFIED].includes(order.status)"
        :order="order"
        style="margin-bottom: 16px;"
      />


      <a-card v-if="!order.is_locked || actions.isSuperAdmin.value" title="ä¸‹ä¸€æ­¥æ“ä½œ">
        <a-space direction="vertical" style="width: 100%">
          <div v-if="actions.isCS.value && !order.is_locked">
            <a-button v-if="order.status === OrderStatus.PENDING_ASSIGNMENT" @click="emit('update-status', OrderStatus.PENDING_PAYMENT)" type="primary" block>æ›´æ–°ä¸º [å¾…ä»˜æ¬¾]</a-button>
            <a-button v-if="order.status === OrderStatus.PENDING_PAYMENT" @click="emit('update-status', OrderStatus.PAID)" type="primary" block>ç¡®è®¤æ”¶æ¬¾ (è¿›å…¥å·²ä»˜æ¬¾)</a-button>
            <a-button v-if="order.status === OrderStatus.PAID" @click="emit('update-status', OrderStatus.IN_DEVELOPMENT)" type="primary" block>åˆ†é…æŠ€æœ¯/å¼€å§‹å¼€å‘</a-button>
            <a-button v-if="order.status === OrderStatus.IN_DEVELOPMENT" @click="emit('update-status', OrderStatus.SHIPPED)" type="primary" block>æ›´æ–°ä¸º [å·²å‘è´§]</a-button>
            <a-button v-if="order.status === OrderStatus.SHIPPED" @click="emit('update-status', OrderStatus.RECEIVED)" type="primary" block>ç¡®è®¤ [å·²æ”¶è´§]</a-button>
          </div>

          <div v-if="actions.isFinance.value">
            <a-button v-if="order.status === OrderStatus.PENDING_SETTLEMENT" @click="emit('update-status', OrderStatus.VERIFIED)" type="primary" block>å®¡æ ¸é€šè¿‡ (è¿›å…¥å·²æ ¸éªŒ)</a-button>
            <a-button v-if="order.status === OrderStatus.VERIFIED" @click="emit('update-status', OrderStatus.SETTLED)" type="primary" block style="background-color: #52c41a; border-color: #52c41a;">ç¡®è®¤ç»“ç®— (å®Œæˆè®¢å•)</a-button>
          </div>

          <a-divider>å…¶ä»–æ“ä½œ</a-divider>
          <a-button v-if="actions.isCS.value" @click="emit('open-price-modal')" block>ä¿®æ”¹ä»·æ ¼</a-button>
          <a-button v-if="actions.isCS.value" @click="emit('open-assign-modal')" block>åˆ†é…/ä¿®æ”¹æŠ€æœ¯è´Ÿè´£äºº</a-button>
          <a-button v-if="actions.canSetSpecialCommission.value" @click="emit('open-commission-modal')" block danger>è®¾ç½®ç‰¹æ®Šææˆ</a-button>
        </a-space>
      </a-card>

      <a-card v-if="order.is_locked && !actions.isSuperAdmin.value" title="è®¢å•å·²é”å®š">
        <a-alert message="æ­¤è®¢å•å·²ç»“ç®—æˆ–å·²å–æ¶ˆï¼Œæ— æ³•è¿›è¡Œä»»ä½•æ“ä½œã€‚" type="warning" show-icon />
      </a-card>

      <add-work-log-form
        v-if="actions.canAddWorkLog.value"
        :order-id="order.id"
        @log-added="emit('reload-order')"
        style="margin-top: 16px"
      />
    </template>
  </div>
</template>

<script setup lang="ts">
import { computed, type PropType } from 'vue';
import { useOrderActions } from '@/composables/useOrderActions';
import { type Order, OrderStatus } from '@/services/types';
import AddWorkLogForm from './AddWorkLogForm.vue';
import FinanceSummaryCard from './FinanceSummaryCard.vue';
import { Card as ACard, Space as ASpace, Button as AButton, Divider as ADivider, Alert as AAlert } from 'ant-design-vue';

const props = defineProps({
  order: {
    type: Object as PropType<Order | null>,
    required: true
  }
});

const emit = defineEmits(['update-status', 'open-price-modal', 'open-assign-modal', 'reload-order', 'open-commission-modal']);

const actions = useOrderActions(computed(() => props.order));
</script>

<style scoped>
.sidebar {
  display: flex;
  flex-direction: column;
  gap: 16px;
}
</style>


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\components\orders\OrderInfoCard.vue
========================================

<template>
  <a-card title="è®¢å•ä¿¡æ¯">
    <a-descriptions v-if="order" bordered :column="2">
      <a-descriptions-item label="ä¸šåŠ¡ID">{{ order.order_uid }}</a-descriptions-item>
      <a-descriptions-item label="è®¢å•çŠ¶æ€">
        <a-tag :color="getStatusColor(order.status)">{{ order.status }}</a-tag>
      </a-descriptions-item>
      <a-descriptions-item label="å®¢æˆ·å§“å">{{ order.customer_info.name }}</a-descriptions-item>
      <a-descriptions-item label="è”ç³»æ–¹å¼">{{ order.customer_info.phone }}</a-descriptions-item>
      <a-descriptions-item label="æœ€ç»ˆä»·æ ¼">{{ order.final_price ?? 'æœªå®šä»·' }} å…ƒ</a-descriptions-item>
      <a-descriptions-item label="åˆ›å»ºäºº(å®¢æœ)">{{ order.creator.full_name }}</a-descriptions-item>
      <a-descriptions-item label="è´Ÿè´£äºº(æŠ€æœ¯)">{{ order.developer?.full_name ?? 'æœªåˆ†é…' }}</a-descriptions-item>
      <a-descriptions-item label="åˆ›å»ºæ—¶é—´">{{ new Date(order.created_at).toLocaleString() }}</a-descriptions-item>
      <a-descriptions-item label="éœ€æ±‚æè¿°" :span="2">{{ order.requirements_desc }}</a-descriptions-item>
    </a-descriptions>
  </a-card>
</template>

<script setup lang="ts">
import { type PropType } from 'vue'
import { type Order, OrderStatus } from '@/services/types'
import { Card as ACard, Descriptions as ADescriptions, DescriptionsItem as ADescriptionsItem, Tag as ATag } from 'ant-design-vue'

defineProps({
  order: {
    type: Object as PropType<Order | null>,
    required: true
  }
})

const getStatusColor = (status: OrderStatus) => {
  const colorMap: Record<OrderStatus, string> = {
    [OrderStatus.PENDING_ASSIGNMENT]: 'orange',
    [OrderStatus.PENDING_PAYMENT]: 'gold',
    [OrderStatus.PAID]: 'purple',
    [OrderStatus.IN_DEVELOPMENT]: 'processing',
    [OrderStatus.SHIPPED]: 'blue',
    [OrderStatus.RECEIVED]: 'cyan',
    [OrderStatus.PENDING_SETTLEMENT]: 'purple',
    [OrderStatus.VERIFIED]: 'lime',
    [OrderStatus.SETTLED]: 'success',
    [OrderStatus.CANCELLED]: 'default',
  };
  return colorMap[status] || 'default';
};
</script>


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\components\orders\WorkLogTimeline.vue
========================================

<template>
  <a-card title="å·¥ä½œæ—¥å¿—">
    <a-timeline v-if="logs.length > 0">
      <a-timeline-item v-for="log in logs" :key="log.id">
        <p><strong>{{ log.developer.full_name }}</strong></p>
        <p>{{ log.log_content }}</p>
        <p style="color: #888; font-size: 12px">{{ new Date(log.created_at).toLocaleString() }}</p>
      </a-timeline-item>
    </a-timeline>
    <a-empty v-else description="æš‚æ— å·¥ä½œæ—¥å¿—" />
  </a-card>
</template>

<script setup lang="ts">
import type { PropType } from 'vue'
import type { WorkLog } from '@/services/types'
import { Card as ACard, Timeline as ATimeline, TimelineItem as ATimelineItem, Empty as AEmpty } from 'ant-design-vue'

defineProps({
  logs: {
    type: Array as PropType<WorkLog[]>,
    required: true
  }
})
</script>


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\composables\useOrderActions.ts
========================================

import { computed, type Ref } from 'vue'
import { useAuthStore } from '@/stores/auth'
import { type Order, OrderStatus, UserRole } from '@/services/types'

/**
 * å°è£…è®¢å•è¯¦æƒ…é¡µä¸­çš„æ‰€æœ‰æ“ä½œé€»è¾‘å’Œæƒé™åˆ¤æ–­
 * @param order - ä¸€ä¸ªåŒ…å«è®¢å•ä¿¡æ¯çš„ Ref å¯¹è±¡
 */
export function useOrderActions(order: Ref<Order | null>) {
  const authStore = useAuthStore()
  const userRole = computed(() => authStore.userRole)
  const currentUserId = computed(() => (authStore.user?.sub ? parseInt(authStore.user.sub, 10) : null))

  // --- è§’è‰²åˆ¤æ–­ ---
  const isCS = computed(() => userRole.value === UserRole.CUSTOMER_SERVICE)
  const isTech = computed(() => userRole.value === UserRole.DEVELOPER)
  const isFinance = computed(() => userRole.value === UserRole.FINANCE)
  const isSuperAdmin = computed(() => userRole.value === UserRole.SUPER_ADMIN)
  const isAssignedDeveloper = computed(() => order.value?.developer?.id === currentUserId.value)

  // + æ–°å¢ï¼šåˆ¤æ–­æ˜¯å¦å¯ä»¥è®¾ç½®ç‰¹æ®Šææˆ
  const canSetSpecialCommission = computed(() => {
    return isSuperAdmin.value && !!order.value;
  });

  // --- æƒé™è®¡ç®—å±æ€§ ---
  const canCancelOrder = computed(() => {
    if (!order.value) return false;
    // + å¦‚æœæ˜¯è¶…ç®¡ï¼Œåˆ™å¿½ç•¥é”å®šçŠ¶æ€
    if (isSuperAdmin.value) return ![OrderStatus.SETTLED, OrderStatus.CANCELLED].includes(order.value.status);
    // å¯¹å…¶ä»–è§’è‰²ï¼Œä¿æŒåŸæœ‰é€»è¾‘
    if (!isCS.value) return false;
    return !order.value.is_locked && ![OrderStatus.SETTLED, OrderStatus.CANCELLED].includes(order.value.status);
  });

  const canRevertToDev = computed(() => {
    if (!order.value) return false;
    // + å¦‚æœæ˜¯è¶…ç®¡ï¼Œåˆ™å¿½ç•¥é”å®šçŠ¶æ€
    if (isSuperAdmin.value) return [OrderStatus.SHIPPED, OrderStatus.RECEIVED].includes(order.value.status);
    // å¯¹å…¶ä»–è§’è‰²ï¼Œä¿æŒåŸæœ‰é€»è¾‘
    if (!isCS.value) return false;
    return !order.value.is_locked && [OrderStatus.SHIPPED, OrderStatus.RECEIVED].includes(order.value.status);
  });


  const canSettleByTech = computed(() => {
    return isTech.value && isAssignedDeveloper.value && order.value?.status === OrderStatus.RECEIVED
  })

  const canAddWorkLog = computed(() => {
      return isAssignedDeveloper.value && !order.value?.is_locked
  })

  // --- è¿”å›æ‰€æœ‰rè®¡ç®—å±æ€§å’Œæ–¹æ³• ---
  return {
    // è§’è‰²
    isCS,
    isTech,
    isFinance,
    isSuperAdmin,
    isAssignedDeveloper,

    // æƒé™
    canCancelOrder,
    canRevertToDev,
    canSettleByTech,
    canAddWorkLog,
    canSetSpecialCommission,
  }
}


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\layouts\MainLayout.vue
========================================

<template>
  <a-layout style="min-height: 100vh">
    <a-layout-sider v-model:collapsed="collapsed" collapsible theme="dark">
      <div class="logo">
        <img src="@/assets/logo.svg" alt="logo" />
        <h1 v-if="!collapsed">ç®¡ç†ç³»ç»Ÿ</h1>
      </div>
      <a-menu v-model:selectedKeys="selectedKeys" theme="dark" mode="inline">
        <a-menu-item key="/">
          <router-link to="/">
            <pie-chart-outlined />
            <span>é¦–é¡µ</span>
          </router-link>
        </a-menu-item>

        <a-menu-item key="/orders" v-if="allowedOrderRoles.includes(authStore.userRole)">
          <router-link to="/orders">
            <shopping-cart-outlined />
            <span>è®¢å•ç®¡ç†</span>
          </router-link>
        </a-menu-item>

        <a-menu-item key="/finance/reports" v-if="['FINANCE', 'SUPER_ADMIN'].includes(authStore.userRole)">
          <router-link to="/finance/reports">
            <line-chart-outlined />
            <span>è´¢åŠ¡æŠ¥è¡¨</span>
          </router-link>
        </a-menu-item>

        <a-menu-item key="/admin/user-management" v-if="authStore.userRole === 'SUPER_ADMIN'">
          <router-link to="/admin/user-management">
            <team-outlined />
            <span>ç”¨æˆ·ç®¡ç†</span>
          </router-link>
        </a-menu-item>
      </a-menu>
    </a-layout-sider>

    <a-layout>
      <a-layout-header class="header">
        <div class="header-left">
          <a-breadcrumb>
            <a-breadcrumb-item>
              <router-link to="/">ä¸»é¡µ</router-link>
            </a-breadcrumb-item>
            <a-breadcrumb-item v-if="$route.meta.title">{{ $route.meta.title }}</a-breadcrumb-item>
          </a-breadcrumb>
        </div>
        <div class="header-right">
          <a-space :size="20">
            <a-badge :count="notificationStore.unreadCount">
              <bell-outlined style="font-size: 18px; cursor: pointer" @click="showDrawer" />
            </a-badge>
            <a-dropdown>
              <a class="ant-dropdown-link" @click.prevent>
                <a-avatar size="small" style="background-color: #1677ff; margin-right: 8px">
                  {{ authStore.user?.full_name?.charAt(0) || 'U' }}
                </a-avatar>
                ä½ å¥½, {{ authStore.user?.full_name || authStore.user?.username }}
                <down-outlined />
              </a>
              <template #overlay>
                <a-menu>
                  <a-menu-item @click="authStore.logout()">
                    <logout-outlined />
                    ç™»å‡ºç³»ç»Ÿ
                  </a-menu-item>
                </a-menu>
              </template>
            </a-dropdown>
          </a-space>
        </div>
      </a-layout-header>

      <a-layout-content class="content">
      <router-view v-slot="{ Component, route }">
        <transition name="fade" mode="out-in">
          <component :is="Component" :key="route.path" />
        </transition>
      </router-view>
    </a-layout-content>
    </a-layout>
  </a-layout>

  <notification-center :visible="drawerVisible" @close="drawerVisible = false" />
</template>

<script setup lang="ts">
import { ref, computed, watch } from 'vue';
import { useRoute, useRouter } from 'vue-router';
import { useAuthStore } from '@/stores/auth';
import { useNotificationStore } from '@/stores/notifications';
import NotificationCenter from '@/components/NotificationCenter.vue';
import {
  PieChartOutlined,
  ShoppingCartOutlined,
  LineChartOutlined,
  TeamOutlined,
  BellOutlined,
  DownOutlined,
  LogoutOutlined
} from '@ant-design/icons-vue';

const collapsed = ref<boolean>(false);
const route = useRoute();
const authStore = useAuthStore();
const notificationStore = useNotificationStore();

const allowedOrderRoles = ['SUPER_ADMIN', 'CUSTOMER_SERVICE', 'DEVELOPER', 'FINANCE'];

// æ ¹æ®è·¯ç”±è·¯å¾„åŠ¨æ€è®¡ç®—é€‰ä¸­çš„èœå•é¡¹
const selectedKeys = computed(() => {
  const path = route.path;
  if (path.startsWith('/orders')) return ['/orders'];
  if (path.startsWith('/admin')) return ['/admin/user-management'];
  if (path.startsWith('/finance')) return ['/finance/reports'];
  return [path];
});


// é€šçŸ¥ä¸­å¿ƒæŠ½å±‰é€»è¾‘
const drawerVisible = ref(false);
const showDrawer = () => {
  notificationStore.fetchNotifications();
  drawerVisible.value = true;
};

// ç›‘å¬ç™»å½•çŠ¶æ€è·å–é€šçŸ¥
watch(
  () => authStore.isAuthenticated,
  (isAuth) => {
    if (isAuth) {
      notificationStore.fetchNotifications();
    }
  },
  { immediate: true }
);
</script>

<style scoped>
.logo {
  height: 32px;
  margin: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  overflow: hidden;
}

.logo img {
  height: 32px;
  width: 32px;
}

.logo h1 {
  color: white;
  font-size: 18px;
  font-weight: 600;
  margin: 0;
  white-space: nowrap;
}

.header {
  background: #fff;
  padding: 0 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header-right {
  display: flex;
  align-items: center;
}

.content {
  margin: 24px;
  background: #f0f2f5; /* è¿™æ˜¯å†…å®¹åŒºçš„èƒŒæ™¯è‰² */
  padding: 24px;
  background: #fff; /* å†…å®¹åŒºé‡Œçš„ router-view èƒŒæ™¯æ˜¯ç™½è‰² */
  min-height: 280px;
}

.ant-layout-content {
    background-color: #f0f2f5;
    padding: 24px;
}
.ant-layout-content .router-view-content {
    background: #fff;
    padding: 24px;
    min-height: calc(100vh - 64px - 48px);
}

/* é¡µé¢åˆ‡æ¢åŠ¨ç”» */
.fade-enter-active,
.fade-leave-active {
  transition: opacity 0.2s ease;
}

.fade-enter-from,
.fade-leave-to {
  opacity: 0;
}
</style>


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\router\index.ts
========================================

// frontend/src/router/index.ts

import { createRouter, createWebHistory } from 'vue-router'
import type { RouteRecordRaw } from 'vue-router'
import { UserRole } from '@/services/types'
import { useAuthStore } from '@/stores/auth'
// å¼•å…¥æ–°å¸ƒå±€ç»„ä»¶
import MainLayout from '@/layouts/MainLayout.vue'
import LoginView from '../views/LoginView.vue'
import HomeView from '../views/HomeView.vue'
import UserManagementView from '../views/admin/UserManagementView.vue'
import OrderListView from '../views/orders/OrderListView.vue'
import CreateOrderView from '../views/orders/CreateOrderView.vue'
import OrderDetailView from '../views/orders/OrderDetailView.vue'
import FinanceReportView from '../views/finance/FinanceReportView.vue'

const routes: Array<RouteRecordRaw> = [
  {
    path: '/login',
    name: 'login',
    component: LoginView,
  },
  {
    // ä¸»å¸ƒå±€è·¯ç”±
    path: '/',
    component: MainLayout,
    meta: { requiresAuth: true },
    redirect: '/home', // é»˜è®¤é‡å®šå‘åˆ°é¦–é¡µ
    children: [
      {
        path: '/home', // ä½¿ç”¨ /home è€Œä¸æ˜¯ /
        name: 'home',
        component: HomeView,
        meta: { title: 'é¦–é¡µä»ªè¡¨ç›˜' }
      },
      {
        path: '/admin/user-management',
        name: 'user-management',
        component: UserManagementView,
        meta: { requiredRole: UserRole.SUPER_ADMIN, title: 'ç”¨æˆ·ç®¡ç†' }
      },
      {
        path: '/orders',
        name: 'order-list',
        component: OrderListView,
        meta: {
          requiredRole: [UserRole.CUSTOMER_SERVICE, UserRole.SUPER_ADMIN, UserRole.FINANCE, UserRole.DEVELOPER],
          title: 'è®¢å•åˆ—è¡¨'
        }
      },
      {
        path: '/orders/new',
        name: 'create-order',
        component: CreateOrderView,
        meta: { requiredRole: UserRole.CUSTOMER_SERVICE, title: 'åˆ›å»ºè®¢å•' }
      },
      {
        path: '/orders/:id',
        name: 'order-detail',
        component: OrderDetailView,
        props: true,
        meta: {
          requiredRole: [UserRole.CUSTOMER_SERVICE, UserRole.SUPER_ADMIN, UserRole.FINANCE, UserRole.DEVELOPER],
          title: 'è®¢å•è¯¦æƒ…'
        }
      },
      {
        path: '/finance/reports',
        name: 'finance-reports',
        component: FinanceReportView,
        meta: { requiredRole: [UserRole.FINANCE, UserRole.SUPER_ADMIN], title: 'è´¢åŠ¡æŠ¥è¡¨' }
      }
    ]
  },
  // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ä¸€ä¸ª404é¡µé¢
  // { path: '/:pathMatch(.*)*', name: 'NotFound', component: NotFoundView }
]

const router = createRouter({
  history: createWebHistory(import.meta.env.BASE_URL),
  routes,
})

// å…¨å±€å‰ç½®å®ˆå« (é€»è¾‘ä¿æŒä¸å˜, ä½†ç°åœ¨æ›´å¼ºå¤§äº†)
router.beforeEach((to, from, next) => {
  const authStore = useAuthStore()

  const targetRequiresAuth = to.matched.some(record => record.meta.requiresAuth);
  // è·å–æœ€å†…å±‚è·¯ç”±çš„è§’è‰²è¦æ±‚
  const targetRequiredRoles = to.meta.requiredRole as string | string[] | undefined

  if (targetRequiresAuth && !authStore.isAuthenticated) {
    next({ name: 'login', query: { redirect: to.fullPath } })
  } else if (to.name === 'login' && authStore.isAuthenticated) {
    next({ name: 'home' })
  } else if (targetRequiredRoles) {
    const userRole = authStore.userRole
    const hasPermission = Array.isArray(targetRequiredRoles)
      ? targetRequiredRoles.includes(userRole)
      : userRole === targetRequiredRoles

    if (!hasPermission) {
      // å¯ä»¥è·³è½¬åˆ°æ— æƒé™é¡µé¢æˆ–é¦–é¡µ
      next({ name: 'home' })
    } else {
      next()
    }
  } else {
    next()
  }
})

export default router


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\services\api.ts
========================================

import axios from 'axios'
import { useAuthStore } from '@/stores/auth'

const apiClient = axios.create({
  baseURL: 'http://localhost:5000/api', // ä¿®æ”¹ä¸ºæœ¬åœ° Flask æœåŠ¡çš„é»˜è®¤åœ°å€
  headers: {
    'Content-Type': 'application/json',
  },
})

// è¯·æ±‚æ‹¦æˆªå™¨ï¼šåœ¨æ¯ä¸ªè¯·æ±‚å‰éƒ½é™„åŠ ä¸ŠToken
apiClient.interceptors.request.use((config) => {
  const authStore = useAuthStore()
  const token = authStore.token
  if (token) {
    config.headers.Authorization = `Bearer ${token}`
  }
  return config
})

// --- å“åº”æ‹¦æˆªå™¨ (æ–°å¢ä»£ç ) ---
// åœ¨æ”¶åˆ°å“åº”åè¿›è¡Œå¤„ç†
apiClient.interceptors.response.use(
  // å¯¹äºæˆåŠŸçš„å“åº” (2xx çŠ¶æ€ç )ï¼Œç›´æ¥è¿”å›
  (response) => response,

  // å¯¹äºå¤±è´¥çš„å“åº” (é 2xx çŠ¶æ€ç )ï¼Œè¿›è¡Œå¤„ç†
  (error) => {
    // æ£€æŸ¥æ˜¯å¦æ˜¯ 401 Unauthorized é”™è¯¯
    if (error.response && error.response.status === 401) {
      // å¦‚æœæ˜¯ 401 é”™è¯¯ï¼Œè¯´æ˜ token æ— æ•ˆæˆ–å·²è¿‡æœŸ
      const authStore = useAuthStore()
      console.error('Authentication Error: Token is invalid or expired. Logging out.')
      // è°ƒç”¨ logout æ–¹æ³•ï¼Œå®ƒä¼šæ¸…ç©ºæœ¬åœ°å­˜å‚¨å¹¶è·³è½¬åˆ°ç™»å½•é¡µ
      authStore.logout()
    }
    // å°†é”™è¯¯ç»§ç»­æŠ›å‡ºï¼Œä»¥ä¾¿ç»„ä»¶ä¸­çš„ .catch() å¯ä»¥æ•è·åˆ°
    return Promise.reject(error)
  }
)

export default apiClient


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\services\dashboardService.ts
========================================

// frontend/src/services/dashboardService.ts

import apiClient from './api'

// å®šä¹‰ä¸ªäººä»ªè¡¨ç›˜æ•°æ®çš„æ¥å£
export interface PersonalDashboardStats {
  monthly_orders_created?: number;
  monthly_orders_completed?: number;
  total_commission_earned: number;
}

// å®šä¹‰å…¨å±€ä»ªè¡¨ç›˜æ•°æ®çš„æ¥å£
export interface GlobalDashboardStats {
  total_users: number;
  total_orders: number;
  total_settled_value: number;
  status_distribution: { [key: string]: number };
}

export interface PerformanceData {
  full_name: string;
  total_value: number;
}

export interface TeamPerformanceStats {
  customer_service_performance: PerformanceData[];
  developer_performance: PerformanceData[];
}


export const dashboardService = {
  /**
   * è·å–ä¸ªäººä¸šç»©æ•°æ® (å®¢æœ/æŠ€æœ¯)
   */
  getPersonalDashboard(): Promise<PersonalDashboardStats> {
    return apiClient.get('/v1/dashboard/personal').then((res) => res.data)
  },

  /**
   * è·å–å…¨å±€ç»Ÿè®¡æ•°æ® (è¶…ç®¡)
   */
  getGlobalDashboard(): Promise<GlobalDashboardStats> {
    return apiClient.get('/v1/dashboard/global').then((res) => res.data)
  },
  /**
   * è·å–å›¢é˜Ÿç»©æ•ˆç»Ÿè®¡æ•°æ® (è¶…ç®¡)
   */
  getTeamPerformance(): Promise<TeamPerformanceStats> {
    return apiClient.get('/v1/dashboard/team-performance').then((res) => res.data);
  },

}



===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\services\notificationService.ts
========================================

// frontend/src/services/notificationService.ts (æ–°å»ºæ–‡ä»¶)

import apiClient from './api'
import type { Notification } from './types' // ç¡®ä¿ä½ çš„ types.ts æ–‡ä»¶å¯¼å‡ºäº† Notification ç±»å‹

export const notificationService = {
  /**
   * è·å–å½“å‰ç”¨æˆ·çš„æ‰€æœ‰é€šçŸ¥
   */
  getNotifications(): Promise<Notification[]> {
    return apiClient.get('/notifications/').then((res) => res.data)
  },

  /**
   * å°†å•æ¡é€šçŸ¥æ ‡è®°ä¸ºå·²è¯»
   * @param notificationId è¦æ ‡è®°çš„é€šçŸ¥ID
   */
  markAsRead(notificationId: number): Promise<Notification> {
    return apiClient.post(`/notifications/${notificationId}/read`).then((res) => res.data)
  }
}


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\services\orderService.ts
========================================

// frontend/src/services/orderService.ts

import apiClient from './api'
import type { Order, OrderStatus, WorkLog } from './types'

type OrderCreationData = Partial<Order> & {
  customer_info: object
  requirements_desc: string
}

// + æ–°å¢ï¼šå®šä¹‰ç‰¹æ®Šææˆçš„æ•°æ®ç»“æ„
type CommissionOverrideData = {
  cs_rate?: number;
  tech_rate?: number;
}

// --- ADDED: å®šä¹‰å®¢æœå¯æ›´æ–°çš„æ•°æ®ç±»å‹ ---
type OrderUpdateData = {
  final_price?: number
  developer_id?: number
}

// ---ã€ä»»åŠ¡ 4.1ã€‘æ–°å¢ç”¨äºåˆ›å»ºå·¥ä½œæ—¥å¿—çš„ç±»å‹ ---
type WorkLogCreationData = {
  log_content: string
}

export const orderService = {
  getOrders(): Promise<Order[]> {
    return apiClient.get('/orders/').then((res) => res.data)
  },

  createOrder(orderData: OrderCreationData): Promise<Order> {
    return apiClient.post('/orders/', orderData).then((res) => res.data)
  },

  /**
   * (è¶…ç®¡)ä¸ºè®¢å•è®¾ç½®ç‰¹æ®Šçš„ææˆæ¯”ä¾‹
   * @param orderId è®¢å•ID
   * @param data åŒ…å«å®¢æœå’ŒæŠ€æœ¯ææˆæ¯”ä¾‹çš„å¯¹è±¡
   */
  setCommissionOverride(orderId: number, data: CommissionOverrideData): Promise<void> {
    return apiClient.post(`/orders/${orderId}/commission-override`, data).then(res => res.data);
  },

  // --- ADDED: è·å–å•ä¸ªè®¢å•è¯¦æƒ… ---
  getOrderById(id: number): Promise<Order> {
    return apiClient.get(`/orders/${id}`).then((res) => res.data)
  },

  // --- ADDED: æ›´æ–°è®¢å•çŠ¶æ€ ---
  updateOrderStatus(id: number, status: OrderStatus): Promise<{ message: string }> {
    return apiClient.post(`/orders/${id}/status`, { status }).then((res) => res.data)
  },

  // --- ADDED: å®¢æœæ›´æ–°è®¢å•ä¿¡æ¯ ---
  updateOrderDetails(id: number, data: OrderUpdateData): Promise<Order> {
    return apiClient.patch(`/orders/${id}`, data).then((res) => res.data)
  },
  // ---ã€ä»»åŠ¡ 4.1ã€‘æ–°å¢è°ƒç”¨å·¥ä½œæ—¥å¿—APIçš„æ–¹æ³• ---
  addWorkLog(orderId: number, data: WorkLogCreationData): Promise<WorkLog> {
    return apiClient.post(`/orders/${orderId}/work_logs`, data).then((res) => res.data)
  }
}


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\services\reportService.ts
========================================

// frontend/src/services/reportService.ts

import apiClient from './api'

// ä¸€ä¸ªå¸®åŠ©å‡½æ•°ï¼Œç”¨äºå¤„ç†ä»APIè¿”å›çš„Blobæ•°æ®å¹¶è§¦å‘æµè§ˆå™¨ä¸‹è½½
function downloadFile(blob: Blob, filename: string) {
  // åˆ›å»ºä¸€ä¸ªæŒ‡å‘Blobçš„URL
  const url = window.URL.createObjectURL(blob);
  // åˆ›å»ºä¸€ä¸ªéšè—çš„<a>æ ‡ç­¾
  const link = document.createElement('a');
  link.href = url;
  link.setAttribute('download', filename);
  // å°†<a>æ ‡ç­¾æ·»åŠ åˆ°é¡µé¢ï¼Œæ¨¡æ‹Ÿç‚¹å‡»ï¼Œç„¶åç§»é™¤
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  // é‡Šæ”¾URLå¯¹è±¡
  window.URL.revokeObjectURL(url);
}

export const reportService = {
  /**
   * ä¸‹è½½å·²ç»“ç®—è®¢å•çš„ExcelæŠ¥è¡¨
   * @param startDate å¼€å§‹æ—¥æœŸ 'YYYY-MM-DD'
   * @param endDate ç»“æŸæ—¥æœŸ 'YYYY-MM-DD'
   */
  async downloadSettledOrdersReport(startDate: string, endDate: string): Promise<void> {
    const response = await apiClient.get('/v1/reports/settled-orders', {
      params: {
        start_date: startDate,
        end_date: endDate,
      },
      responseType: 'blob' // å‘Šè¯‰axiosæœŸæœ›æ¥æ”¶ä¸€ä¸ªBlobç±»å‹çš„æ•°æ®
    });

    // ä»å“åº”å¤´ä¸­è·å–æ–‡ä»¶å
    const contentDisposition = response.headers['content-disposition'];
    let filename = 'report.xlsx'; // é»˜è®¤æ–‡ä»¶å
    if (contentDisposition) {
      const filenameMatch = contentDisposition.match(/filename="?([^"]+)"?/);
      if (filenameMatch && filenameMatch.length > 1) {
        filename = filenameMatch[1];
      }
    }

    downloadFile(response.data, filename);
  }
}


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\services\types.ts
========================================

// frontend/src/services/types.ts (Corrected)

// ä¸ºåˆ›å»ºç”¨æˆ·å®šä¹‰ä¸€ä¸ªæ›´ç²¾ç¡®çš„æ•°æ®ç±»å‹ï¼Œå¯†ç æ˜¯å¿…éœ€çš„
export type UserCreationData = Partial<User> & { password: string };

// å®šä¹‰ç”¨æˆ·è§’è‰²çš„æšä¸¾
export enum UserRole {
  SUPER_ADMIN = 'SUPER_ADMIN',
  CUSTOMER_SERVICE = 'CUSTOMER_SERVICE',
  DEVELOPER = 'DEVELOPER',
  FINANCE = 'FINANCE'
}

// å®šä¹‰ç”¨æˆ·çš„æ¥å£ï¼ˆæ•°æ®ç»“æ„ï¼‰
export interface User {
  id: number
  username: string
  full_name?: string
  role: UserRole
  gender?: string
  skills?: string[] // Changed from specialized_field
  default_commission_rate?: number
  financial_account?: string
  is_active: boolean
}

// è®¢å•çŠ¶æ€æšä¸¾
export enum OrderStatus {
  PENDING_ASSIGNMENT = 'å¾…åŒ¹é…',
  PENDING_PAYMENT = 'å¾…ä»˜æ¬¾',
  PAID = 'å·²ä»˜æ¬¾', // + æ–°å¢çŠ¶æ€
  IN_DEVELOPMENT = 'å¼€å‘ä¸­',
  SHIPPED = 'å·²å‘è´§',
  RECEIVED = 'å·²æ”¶è´§',
  PENDING_SETTLEMENT = 'å¯ç»“ç®—',
  VERIFIED = 'å·²æ ¸éªŒ',
  SETTLED = 'å·²ç»“ç®—',
  CANCELLED = 'å·²å–æ¶ˆ'
}

// ç”¨äºåœ¨è®¢å•ä¿¡æ¯ä¸­åµŒå¥—æ˜¾ç¤ºçš„ç”¨æˆ·æ‘˜è¦ä¿¡æ¯
export interface UserInOrderOut {
  id: number
  full_name?: string
}

// å·¥ä½œæ—¥å¿—æ¥å£
export interface WorkLog {
  id: number
  log_content: string
  created_at: string
  developer: {
    id: number
    full_name: string | null
  }
}

// ææˆè®°å½•æ¥å£
export interface Commission {
  id: number
  user_id: number
  amount: number
  role_at_time: string
  created_at: string
  full_name?: string
}

// ç”¨äºåœ¨è®¢å•ä¿¡æ¯ä¸­åµŒå¥—æ˜¾ç¤ºçš„ç”¨æˆ·æ‘˜è¦ä¿¡æ¯
export interface UserInOrderOut {
  id: number
  full_name?: string
  financial_account?: string // + æ–°å¢æ­¤å­—æ®µ
}


// è®¢å•æ•°æ®æ¥å£ - Updated to match backend's OrderOut schema
export interface Order {
  id: number
  order_uid: string
  customer_info: { [key: string]: any } // Changed from string to object
  requirements_desc: string
  final_price?: number
  status: OrderStatus
  creator: UserInOrderOut
  developer?: UserInOrderOut
  commission_rate_override?: { [key: string]: number } | null
  is_locked: boolean // Added missing property
  created_at: string
  updated_at: string
  shipped_at?: string | null
  logs: WorkLog[]
  commissions: Commission[]
}

export interface Notification {
  id: number;
  content: string;
  is_read: boolean;
  related_order_id: number | null;
  created_at: string;
}


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\services\userService.ts
========================================

// frontend/src/services/userService.ts

import apiClient from './api'
import type { User } from './types'
import type { UserCreationData } from './types'


export const userService = {
  /**
   * è·å–æ‰€æœ‰å¯è®¿é—®çš„ç”¨æˆ·åˆ—è¡¨
   */
  getUsers(): Promise<User[]> {
    return apiClient.get('/users/').then((res) => res.data)
  },

  /**
     * æ‰¹é‡å¯¼å…¥ç”¨æˆ·
     * @param file Excelæ–‡ä»¶å¯¹è±¡
     */
  batchImportUsers(file: File): Promise<{ success_count: number; failure_count: number; errors: string[] }> {
      const formData = new FormData();
      formData.append('file', file);

      return apiClient.post('/users/import', formData, {
          headers: {
              // ä¸éœ€è¦æ‰‹åŠ¨è®¾ç½® 'Content-Type': 'multipart/form-data',
              // å½“ä½¿ç”¨ FormData æ—¶ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨è®¾ç½®æ­£ç¡®çš„ Content-Type å’Œ boundary
          },
      }).then(res => res.data);
  },

  /**
   * ã€æ–°å¢ã€‘åˆ›å»ºæ–°ç”¨æˆ·
   * @param userData åˆ›å»ºç”¨æˆ·æ‰€éœ€çš„æ•°æ®
   */
  createUser(userData: UserCreationData): Promise<User> {
    return apiClient.post('/users/', userData).then((res) => res.data);
  },

  /**
   * è·å–æ‰€æœ‰å·²å¯ç”¨çš„æŠ€æœ¯äººå‘˜åˆ—è¡¨
   */
  getAvailableDevelopers(): Promise<User[]> {
    // åç«¯GET /users/æ¥å£åœ¨è¢«å®¢æœè°ƒç”¨æ—¶ï¼Œä¼šè‡ªåŠ¨åªè¿”å›æŠ€æœ¯äººå‘˜
    return apiClient.get('/users/').then((res) => res.data)
  },

  /**
   * æ›´æ–°ç”¨æˆ·ä¿¡æ¯
   * @param id ç”¨æˆ·ID
   * @param userData è¦æ›´æ–°çš„æ•°æ®
   */
  updateUser(id: number, userData: Partial<User>): Promise<User> {
    return apiClient.put(`/users/${id}`, userData).then((res) => res.data)
  },

  /**
   * åˆ é™¤ç”¨æˆ·
   * @param id ç”¨æˆ·ID
   */
  deleteUser(id: number): Promise<void> {
    return apiClient.delete(`/users/${id}`).then((res) => res.data)
  },

  /**
   * åˆ‡æ¢ç”¨æˆ·çš„å¯ç”¨/ç¦ç”¨çŠ¶æ€
   * @param id ç”¨æˆ·ID
   */
  toggleUserStatus(id: number): Promise<User> {
    return apiClient.patch(`/users/${id}/toggle-status`).then((res) => res.data)
  },
}


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\stores\auth.ts
========================================

import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import apiClient from '@/services/api'
import router from '@/router'

// è§£æJWT Tokençš„å‡½æ•°
function parseJwt(token: string) {
  try {
    return JSON.parse(atob(token.split('.')[1]))
  } catch {
    return null
  }
}

export const useAuthStore = defineStore('auth', () => {
  const token = ref(localStorage.getItem('token'))
  const user = ref(JSON.parse(localStorage.getItem('user') || '{}'))

  const isAuthenticated = computed(() => !!token.value)
  const userRole = computed(() => user.value?.role || null)

  async function login(username: string, password: string): Promise<boolean> {
    try {
      const response = await apiClient.post('/auth/login', { username, password })
      const newTocken = response.data.access_token

      token.value = newTocken
      user.value = parseJwt(newTocken)

      localStorage.setItem('token', newTocken)
      localStorage.setItem('user', JSON.stringify(user.value))

      await router.push('/') // ç™»å½•æˆåŠŸåè·³è½¬åˆ°é¦–é¡µ
      return true
    } catch (error) {
      console.error('Login failed:', error)
      // åœ¨è¿™é‡Œå¯ä»¥å¤„ç†ç™»å½•å¤±è´¥çš„é€»è¾‘ï¼Œæ¯”å¦‚æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
      return false
    }
  }

  function logout() {
    token.value = null
    user.value = {}
    localStorage.removeItem('token')
    localStorage.removeItem('user')
    router.push('/login')
  }

  return { token, user, isAuthenticated, userRole, login, logout }
})


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\stores\counter.ts
========================================

import { ref, computed } from 'vue'
import { defineStore } from 'pinia'

export const useCounterStore = defineStore('counter', () => {
  const count = ref(0)
  const doubleCount = computed(() => count.value * 2)
  function increment() {
    count.value++
  }

  return { count, doubleCount, increment }
})


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\stores\notifications.ts
========================================

// frontend/src/stores/notifications.ts (æ–°å»ºæ–‡ä»¶)

import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import { notificationService } from '@/services/notificationService'
import type { Notification } from '@/services/types'
import { message } from 'ant-design-vue'

export const useNotificationStore = defineStore('notifications', () => {
  const notifications = ref<Notification[]>([])

  const unreadCount = computed(() => {
    return notifications.value.filter((n) => !n.is_read).length
  })

  async function fetchNotifications() {
    try {
      const data = await notificationService.getNotifications()
      notifications.value = data
    } catch (error) {
      console.error('Failed to fetch notifications:', error)
      message.error('è·å–é€šçŸ¥åˆ—è¡¨å¤±è´¥')
    }
  }

  async function markOneAsRead(notificationId: number) {
    try {
      const updatedNotification = await notificationService.markAsRead(notificationId)
      const index = notifications.value.findIndex((n) => n.id === notificationId)
      if (index !== -1) {
        // --- æ ¸å¿ƒä¿®å¤ ---
        // æ—§çš„ã€å­˜åœ¨å“åº”å¼é—®é¢˜çš„ä»£ç :
        // notifications.value[index] = updatedNotification;

        // ä¿®å¤åçš„ã€èƒ½è§¦å‘å“åº”å¼æ›´æ–°çš„ä»£ç :
        // ä½¿ç”¨ splice æ–¹æ³•æ›¿æ¢æ•°ç»„ä¸­çš„å…ƒç´ ï¼Œä»¥ç¡®ä¿ Vue èƒ½å¤Ÿæ£€æµ‹åˆ°å˜åŒ–
        notifications.value.splice(index, 1, updatedNotification);
      }
    } catch (error) {
      console.error('Failed to mark notification as read:', error)
      message.error('æ ‡è®°å·²è¯»å¤±è´¥')
    }
  }
  return {
    notifications,
    unreadCount,
    fetchNotifications,
    markOneAsRead,
  }
})


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\views\HomeView.vue
========================================

<template>
  <div>
    <a-page-header :title="pageTitle" :sub-title="pageSubTitle" />

    <div v-if="loading" class="loading-container">
      <a-spin size="large" />
    </div>

    <div v-else class="content-grid">
      <template v-if="authStore.userRole === UserRole.SUPER_ADMIN && globalStats">
        <a-row :gutter="[16, 24]">
          <a-col :span="6">
            <a-statistic title="æ€»ç”¨æˆ·æ•°" :value="globalStats.total_users" class="stat-card" />
          </a-col>
          <a-col :span="6">
            <a-statistic title="æ€»è®¢å•æ•°" :value="globalStats.total_orders" class="stat-card" />
          </a-col>
          <a-col :span="12">
            <a-statistic
              title="ç´¯è®¡ç»“ç®—æ€»é¢ (å…ƒ)"
              :precision="2"
              :value="globalStats.total_settled_value"
              class="stat-card"
            />
          </a-col>

          <a-col :span="24">
            <a-card title="è®¢å•çŠ¶æ€åˆ†å¸ƒ">
              <v-chart class="chart" :option="pieChartOption" autoresize />
            </a-card>
          </a-col>

          <a-col :span="12">
            <a-card title="å®¢æœæœˆåº¦ä¸šç»©æ’è¡Œ (æŒ‰æ¥å•é‡‘é¢)">
              <v-chart v-if="teamStats?.customer_service_performance.length" class="chart" :option="csChartOption" autoresize />
              <a-empty v-else description="æœ¬æœˆæš‚æ— å®¢æœä¸šç»©æ•°æ®" />
            </a-card>
          </a-col>
          <a-col :span="12">
            <a-card title="æŠ€æœ¯æœˆåº¦ä¸šç»©æ’è¡Œ (æŒ‰ç»“ç®—é‡‘é¢)">
               <v-chart v-if="teamStats?.developer_performance.length" class="chart" :option="devChartOption" autoresize />
               <a-empty v-else description="æœ¬æœˆæš‚æ— æŠ€æœ¯ä¸šç»©æ•°æ®" />
            </a-card>
          </a-col>
        </a-row>
      </template>

      <template v-if="isEmployee && personalStats">
        <a-row :gutter="[16, 16]">
          <a-col :span="12">
            <a-statistic
              :title="personalStatTitle"
              :value="personalStats.monthly_orders_created ?? personalStats.monthly_orders_completed ?? 0"
              class="stat-card"
            />
          </a-col>
          <a-col :span="12">
            <a-statistic
              title="ç´¯è®¡è·å¾—æ€»ææˆ (å…ƒ)"
              :precision="2"
              :value="personalStats.total_commission_earned"
              class="stat-card"
            />
          </a-col>
        </a-row>
        <a-alert
          message="æç¤º"
          description="è¿™é‡Œå±•ç¤ºçš„æ˜¯æ‚¨ä¸ªäººçš„å…³é”®ä¸šç»©æŒ‡æ ‡ã€‚æœˆåº¦æ•°æ®ä¼šåœ¨æ¯æœˆåˆé‡ç½®ã€‚"
          type="info"
          show-icon
          style="margin-top: 24px"
        />
      </template>

      <template v-if="authStore.userRole === UserRole.FINANCE">
        <a-card>
          <a-empty
            image="https://gw.alipayobjects.com/mdn/miniapp_social/afts/img/A*pevERLJC9v0AAAAAAAAAAABjAQAAAQ/original"
            description="æ¬¢è¿ä½¿ç”¨è´¢åŠ¡åŠŸèƒ½ï¼Œè¯·ç‚¹å‡»é¡¶éƒ¨å¯¼èˆªæ çš„ã€è´¢åŠ¡æŠ¥è¡¨ã€‘å¼€å§‹æ‚¨çš„å·¥ä½œã€‚"
          />
        </a-card>
      </template>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, computed } from 'vue';
import { useAuthStore } from '@/stores/auth';
import { UserRole } from '@/services/types';
import { dashboardService, type GlobalDashboardStats, type PersonalDashboardStats, type TeamPerformanceStats } from '@/services/dashboardService';
import {
  PageHeader as APageHeader,
  Card as ACard,
  Spin as ASpin,
  Statistic as AStatistic,
  Row as ARow,
  Col as ACol,
  Alert as AAlert,
  Empty as AEmpty,
  message
} from 'ant-design-vue';

// å¼•å…¥ ECharts æ ¸å¿ƒå’Œå¿…è¦ç»„ä»¶
import { use } from 'echarts/core';
import { CanvasRenderer } from 'echarts/renderers';
import { PieChart, BarChart } from 'echarts/charts';
import { TitleComponent, TooltipComponent, LegendComponent, GridComponent } from 'echarts/components';
import VChart from 'vue-echarts';

// æ³¨å†Œ ECharts ç»„ä»¶
use([CanvasRenderer, PieChart, BarChart, TitleComponent, TooltipComponent, LegendComponent, GridComponent]);

// --- å“åº”å¼çŠ¶æ€å®šä¹‰ ---
const authStore = useAuthStore();
const loading = ref(true);
const globalStats = ref<GlobalDashboardStats | null>(null);
const personalStats = ref<PersonalDashboardStats | null>(null);
const teamStats = ref<TeamPerformanceStats | null>(null);

// --- è®¡ç®—å±æ€§ ---
const pageTitle = computed(() => {
  switch (authStore.userRole) {
    case UserRole.SUPER_ADMIN: return 'å…¨å±€æ•°æ®çœ‹æ¿';
    case UserRole.CUSTOMER_SERVICE:
    case UserRole.DEVELOPER: return 'ä¸ªäººå·¥ä½œå°';
    case UserRole.FINANCE: return 'è´¢åŠ¡å·¥ä½œå°';
    default: return 'é¦–é¡µ';
  }
});

const pageSubTitle = computed(() => `æ¬¢è¿å›æ¥, ${authStore.user?.full_name || authStore.user?.username}!`);

const isEmployee = computed(() =>
  authStore.userRole === UserRole.CUSTOMER_SERVICE || authStore.userRole === UserRole.DEVELOPER
);

const personalStatTitle = computed(() => {
    return authStore.userRole === UserRole.CUSTOMER_SERVICE ? 'æœ¬æœˆåˆ›å»ºè®¢å•æ•°' : 'æœ¬æœˆå®Œæˆè®¢å•æ•°'
});

// è¾…åŠ©å‡½æ•°ï¼šä¸ºæ¡å½¢å›¾ç”Ÿæˆé…ç½®
const createBarChartOption = (title: string, data: { name: string; value: number }[]) => {
  // ECharts éœ€è¦æ•°æ®å€’åºæ‰èƒ½å®ç°ä»ä¸Šåˆ°ä¸‹çš„é™åºæ’åå›¾
  const reversedData = [...data].reverse();
  return {
    tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
    grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
    xAxis: { type: 'value', boundaryGap: [0, 0.01] },
    yAxis: { type: 'category', data: reversedData.map(item => item.name) },
    series: [
      {
        name: title,
        type: 'bar',
        data: reversedData.map(item => item.value),
        itemStyle: {
          borderRadius: [0, 5, 5, 0],
          color: '#5470c6'
        },
        label: {
          show: true,
          position: 'right',
          formatter: '{c} å…ƒ'
        }
      }
    ]
  };
};

// ECharts é¥¼å›¾é…ç½®
const pieChartOption = computed(() => {
  const data = globalStats.value?.status_distribution
    ? Object.entries(globalStats.value.status_distribution).map(([name, value]) => ({ name, value }))
    : [];

  return {
    tooltip: { trigger: 'item', formatter: '{a} <br/>{b} : {c} ({d}%)' },
    legend: { orient: 'vertical', left: 'left', data: data.map(d => d.name) },
    series: [
      {
        name: 'è®¢å•çŠ¶æ€',
        type: 'pie',
        radius: '75%',
        center: ['60%', '50%'],
        data: data,
        emphasis: {
          itemStyle: {
            shadowBlur: 10,
            shadowOffsetX: 0,
            shadowColor: 'rgba(0, 0, 0, 0.5)',
          },
        },
      },
    ],
  };
});

// å®¢æœä¸šç»©å›¾è¡¨é…ç½®
const csChartOption = computed(() => {
  const data = teamStats.value?.customer_service_performance.map(p => ({ name: p.full_name, value: p.total_value })) || [];
  return createBarChartOption('æ¥å•é‡‘é¢', data);
});

// æŠ€æœ¯ä¸šç»©å›¾è¡¨é…ç½®
const devChartOption = computed(() => {
  const data = teamStats.value?.developer_performance.map(p => ({ name: p.full_name, value: p.total_value })) || [];
  return createBarChartOption('ç»“ç®—é‡‘é¢', data);
});


// --- ç”Ÿå‘½å‘¨æœŸé’©å­ ---
// ç»„ä»¶æŒ‚è½½æ—¶æ ¹æ®è§’è‰²è·å–æ•°æ®
onMounted(async () => {
  loading.value = true;
  try {
    if (authStore.userRole === UserRole.SUPER_ADMIN) {
      // ä½¿ç”¨ Promise.all å¹¶è¡Œè·å–æ•°æ®ï¼Œæå‡åŠ è½½é€Ÿåº¦
      const [globalData, teamData] = await Promise.all([
        dashboardService.getGlobalDashboard(),
        dashboardService.getTeamPerformance()
      ]);
      globalStats.value = globalData;
      teamStats.value = teamData;
    } else if (isEmployee.value) {
      personalStats.value = await dashboardService.getPersonalDashboard();
    }
  } catch (error) {
    console.error("Failed to fetch dashboard data:", error);
    message.error("æ•°æ®åŠ è½½å¤±è´¥ï¼");
  } finally {
    loading.value = false;
  }
});
</script>

<style scoped>
.content-grid {
  padding: 0 24px;
}
.loading-container {
  text-align: center;
  padding: 50px;
}
.stat-card {
  background-color: #fff;
  padding: 24px;
  border-radius: 4px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.09);
}
.chart {
  height: 300px;
}
</style>


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\views\LoginView.vue
========================================

<template>
  <div class="login-container">
    <div class="login-box">
      <div class="left-panel">
        <img src="@/assets/logo.svg" alt="logo" class="logo-img"/>
        <h2>å…¬å¸å†…éƒ¨ç®¡ç†ç³»ç»Ÿ</h2>
        <p>é«˜æ•ˆã€ååŒã€æ™ºèƒ½</p>
      </div>
      <div class="right-panel">
        <a-form
          :model="formState"
          @finish="handleLogin"
          layout="vertical"
          class="login-form"
        >
          <h3>æ¬¢è¿å›æ¥ï¼</h3>
          <a-form-item
            label="ç”¨æˆ·å"
            name="username"
            :rules="[{ required: true, message: 'è¯·è¾“å…¥ç”¨æˆ·å!' }]"
          >
            <a-input v-model:value="formState.username" placeholder="è¯·è¾“å…¥æ‚¨çš„è´¦æˆ·" size="large">
                <template #prefix><UserOutlined /></template>
            </a-input>
          </a-form-item>

          <a-form-item
            label="å¯†ç "
            name="password"
            :rules="[{ required: true, message: 'è¯·è¾“å…¥å¯†ç !' }]"
          >
            <a-input-password v-model:value="formState.password" placeholder="è¯·è¾“å…¥æ‚¨çš„å¯†ç " size="large">
                <template #prefix><LockOutlined /></template>
            </a-input-password>
          </a-form-item>

          <a-form-item v-if="errorMsg">
            <a-alert :message="errorMsg" type="error" show-icon />
          </a-form-item>

          <a-form-item>
            <a-button type="primary" html-type="submit" :loading="loading" block size="large">
              ç™» å½•
            </a-button>
          </a-form-item>
        </a-form>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { reactive, ref } from 'vue';
import { useAuthStore } from '@/stores/auth';
import { UserOutlined, LockOutlined } from '@ant-design/icons-vue';

const formState = reactive({
  username: '',
  password: '',
});

const authStore = useAuthStore();
const loading = ref(false);
const errorMsg = ref('');

const handleLogin = async () => {
  loading.value = true;
  errorMsg.value = '';
  const success = await authStore.login(formState.username, formState.password);
  if (!success) {
    errorMsg.value = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚';
  }
  loading.value = false;
};
</script>

<style scoped>
.login-container {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  background-image: linear-gradient(to top, #f3e7e9 0%, #e3eeff 99%, #e3eeff 100%);
}

.login-box {
  width: 800px;
  height: 500px;
  display: flex;
  background-color: #fff;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
  overflow: hidden;
}

.left-panel {
  width: 45%;
  background: linear-gradient(135deg, #1677ff, #52c41a);
  color: #fff;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  padding: 40px;
  text-align: center;
}

.left-panel .logo-img {
    width: 80px;
    height: 80px;
    margin-bottom: 20px;
}

.left-panel h2 {
  color: #fff;
  font-size: 28px;
  margin-bottom: 10px;
}

.left-panel p {
  font-size: 16px;
  opacity: 0.9;
}

.right-panel {
  width: 55%;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 40px;
}

.login-form {
  width: 100%;
}

.login-form h3 {
  font-size: 24px;
  font-weight: 600;
  margin-bottom: 24px;
  color: #333;
}
</style>


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\views\admin\UserManagementView.vue
========================================

<template>
  <a-card title="ç”¨æˆ·åˆ—è¡¨">
    <template #extra>
      <a-space>
        <a-upload
          :show-upload-list="false"
          :before-upload="handleBeforeUpload"
          accept=".xlsx"
        >
          <a-button :loading="uploading">
            <template #icon><UploadOutlined /></template>
            æ‰¹é‡å¯¼å…¥
          </a-button>
        </a-upload>
        <a-button type="primary" @click="handleAddNew">
          <template #icon><PlusOutlined /></template>
          æ–°å¢ç”¨æˆ·
        </a-button>
      </a-space>
    </template>

    <user-table
      :users="users"
      :loading="loading || uploading"
      @edit="handleEdit"
      @delete="handleDelete"
      @toggle-status="handleToggleStatus"
    />
  </a-card>

  <user-form
    v-model:open="isModalVisible"
    :user="currentUser"
    @save="handleFormSave"
  />
</template>

<script setup lang="ts">
import { ref, onMounted, h } from 'vue';
import {
  Button as AButton,
  message,
  Modal,
  Card as ACard,
  Upload as AUpload,
  Space as ASpace,
} from 'ant-design-vue';
import { PlusOutlined, UploadOutlined } from '@ant-design/icons-vue';
import UserTable from '@/components/admin/UserTable.vue';
import UserForm from '@/components/admin/UserForm.vue';
import { userService } from '@/services/userService';
import type { User } from '@/services/types';

const users = ref<User[]>([]);
const loading = ref(true);
const uploading = ref(false);
const isModalVisible = ref(false);
const currentUser = ref<User | null>(null);

// ... fetchUsers, onMounted, handleEdit, handleDelete, handleToggleStatus, handleBeforeUpload é€»è¾‘ä¸å˜ ...
const fetchUsers = async () => {
  loading.value = true;
  try {
    users.value = await userService.getUsers();
  } catch (error) {
    message.error('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥');
  } finally {
    loading.value = false;
  }
};

onMounted(fetchUsers);

const handleAddNew = () => {
  currentUser.value = null;
  isModalVisible.value = true;
};

const handleEdit = (user: User) => {
  currentUser.value = { ...user };
  isModalVisible.value = true;
};

const handleDelete = (userId: number) => {
  Modal.confirm({
    title: 'ç¡®è®¤åˆ é™¤',
    content: 'ç¡®å®šè¦åˆ é™¤è¯¥ç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚',
    onOk: async () => {
      try {
        await userService.deleteUser(userId);
        message.success('ç”¨æˆ·åˆ é™¤æˆåŠŸ');
        await fetchUsers();
      } catch (error) {
        message.error('åˆ é™¤ç”¨æˆ·å¤±è´¥');
      }
    },
  });
};

const handleToggleStatus = async (userToToggle: User) => {
  try {
    const updatedUser = await userService.toggleUserStatus(userToToggle.id);
    const index = users.value.findIndex((u: User) => u.id === updatedUser.id);
    if (index !== -1) {
      users.value[index] = updatedUser;
    }
    message.success(`ç”¨æˆ·çŠ¶æ€å·²æ›´æ–°ä¸º ${updatedUser.is_active ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
  } catch (error) {
    message.error('æ›´æ–°ç”¨æˆ·çŠ¶æ€å¤±è´¥');
  }
};

const handleBeforeUpload = (file: File) => {
  uploading.value = true;
  userService.batchImportUsers(file)
    .then(result => {
      const { success_count, failure_count, errors } = result;
      const successMessage = `å¯¼å…¥å®Œæˆ: ${success_count} æ¡æˆåŠŸ, ${failure_count} æ¡å¤±è´¥ã€‚`;
      if (failure_count > 0) {
        Modal.warning({
          title: successMessage,
          width: 700,
          content: h('div', null, [
            h('p', 'ä»¥ä¸‹æ˜¯å¯¼å…¥å¤±è´¥çš„è¡Œå’ŒåŸå› :'),
            h('div', { style: { maxHeight: '300px', overflowY: 'auto', marginTop: '10px', background: '#f5f5f5', padding: '10px' } },
              errors.map((e: string) => h('p', { style: { margin: '0 0 5px 0' } }, e))
            ),
          ]),
        });
      } else {
        message.success(successMessage);
      }
      fetchUsers();
    })
    .catch(error => {
      message.error(error.response?.data?.msg || 'ä¸Šä¼ æˆ–å¤„ç†æ–‡ä»¶æ—¶å‘ç”Ÿä¸¥é‡é”™è¯¯');
    })
    .finally(() => {
      uploading.value = false;
    });
  return false;
};

const handleFormSave = () => {
  isModalVisible.value = false;
  fetchUsers();
};

// ä¿®æ”¹ç‚¹ 2: handleFormCancel å‡½æ•°ç°åœ¨ä¸å†éœ€è¦ï¼Œå¯ä»¥å®‰å…¨åˆ é™¤ã€‚
// v-model:open="isModalVisible" å·²ç»è‡ªåŠ¨å¤„ç†äº†å…³é—­æ¨¡æ€æ¡†æ—¶ isModalVisible.value = false çš„é€»è¾‘ã€‚
/*
const handleFormCancel = () => {
  isModalVisible.value = false;
};
*/
</script>


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\views\finance\FinanceReportView.vue
========================================

<template>
  <div>
    <a-page-header title="è´¢åŠ¡æŠ¥è¡¨" sub-title="ä¸‹è½½å·²ç»“ç®—çš„è®¢å•æŠ¥è¡¨" />
    <div class="content-card">
      <a-card>
        <a-space direction="vertical" :size="24">
          <p>è¯·é€‰æ‹©éœ€è¦å¯¼å‡ºæŠ¥è¡¨çš„æ—¶é—´èŒƒå›´ï¼Œç³»ç»Ÿå°†ç”Ÿæˆè¯¥æ—¶é—´æ®µå†…æ‰€æœ‰â€œå·²ç»“ç®—â€è®¢å•çš„ Excel æ–‡ä»¶ã€‚</p>
          <a-range-picker v-model:value="dateRange" size="large" />
          <a-button 
            type="primary" 
            :loading="downloading" 
            :disabled="!dateRange" 
            @click="handleDownload"
            size="large"
          >
            <template #icon><DownloadOutlined /></template>
            ä¸‹è½½æŠ¥è¡¨
          </a-button>
        </a-space>
      </a-card>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue';
import {
  PageHeader as APageHeader,
  Card as ACard,
  RangePicker as ARangePicker,
  Button as AButton,
  Space as ASpace,
  message,
} from 'ant-design-vue';
import { DownloadOutlined } from '@ant-design/icons-vue';
import { reportService } from '@/services/reportService';
import type { Dayjs } from 'dayjs';

const dateRange = ref<[Dayjs, Dayjs]>();
const downloading = ref(false);

const handleDownload = async () => {
  if (!dateRange.value) {
    message.warning('è¯·é€‰æ‹©ä¸€ä¸ªæ—¥æœŸèŒƒå›´');
    return;
  }
  
  downloading.value = true;
  try {
    const startDate = dateRange.value[0].format('YYYY-MM-DD');
    const endDate = dateRange.value[1].format('YYYY-MM-DD');
    await reportService.downloadSettledOrdersReport(startDate, endDate);
    message.success('æŠ¥è¡¨å·²å¼€å§‹ä¸‹è½½ï¼');
  } catch (error: any) {
    console.error("Download failed:", error);
    message.error(error.response?.data?.msg || 'æŠ¥è¡¨ä¸‹è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚');
  } finally {
    downloading.value = false;
  }
};
</script>

<style scoped>
.content-card {
  margin: 0 24px;
}
</style>

===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\views\orders\CreateOrderView.vue
========================================

<template>
  <div class="page-container">
    <a-page-header title="åˆ›å»ºæ–°è®¢å•" @back="() => router.back()" />
    <a-card>
      <a-form
        :model="formState"
        ref="formRef"
        layout="vertical"
        :rules="rules"
        @finish="handleFinish"
      >
        <a-row :gutter="16">
          <a-col :span="12">
            <a-form-item label="å®¢æˆ·å§“å" name="customer_name">
              <a-input
                v-model:value="formState.customer_name"
                placeholder="è¯·è¾“å…¥å®¢æˆ·çš„å§“åæˆ–ç§°å‘¼"
              />
            </a-form-item>
          </a-col>
          <a-col :span="12">
            <a-form-item label="è”ç³»æ–¹å¼" name="customer_phone">
              <a-input
                v-model:value="formState.customer_phone"
                placeholder="è¯·è¾“å…¥å®¢æˆ·çš„ç”µè¯æˆ–å…¶å®ƒè”ç³»æ–¹å¼"
              />
            </a-form-item>
          </a-col>
        </a-row>

        <a-form-item label="éœ€æ±‚æè¿°" name="requirements_desc">
          <a-textarea
            v-model:value="formState.requirements_desc"
            placeholder="è¯·è¯¦ç»†æè¿°å®¢æˆ·çš„éœ€æ±‚"
            :rows="8"
          />
        </a-form-item>

        <a-form-item>
          <a-space>
            <a-button type="primary" html-type="submit" :loading="submitting"> æäº¤åˆ›å»º </a-button>
            <a-button @click="() => router.back()">å–æ¶ˆ</a-button>
          </a-space>
        </a-form-item>
      </a-form>
    </a-card>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive } from 'vue'
import { useRouter } from 'vue-router'
import {
  message,
  PageHeader as APageHeader,
  Card as ACard,
  Form as AForm,
  FormItem as AFormItem,
  Input as AInput,
  Textarea as ATextarea,
  Row as ARow,
  Col as ACol,
  Button as AButton,
  Space as ASpace
} from 'ant-design-vue'
import type { FormInstance, FormProps } from 'ant-design-vue'
import { orderService } from '@/services/orderService'

const router = useRouter()
const formRef = ref<FormInstance>()
const submitting = ref(false)

// è¡¨å•æ•°æ®ç»“æ„ï¼Œå¯¹åº”UIè¾“å…¥
const formState = reactive({
  customer_name: '',
  customer_phone: '',
  requirements_desc: ''
})

// è¡¨å•æ ¡éªŒè§„åˆ™
const rules: FormProps['rules'] = {
  customer_name: [{ required: true, message: 'è¯·è¾“å…¥å®¢æˆ·å§“å' }],
  customer_phone: [{ required: true, message: 'è¯·è¾“å…¥å®¢æˆ·è”ç³»æ–¹å¼' }],
  requirements_desc: [{ required: true, message: 'è¯·è¾“å…¥éœ€æ±‚æè¿°' }]
}

// è¡¨å•æäº¤å¤„ç†
const handleFinish = async () => {
  submitting.value = true
  try {
    // æ ¹æ®è¡¨å•æ•°æ®æ„å»ºç¬¦åˆåç«¯APIè¦æ±‚çš„payload
    const payload = {
      customer_info: {
        name: formState.customer_name,
        phone: formState.customer_phone
      },
      requirements_desc: formState.requirements_desc
    }
    await orderService.createOrder(payload)
    message.success('è®¢å•åˆ›å»ºæˆåŠŸï¼')
    router.push('/orders') // æˆåŠŸåè·³è½¬å›è®¢å•åˆ—è¡¨
  } catch (error: any) {
    const errorMsg = error.response?.data?.msg || 'è®¢å•åˆ›å»ºå¤±è´¥'
    message.error(errorMsg)
  } finally {
    submitting.value = false
  }
}
</script>

<style scoped>
.page-container {
  padding: 24px;
}
</style>


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\views\orders\OrderDetailView.vue
========================================

<template>
  <div v-if="loading" class="loading-container">
    <a-spin size="large" tip="æ­£åœ¨åŠ è½½è®¢å•è¯¦æƒ…..." />
  </div>

  <div v-else-if="!order" class="loading-container">
     <a-empty description="æœªæ‰¾åˆ°è¯¥è®¢å•æˆ–æ‚¨æ²¡æœ‰æƒé™è®¿é—®" />
  </div>

  <div v-else>
    <a-card :bordered="false" style="margin-bottom: 24px;">
      <template #title>
        <span style="font-size: 20px; font-weight: 500;">
          è®¢å•è¯¦æƒ…: {{ order.order_uid }}
        </span>
      </template>
      <template #extra>
        <a-space>
          <a-button
            v-if="actions.canRevertToDev.value"
            @click="handleUpdateStatus(OrderStatus.IN_DEVELOPMENT)"
          >
            è¿”å·¥
          </a-button>
          <a-button
            v-if="actions.canSettleByTech.value"
            @click="handleUpdateStatus(OrderStatus.PENDING_SETTLEMENT)"
            type="primary"
          >
            ç¡®è®¤å¯ç»“ç®—
          </a-button>
           <a-button
            v-if="actions.canCancelOrder.value"
            @click="handleUpdateStatus(OrderStatus.CANCELLED)"
            danger
          >
            å–æ¶ˆè®¢å•
          </a-button>
        </a-space>
      </template>

      <div class="content-grid">
        <div class="main-content">
          <order-info-card :order="order" />
        </div>
        <div class="sidebar">
           <order-action-panel
            :order="order"
            @update-status="handleUpdateStatus"
            @open-price-modal="openPriceModal"
            @open-assign-modal="openAssignTechModal"
            @reload-order="fetchOrder"
            @open-commission-modal="openCommissionModal"
          />
        </div>
      </div>
    </a-card>

    <a-row :gutter="24">
      <a-col :xs="24" :lg="16">
        <work-log-timeline :logs="order.logs" />
      </a-col>
      <a-col :xs="24" :lg="8">
        <commission-info-card :order="order" />
      </a-col>
    </a-row>
  </div>

  <a-modal v-model:visible="isPriceModalVisible" title="ä¿®æ”¹è®¢å•ä»·æ ¼" @ok="handleUpdatePrice">
    <a-form layout="vertical">
      <a-form-item label="æ–°çš„è®¢å•ä»·æ ¼ (å…ƒ)">
        <a-input-number v-model:value="newPrice" style="width: 100%" :min="0" addon-after="å…ƒ" />
      </a-form-item>
    </a-form>
  </a-modal>

  <a-modal v-model:visible="isCommissionModalVisible" title="è®¾ç½®ç‰¹æ®Šææˆ" @ok="handleSetCommission">
    <p style="margin-bottom: 16px; color: rgba(0, 0, 0, 0.45);">
      æ­¤å¤„è®¾ç½®çš„æ¯”ä¾‹å°†ä»…å¯¹æœ¬è®¢å•ç”Ÿæ•ˆï¼Œè¦†ç›–ç”¨æˆ·çš„é»˜è®¤ææˆæ¯”ä¾‹ã€‚ç•™ç©ºåˆ™è¡¨ç¤ºä¸è®¾ç½®ç‰¹æ®Šæ¯”ä¾‹ã€‚
    </p>
    <a-form layout="vertical">
      <a-form-item v-if="order?.creator" :label="`å®¢æœææˆç‡ (%) - ${order.creator.full_name}`">
        <a-input-number v-model:value="commissionForm.cs_rate" style="width: 100%" :min="0" :max="100" placeholder="ä¾‹å¦‚: 10.5"/>
      </a-form-item>
      <a-form-item v-if="order?.developer" :label="`æŠ€æœ¯ææˆç‡ (%) - ${order.developer.full_name}`">
        <a-input-number v-model:value="commissionForm.tech_rate" style="width: 100%" :min="0" :max="100" placeholder="ä¾‹å¦‚: 12"/>
      </a-form-item>
    </a-form>
  </a-modal>

  <a-modal v-model:visible="isAssignModalVisible" title="åˆ†é…æŠ€æœ¯è´Ÿè´£äºº" @ok="handleAssignTech">
    <a-form layout="vertical">
      <a-form-item label="é€‰æ‹©æŠ€æœ¯äººå‘˜">
        <a-select
          v-model:value="selectedTechId"
          style="width: 100%"
          placeholder="è¯·æœç´¢æˆ–é€‰æ‹©æŠ€æœ¯äººå‘˜"
          :loading="devsLoading"
          show-search
          :filter-option="(input: string, option: any) => option.label.toLowerCase().indexOf(input.toLowerCase()) >= 0"
        >
          <a-select-option v-for="dev in developers" :key="dev.id" :value="dev.id" :label="dev.full_name || dev.username">
            {{ dev.full_name || dev.username }} (æ“…é•¿: {{ dev.skills?.join(', ') || 'æœªå¡«å†™' }})
          </a-select-option>
        </a-select>
      </a-form-item>
    </a-form>
  </a-modal>
</template>

<script setup lang="ts">
import { ref, onMounted, defineAsyncComponent, reactive, computed } from 'vue';
import { useRoute } from 'vue-router';
import { orderService } from '@/services/orderService';
import { userService } from '@/services/userService';
import { type Order, OrderStatus, type User } from '@/services/types';
import { useOrderActions } from '@/composables/useOrderActions';
import {
  message,
  Modal as AModal,
  Select as ASelect,
  SelectOption as ASelectOption,
  InputNumber as AInputNumber,
  Form as AForm,
  FormItem as AFormItem,
  Spin as ASpin,
  Card as ACard,
  Space as ASpace,
  Button as AButton,
  Row as ARow,
  Col as ACol,
  Empty as AEmpty,
} from 'ant-design-vue';

// --- å¼‚æ­¥åŠ è½½å­ç»„ä»¶ï¼Œä¼˜åŒ–åˆå§‹åŠ è½½æ€§èƒ½ ---
const OrderInfoCard = defineAsyncComponent(() => import('@/components/orders/OrderInfoCard.vue'));
const WorkLogTimeline = defineAsyncComponent(() => import('@/components/orders/WorkLogTimeline.vue'));
const OrderActionPanel = defineAsyncComponent(() => import('@/components/orders/OrderActionPanel.vue'));
const CommissionInfoCard = defineAsyncComponent(() => import('@/components/orders/CommissionInfoCard.vue'));

const route = useRoute();
const orderId = Number(route.params.id);

// --- çŠ¶æ€ç®¡ç† ---
const order = ref<Order | null>(null);
const loading = ref(true);

const actions = useOrderActions(computed(() => order.value));

// --- æ•°æ®è·å– ---
const fetchOrder = async () => {
  loading.value = true;
  try {
    order.value = await orderService.getOrderById(orderId);
  } catch (error) {
    console.error("Failed to fetch order:", error);
    message.error('è·å–è®¢å•è¯¦æƒ…å¤±è´¥');
    order.value = null; // è·å–å¤±è´¥æ—¶æ¸…ç©ºè®¢å•
  } finally {
    loading.value = false;
  }
};

onMounted(fetchOrder);

// --- äº‹ä»¶å¤„ç†å™¨ ---
const handleUpdateStatus = async (targetStatus: OrderStatus) => {
  if (!order.value) return;
  try {
    const res = await orderService.updateOrderStatus(order.value.id, targetStatus);
    message.success(res.message);
    await fetchOrder(); // é‡æ–°è·å–æ•°æ®ä»¥æ›´æ–°æ•´ä¸ªè§†å›¾
  } catch (error: any) {
    message.error(error.response?.data?.msg || 'æ›´æ–°çŠ¶æ€å¤±è´¥');
  }
};

// --- æ¨¡æ€æ¡†é€»è¾‘ ---
const isPriceModalVisible = ref(false);
const newPrice = ref<number | undefined>(undefined);
const isAssignModalVisible = ref(false);
const devsLoading = ref(false);
const developers = ref<User[]>([]);
const selectedTechId = ref<number | undefined>(undefined);
const isCommissionModalVisible = ref(false);

const commissionForm = reactive({
  cs_rate: undefined as number | undefined,
  tech_rate: undefined as number | undefined,
});

const openPriceModal = () => {
  newPrice.value = order.value?.final_price;
  isPriceModalVisible.value = true;
};

const openAssignTechModal = async () => {
  isAssignModalVisible.value = true;
  devsLoading.value = true;
  try {
    developers.value = await userService.getAvailableDevelopers();
    selectedTechId.value = order.value?.developer?.id;
  } catch (error) {
    message.error('è·å–æŠ€æœ¯äººå‘˜åˆ—è¡¨å¤±è´¥');
  } finally {
    devsLoading.value = false;
  }
};

const openCommissionModal = () => {
  const override_rates = order.value?.commission_rate_override;
  commissionForm.cs_rate = override_rates?.cs_rate ?? undefined;
  commissionForm.tech_rate = override_rates?.tech_rate ?? undefined;
  isCommissionModalVisible.value = true;
};

const handleUpdatePrice = async () => {
  if (!order.value || newPrice.value === undefined || newPrice.value < 0) {
      return message.warn('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼');
  }
  try {
    await orderService.updateOrderDetails(order.value.id, { final_price: newPrice.value });
    message.success('ä»·æ ¼æ›´æ–°æˆåŠŸ');
    isPriceModalVisible.value = false;
    await fetchOrder();
  } catch (error: any) {
    message.error(error.response?.data?.msg || 'ä»·æ ¼æ›´æ–°å¤±è´¥');
  }
};

const handleAssignTech = async () => {
  if (!order.value || selectedTechId.value === undefined) {
      return message.warn('è¯·é€‰æ‹©ä¸€ä½æŠ€æœ¯äººå‘˜');
  }
  try {
    await orderService.updateOrderDetails(order.value.id, { developer_id: selectedTechId.value });
    message.success('æŠ€æœ¯è´Ÿè´£äººå·²æ›´æ–°');
    isAssignModalVisible.value = false;
    await fetchOrder();
  } catch (error: any) {
    message.error(error.response?.data?.msg || 'åˆ†é…å¤±è´¥');
  }
};

const handleSetCommission = async () => {
  if (!order.value) return;
  try {
    const payload: { cs_rate?: number; tech_rate?: number } = {};
    if (commissionForm.cs_rate !== undefined && commissionForm.cs_rate !== null) payload.cs_rate = commissionForm.cs_rate;
    if (commissionForm.tech_rate !== undefined && commissionForm.tech_rate !== null) payload.tech_rate = commissionForm.tech_rate;

    await orderService.setCommissionOverride(order.value.id, payload);
    message.success('ç‰¹æ®Šææˆè®¾ç½®æˆåŠŸ');
    isCommissionModalVisible.value = false;
    await fetchOrder();
  } catch (error: any) {
    message.error(error.response?.data?.msg || 'è®¾ç½®å¤±è´¥');
  }
};
</script>

<style scoped>
.loading-container {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 400px;
}
.content-grid {
  display: grid;
  grid-template-columns: 2fr 1fr; /* ä¸»å†…å®¹åŒº : ä¾§è¾¹æ  */
  gap: 24px;
}
.main-content {
  display: flex;
  flex-direction: column;
  gap: 24px;
}
.sidebar {
  display: flex;
  flex-direction: column;
  gap: 24px;
}
@media (max-width: 992px) {
  .content-grid {
    grid-template-columns: 1fr;
  }
}
</style>


===================================package-lock.json=====
ğŸ“„ æ–‡ä»¶è·¯å¾„: frontend\src\views\orders\OrderListView.vue
========================================

<template>
  <div>
    <a-page-header title="è®¢å•ç®¡ç†">
        <template #extra>
         <a-button type="primary" @click="goToCreateOrder">
           <template #icon><PlusOutlined /></template>
           åˆ›å»ºæ–°è®¢å•
         </a-button>
       </template>
    </a-page-header>

    <div class="content-card">
      <a-table :columns="columns" :data-source="orders" :loading="loading" row-key="id">
        <template #bodyCell="{ column, record }">
          <template v-if="column.key === 'status'">
            <a-tag :color="getStatusColor(record.status)">{{ record.status }}</a-tag>
          </template>

          <template v-if="column.key === 'action'">
            <a-space>
              <router-link :to="{ name: 'order-detail', params: { id: record.id } }">
                <a-button type="link" size="small">è¯¦æƒ…</a-button>
              </router-link>
            </a-space>
          </template>

        </template>
      </a-table>
    </div>
  </div>
</template>

<script setup lang="ts">
// (script éƒ¨åˆ†åŸºæœ¬ä¿æŒä¸å˜, åªéœ€å¯¼å…¥ RouterLink)
import { ref, onMounted } from 'vue'
import { useRouter, RouterLink } from 'vue-router' // å¯¼å…¥ RouterLink
import { message, PageHeader as APageHeader, Button as AButton, Table as ATable, Tag as ATag, Space as ASpace } from 'ant-design-vue'
import { PlusOutlined } from '@ant-design/icons-vue'
import { orderService } from '@/services/orderService'
import { type Order, OrderStatus } from '@/services/types'

// ... (å…¶ä»– script å†…å®¹ä¿æŒä¸å˜)
const router = useRouter()
const orders = ref<Order[]>([])
const loading = ref(true)

const columns = [
  { title: 'ä¸šåŠ¡ID', dataIndex: 'order_uid', key: 'order_uid' },
  { title: 'å®¢æˆ·ä¿¡æ¯', dataIndex: ['customer_info', 'name'], key: 'customer_info', ellipsis: true },
  { title: 'çŠ¶æ€', dataIndex: 'status', key: 'status' },
  { title: 'åˆ›å»ºäºº', dataIndex: ['creator', 'full_name'], key: 'creator' },
  { title: 'è´Ÿè´£äºº', dataIndex: ['developer', 'full_name'], key: 'developer' },
  { title: 'åˆ›å»ºæ—¶é—´', dataIndex: 'created_at', key: 'created_at' },
  { title: 'æ“ä½œ', key: 'action' },
]

const getStatusColor = (status: OrderStatus) => {
  const colorMap: Record<OrderStatus, string> = {
    [OrderStatus.PENDING_ASSIGNMENT]: 'orange',
    [OrderStatus.PENDING_PAYMENT]: 'gold',
    [OrderStatus.PAID]: 'purple',
    [OrderStatus.IN_DEVELOPMENT]: 'processing',
    [OrderStatus.SHIPPED]: 'blue',
    [OrderStatus.RECEIVED]: 'cyan',
    [OrderStatus.PENDING_SETTLEMENT]: 'purple',
    [OrderStatus.VERIFIED]: 'lime',
    [OrderStatus.SETTLED]: 'success',
    [OrderStatus.CANCELLED]: 'default',
  };
  return colorMap[status] || 'default';
}

const fetchOrders = async () => {
  loading.value = true
  try {
    orders.value = await orderService.getOrders()
  } catch (error) {
    message.error('è·å–è®¢å•åˆ—è¡¨å¤±è´¥')
  } finally {
    loading.value = false
  }
}

const goToCreateOrder = () => {
  router.push('/orders/new')
}

onMounted(fetchOrders)
</script>

<style scoped>
.content-card {
  background-color: #fff;
  padding: 24px;
  margin: 0 24px;
}
</style>
